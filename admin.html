<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>DFY CRM - Onboarding Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* CSS Variables for Theming */
        :root {
            /* Light mode colors */
            --color-background: #F5F7FA;
            --color-surface: #FFFFFF;
            --color-primary: #1E3A8A;
            --color-primary-light: #3B82F6;
            --color-text: #1F2937;
            --color-text-secondary: #6B7280;
            --color-border: #E5E7EB;
            --color-hover: rgba(59, 130, 246, 0.05);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            /* Dark mode colors */
            --color-background: #111827;
            --color-surface: #1F2937;
            --color-primary: #3B82F6;
            --color-primary-light: #60A5FA;
            --color-text: #F9FAFB;
            --color-text-secondary: #9CA3AF;
            --color-border: #374151;
            --color-hover: rgba(59, 130, 246, 0.1);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.3);
        }

        /* Apply CSS variables throughout */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-background);
            min-height: 100vh;
            color: var(--color-text);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .header {
            background: var(--color-primary);
            color: #FFFFFF;
            padding: 20px 0;
            margin-bottom: 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .admin-nav {
            display: flex;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 4px;
            gap: 2px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            flex-wrap: nowrap;
            width: 100%;
            max-width: 600px;
        }

        .nav-link {
            position: relative;
            padding: 8px 12px;
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.85);
            text-decoration: none;
            font-weight: 500;
            font-size: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
            min-height: 34px;
            box-sizing: border-box;
            flex: 1;
            justify-content: center;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 6px;
            background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .nav-link:hover::before {
            opacity: 1;
        }

        .nav-link:hover {
            color: #FFFFFF;
            border-color: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .nav-link.active {
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
            color: #FFFFFF;
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            font-weight: 600;
        }

        .nav-link.active::before {
            opacity: 0;
        }

        .nav-icon {
            width: 14px;
            height: 14px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            filter: brightness(0) invert(1);
            opacity: 0.8;
            transition: opacity 0.3s ease;
            flex-shrink: 0;
        }

        .nav-link:hover .nav-icon,
        .nav-link.active .nav-icon {
            opacity: 1;
        }

        .nav-icon.tasks {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01' /%3E%3C/svg%3E");
        }

        .nav-icon.analytics {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z' /%3E%3C/svg%3E");
        }

        .nav-icon.test {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z' /%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 12a3 3 0 11-6 0 3 3 0 016 0z' /%3E%3C/svg%3E");
        }

        .nav-icon.workflow {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z' /%3E%3C/svg%3E");
        }
        .nav-icon.preview {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 12a3 3 0 11-6 0 3 3 0 016 0z' /%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z' /%3E%3C/svg%3E");
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            letter-spacing: -0.025em;
        }

        .page-subheader {
            background: #F3F4F6;
            border-bottom: 1px solid var(--color-border);
            padding: 0;
        }
        
        [data-theme="dark"] .page-subheader {
            background: #374151;
        }

        .subheader-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            min-height: 56px;
        }

        .page-title {
            font-size: 16px;
            font-weight: 600;
            color: #1F2937;
            margin: 0;
            padding: 0;
            line-height: 1;
            display: flex;
            align-items: center;
        }
        
        [data-theme="dark"] .page-title {
            color: #F9FAFB;
        }

        .subheader-controls {
            display: flex;
            gap: 20px;
            align-items: center;
            flex: 1;
            justify-content: flex-end;
        }

        .filter-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .filter-label {
            font-size: 13px;
            color: #6B7280;
            font-weight: 500;
        }
        
        [data-theme="dark"] .filter-label {
            color: #9CA3AF;
        }

        .task-filter {
            background: white;
            border: 1px solid #D1D5DB;
            color: #374151;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            outline: none;
        }
        
        [data-theme="dark"] .task-filter {
            background: #1F2937;
            border-color: #4B5563;
            color: #F3F4F6;
        }

        .task-filter:hover {
            border-color: #9CA3AF;
        }

        .task-filter:focus {
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .task-filter option {
            background: var(--color-surface);
            color: var(--color-text);
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .add-task-btn, .webhook-settings-btn {
            background: #FFFFFF;
            border: 1px solid #D1D5DB;
            color: #374151;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            transition: all 0.2s ease;
            white-space: nowrap;
            line-height: 1;
            margin: 0;
        }

        .add-task-btn:hover, .webhook-settings-btn:hover {
            background: #1E3A8A;
            border-color: #1E3A8A;
            color: #FFFFFF;
        }

        /* Task targeting indicators */
        .task-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            margin-left: 8px;
        }

        .task-indicator.everyone {
            background: #DBEAFE;
            color: #1E40AF;
            border: 1px solid #3B82F6;
        }

        .task-indicator.groups {
            background: #F3E8FF;
            color: #7C3AED;
            border: 1px solid #8B5CF6;
        }

        .task-indicator.locations {
            background: #FEF3C7;
            color: #D97706;
            border: 1px solid #F59E0B;
        }

        .task-indicator.individuals {
            background: #DCFCE7;
            color: #16A34A;
            border: 1px solid #22C55E;
        }

        .task-indicator-icon {
            width: 12px;
            height: 12px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .task-indicator.everyone .task-indicator-icon {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%231E40AF'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z' /%3E%3C/svg%3E");
        }

        .task-indicator.groups .task-indicator-icon {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%237C3AED'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z' /%3E%3C/svg%3E");
        }

        .task-indicator.locations .task-indicator-icon {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23D97706'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z' /%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 11a3 3 0 11-6 0 3 3 0 016 0z' /%3E%3C/svg%3E");
        }

        .task-indicator.individuals .task-indicator-icon {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2316A34A'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z' /%3E%3C/svg%3E");
        }

        .container {
            max-width: 1200px;
            margin: 20px auto 0;
            padding: 0 20px;
            display: flex;
            gap: 30px;
            min-height: calc(100vh - 120px);
        }

        .tasks-panel {
            flex: 1;
            background: var(--color-surface);
            border-radius: 8px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--color-border);
            padding: 24px;
            transition: all 0.3s ease-out;
        }

        .container.editing .tasks-panel {
            flex: 0.4;
        }

        .edit-panel {
            flex: 0;
            background: var(--color-surface);
            border-radius: 8px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--color-border);
            padding: 0;
            transition: all 0.3s ease-out;
            overflow: hidden;
        }

        .container.editing .edit-panel {
            flex: 0.6;
            padding: 24px;
        }

        .webhook-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 500px;
            height: 100vh;
            background: linear-gradient(180deg, #FFFFFF 0%, #F9FAFB 100%);
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
            border-left: 1px solid #E5E7EB;
            padding: 24px;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .environment-info {
            background: #EFF6FF;
            border: 1px solid #BFDBFE;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .environment-info h4 {
            margin: 0 0 8px 0;
            color: #1E40AF;
            font-size: 14px;
        }
        
        .environment-info p {
            margin: 4px 0;
            font-size: 13px;
            color: #374151;
        }
        
        .environment-info code {
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .webhook-content {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .webhook-list h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 16px;
        }

        .webhooks-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .webhook-item {
            background: #FFFFFF;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s ease;
        }

        .webhook-item:hover {
            border-color: #3B82F6;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .webhook-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .webhook-name {
            font-weight: 600;
            color: #1F2937;
        }

        .webhook-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .webhook-status.active {
            background: #D1FAE5;
            color: #065F46;
        }

        .webhook-status.inactive {
            background: #F3F4F6;
            color: #374151;
        }

        .webhook-url {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #6B7280;
            word-break: break-all;
            margin-bottom: 8px;
        }

        .webhook-description {
            color: #6B7280;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .webhook-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-small.btn-edit {
            background: #EFF6FF;
            color: #1E40AF;
        }

        .btn-small.btn-edit:hover {
            background: #DBEAFE;
        }

        .btn-small.btn-test {
            background: #F0FDF4;
            color: #15803D;
        }

        .btn-small.btn-test:hover {
            background: #DCFCE7;
        }

        .webhook-form h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 20px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #3B82F6;
            color: #FFFFFF;
        }

        .btn-primary:hover {
            background: #2563EB;
        }

        .btn-secondary {
            background: #F3F4F6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #E5E7EB;
        }

        .btn-danger {
            background: #EF4444;
            color: #FFF;
        }

        .btn-danger:hover {
            background: #DC2626;
        }

        .btn-test {
            background: #10B981;
            color: #FFFFFF;
        }

        .btn-test:hover {
            background: #059669;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #E5E7EB;
        }

        .panel-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: #1F2937;
        }

        .task-list {
            space-y: 12px;
        }

        .task-item {
            background: #FFFFFF;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .task-item:hover {
            border-color: #3B82F6;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .task-item.active {
            border-color: #3B82F6;
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.05) 0%, rgba(37, 99, 235, 0.05) 100%);
        }

        .task-position {
            background: linear-gradient(90deg, #3B82F6 0%, #2563EB 100%);
            color: #FFFFFF;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            flex-shrink: 0;
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-size: 15px;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 2px;
        }

        .task-description {
            color: #6B7280;
            font-size: 13px;
        }

        .task-actions {
            display: flex;
            gap: 8px;
        }

        .task-toggle {
            width: 36px;
            height: 18px;
            background: #E5E7EB;
            border-radius: 9px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .task-toggle.active {
            background: linear-gradient(90deg, #3B82F6 0%, #2563EB 100%);
        }

        .task-toggle::after {
            content: '';
            width: 14px;
            height: 14px;
            background: #FFFFFF;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: transform 0.2s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .task-toggle.active::after {
            transform: translateX(18px);
        }

        .delete-btn {
            background: #dc3545;
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .delete-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            vertical-align: top;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Toggle Switch Styles */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
            padding: 0;
            margin: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #667eea;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .toggle-label {
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .quill-container {
            margin-bottom: 20px;
        }

        .ql-editor {
            min-height: 200px;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 25px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(90deg, #3B82F6 0%, #2563EB 100%);
            color: #FFFFFF;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .btn-secondary {
            background: #E5E7EB;
            color: #374151;
            border: 1px solid #D1D5DB;
        }

        .btn-secondary:hover {
            background: #D1D5DB;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: #666;
        }

        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        .success {
            background: #efe;
            border: 1px solid #cfc;
            color: #3c3;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        .close-btn {
            background: #6c757d;
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: #545b62;
        }

        /* Targeting Styles */
        .targeting-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .targeting-checkbox:last-child {
            border-bottom: none;
        }

        .targeting-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #3B82F6;
        }

        .targeting-checkbox label {
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            margin: 0;
            flex: 1;
        }

        .location-info {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }

        .filter-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            background: #ffffff;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                gap: 20px;
            }

            .container.editing .tasks-panel,
            .container.editing .edit-panel {
                flex: 1;
            }

            .tasks-panel,
            .edit-panel {
                padding: 20px;
            }

            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .header-content {
                gap: 20px;
            }

            .admin-nav {
                flex-wrap: wrap;
                justify-content: center;
                gap: 1px;
                padding: 3px;
            }

            .nav-link {
                font-size: 12px;
                padding: 8px 12px;
                min-height: 32px;
            }

            .nav-icon {
                width: 14px;
                height: 14px;
            }
        }

        /* Enhanced responsive design for navigation */
        @media (max-width: 768px) {
            .header-content {
                gap: 15px;
                flex-direction: column;
                align-items: stretch;
            }
            
            .admin-nav {
                max-width: none;
                width: 100%;
                order: 2;
            }
            
            .nav-link {
                padding: 10px 8px;
                font-size: 11px;
                gap: 4px;
                min-height: 40px;
            }
            
            .nav-icon {
                width: 12px;
                height: 12px;
            }
            
            .header h1 {
                font-size: 22px;
                text-align: center;
                order: 1;
            }

            .subheader-content {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .page-title {
                text-align: center;
                font-size: 15px;
            }

            .subheader-controls {
                flex-direction: column;
                gap: 12px;
            }

            .filter-controls {
                justify-content: center;
            }

            .action-buttons {
                justify-content: center;
                flex-wrap: wrap;
            }
        }

        @media (max-width: 480px) {
            .nav-link {
                padding: 8px 6px;
                font-size: 10px;
                gap: 3px;
                flex-direction: column;
                text-align: center;
                line-height: 1.2;
            }
            
            .nav-icon {
                width: 14px;
                height: 14px;
                margin-bottom: 2px;
            }
        }

        @media (min-width: 1200px) {
            .admin-nav {
                max-width: 700px;
            }
            
            .nav-link {
                padding: 10px 16px;
                font-size: 13px;
                gap: 8px;
            }
            
            .nav-icon {
                width: 16px;
                height: 16px;
            }
        }

        /* Simple Sequence Styles */
        .sequence-item {
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .sequence-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .sequence-title {
            font-size: 16px;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 4px;
        }

        .sequence-flow {
            color: #6B7280;
            font-size: 14px;
            line-height: 1.5;
        }

        .sequence-actions {
            display: flex;
            gap: 8px;
        }

        .flow-text {
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            padding: 12px;
            margin-top: 8px;
            font-size: 13px;
            color: #4B5563;
        }

        .empty-sequences {
            text-align: center;
            padding: 60px 20px;
            color: #6B7280;
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
        }

        .empty-sequences h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #374151;
        }

        .empty-sequences p {
            margin-bottom: 20px;
        }

        /* Search Bar Styles */
        .search-bar-container {
            position: relative;
            flex: 1;
            max-width: 300px;
            margin-right: 16px;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px 8px 36px;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            background: white;
            color: #374151;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        [data-theme="dark"] .search-input {
            background: #1F2937;
            border-color: #4B5563;
            color: #F3F4F6;
        }

        .search-input::placeholder {
            color: #9CA3AF;
        }

        .search-input:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            color: #9CA3AF;
            pointer-events: none;
        }

        .search-results-info {
            padding: 8px 12px;
            background: #FEF3C7;
            border: 1px solid #FCD34D;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 13px;
            color: #92400E;
            display: none;
        }

        .search-results-info.active {
            display: block;
        }

        .task-card.search-match {
            border-color: #3B82F6;
            background: #EFF6FF;
        }

        .task-card.search-hidden {
            display: none;
        }

        /* Theme Toggle Button */
        .theme-toggle {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        .theme-icon-light,
        .theme-icon-dark {
            width: 20px;
            height: 20px;
            color: white;
        }

        [data-theme="dark"] .theme-toggle {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* Keyboard Shortcut Styles */
        kbd {
            display: inline-block;
            padding: 3px 6px;
            font-size: 11px;
            line-height: 1;
            color: var(--color-text);
            background: var(--color-background);
            border: 1px solid var(--color-border);
            border-radius: 3px;
            box-shadow: inset 0 -1px 0 var(--color-border);
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
        }

        .shortcut-hint {
            margin-left: auto;
            opacity: 0;
            transition: opacity 0.2s ease;
            font-size: 11px;
            color: var(--color-text-secondary);
        }

        .btn:hover .shortcut-hint,
        .nav-link:hover .shortcut-hint {
            opacity: 1;
        }

        /* Responsive Styles - Mobile First */
        @media (max-width: 768px) {
            /* Header adjustments for mobile */
            .header-content {
                flex-direction: column;
                gap: 12px;
            }

            .admin-nav {
                max-width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Subheader controls stack on mobile */
            .subheader-content {
                flex-direction: column;
                height: auto;
                padding: 12px;
            }

            .subheader-controls {
                flex-direction: column;
                gap: 12px;
                width: 100%;
            }

            .search-bar-container {
                max-width: 100%;
                margin-right: 0;
                margin-bottom: 8px;
            }

            .filter-controls {
                width: 100%;
                flex-wrap: wrap;
            }

            .action-buttons {
                width: 100%;
                flex-wrap: wrap;
                gap: 8px;
            }

            .action-buttons button {
                flex: 1;
                min-width: 140px;
            }

            /* Container and panels */
            .container {
                padding: 12px;
                flex-direction: column;
            }

            .tasks-panel,
            .edit-panel {
                width: 100%;
                margin: 0;
                border-radius: 8px;
            }

            .container.editing .tasks-panel {
                display: none;
            }

            .container.editing .edit-panel {
                width: 100%;
            }

            /* Task items mobile optimization */
            .task-item {
                padding: 12px;
                flex-direction: column;
                align-items: flex-start;
            }

            .task-position {
                margin-bottom: 8px;
            }

            .task-content {
                width: 100%;
            }

            .task-title {
                flex-wrap: wrap;
                gap: 8px;
            }

            .task-actions {
                margin-top: 12px;
                width: 100%;
                justify-content: space-between;
            }

            /* Forms on mobile */
            .form-group {
                margin-bottom: 16px;
            }

            .form-group label {
                margin-bottom: 6px;
            }

            /* Modals full screen on mobile */
            .modal-content {
                width: 100%;
                height: 100%;
                border-radius: 0;
                max-height: 100vh;
                margin: 0;
            }

            .modal-header {
                padding: 16px;
            }

            .modal-body {
                padding: 16px;
            }

            /* Buttons full width on mobile */
            .btn-group {
                flex-direction: column;
                gap: 8px;
            }

            .btn-group .btn {
                width: 100%;
            }

            /* Hide less important elements on mobile */
            .hide-mobile {
                display: none !important;
            }
        }

        /* Tablet styles */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                max-width: 100%;
                padding: 20px;
            }

            .container.editing {
                gap: 20px;
            }

            .container.editing .tasks-panel {
                flex: 0.4;
            }

            .container.editing .edit-panel {
                flex: 0.6;
            }
        }

        /* Touch-friendly styles */
        @media (hover: none) and (pointer: coarse) {
            /* Increase touch targets */
            .btn,
            .task-item,
            .nav-link {
                min-height: 44px;
            }

            .btn-icon {
                width: 44px;
                height: 44px;
            }

            /* Always show task actions on touch devices */
            .task-actions {
                opacity: 1;
            }

            /* Remove hover effects on touch devices */
            .task-item:hover {
                transform: none;
            }
        }

        /* Print styles */
        @media print {
            .header,
            .page-subheader,
            .admin-nav,
            .action-buttons,
            .task-actions,
            .btn {
                display: none !important;
            }

            .container {
                max-width: 100%;
                padding: 0;
            }

            .task-item {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1><a href="#" onclick="goBackToTasks()" style="text-decoration: none; color: inherit; cursor: pointer;">DFY CRM Admin Panel</a></h1>
            <div class="admin-nav" id="adminNav">
                <!-- Navigation links will be populated by JavaScript -->
            </div>
            <!-- Dark Mode Toggle -->
            <button id="themeToggle" class="theme-toggle" title="Toggle dark mode (Ctrl+Shift+D)">
                <i data-lucide="sun" class="theme-icon-light"></i>
                <i data-lucide="moon" class="theme-icon-dark" style="display: none;"></i>
            </button>
        </div>
    </div>

    <div class="page-subheader">
        <div class="subheader-content">
            <span class="page-title">Task Management</span>
            <div class="subheader-controls">
                <!-- Search Bar -->
                <div class="search-bar-container">
                    <input type="text" 
                           id="taskSearchInput" 
                           class="search-input" 
                           placeholder="Search tasks by title or description..."
                           onkeyup="searchTasks()">
                    <i data-lucide="search" class="search-icon"></i>
                </div>
                
                <div class="filter-controls">
                    <label for="taskFilter" class="filter-label">Filter:</label>
                    <select id="taskFilter" class="task-filter" onchange="handleFilterChange()">
                        <option value="all">All Tasks</option>
                        <option value="groups">By User Groups</option>
                        <option value="individuals">By Individuals</option>
                    </select>
                    
                    <!-- Task Groups Dropdown (shown when Groups is selected) -->
                    <div id="taskGroupsFilterContainer" style="display: none; margin-left: 10px;">
                        <label for="taskGroupsFilter" class="filter-label">Task Group:</label>
                        <select id="taskGroupsFilter" class="task-filter" onchange="filterTasks()">
                            <option value="">Select task group...</option>
                        </select>
                    </div>
                    
                    <!-- Users Dropdown (shown when Individuals is selected) -->
                    <div id="usersFilterContainer" style="display: none; margin-left: 10px;">
                        <label for="usersFilter" class="filter-label">User:</label>
                        <select id="usersFilter" class="task-filter" onchange="filterTasks()">
                            <option value="">Select user...</option>
                        </select>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="add-task-btn" onclick="addNewTask()">+ Add New Task</button>
                    <button id="taskGroupsToggleBtn" class="add-task-btn" onclick="toggleTaskGroupsPanel()"><i data-lucide="folder" style="width: 16px; height: 16px; margin-right: 6px;"></i>Task Groups</button>
                    <button class="webhook-settings-btn" onclick="openWebhookSettings()"><i data-lucide="settings" style="width: 16px; height: 16px; margin-right: 6px;"></i>Webhook Settings</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="container">
        <div class="tasks-panel" id="tasksPanel">
            <div class="panel-header">
                <h2>Tasks</h2>
            </div>
            <!-- Search Results Info -->
            <div id="searchResultsInfo" class="search-results-info">
                <span id="searchResultsText"></span>
            </div>
            <div id="tasksList" class="task-list">
                <div class="loading">Loading tasks...</div>
            </div>
        </div>

        <!-- Task Groups Panel -->
        <div class="tasks-panel" id="taskGroupsMainPanel" style="display: none;">
            <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h2 id="taskGroupsMainTitle">Task Groups</h2>
                <button class="close-btn" onclick="backToTasksFromGroups()">&times;</button>
            </div>
            
            <!-- Task Groups List View -->
            <div id="taskGroupsMainView">
                <!-- Task Groups Section -->
                <div style="margin-bottom: 40px;">
                    <h3 style="margin-bottom: 15px; color: #1F2937; font-size: 18px;">Task Groups</h3>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <button class="btn btn-primary" onclick="createNewTaskGroupMain()">+ Create Task Group</button>
                        </div>
                    </div>
                    <div id="taskGroupsMainList" class="task-list">
                        <div class="loading">Loading task groups...</div>
                    </div>
                </div>
            </div>
            
            <!-- Sequences View -->
            <div id="sequencesMainView" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <button class="btn btn-secondary" onclick="backToTaskGroupsMain()" style="margin-right: 10px;">← Back to Task Groups</button>
                        <button class="btn btn-primary" onclick="createNewSequenceMain()">+ Add New Sequence</button>
                    </div>
                </div>
                <p style="color: #666; margin-bottom: 20px;">Set up conditional flows: When users complete ALL tasks in one group, automatically show another group.</p>
                <div id="sequencesMainList" class="task-list">
                    <div class="loading">Loading sequences...</div>
                </div>
            </div>
        </div>

        <!-- User Groups Management Panel -->
        <div id="userGroupsMainPanel" class="main-panel" style="display: none;">
            <h2 id="userGroupsMainTitle">User Groups Management</h2>
            
            <div id="userGroupsMainView">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <button class="btn btn-primary" onclick="createNewUserGroupMain()">+ Create User Group</button>
                    </div>
                </div>
                <p style="color: #666; margin-bottom: 20px;">Organize users into groups for targeted task assignment and onboarding flows.</p>
                <div id="userGroupsMainList" class="task-list">
                    <div class="loading">Loading user groups...</div>
                </div>
            </div>
        </div>

        <!-- Task Sequences Panel -->
        <div class="tasks-panel" id="taskSequencesPanel" style="display: none;">
            <div class="panel-header">
                <h2>Task Sequences</h2>
            </div>
            
            <div style="margin-bottom: 20px;">
                <p style="color: #666; margin-bottom: 15px;">
                    Set up conditional task group flows: When users complete all tasks in one group, automatically unlock another group.
                </p>
                <button class="btn btn-primary" onclick="addNewSequence()">+ Add New Sequence</button>
            </div>
            
            <!-- Simple Sequences List -->
            <div id="sequencesList" class="task-list">
                <div class="loading">Loading sequences...</div>
            </div>
        </div>

        <div class="edit-panel" id="editPanel">
            <div class="panel-header">
                <h2 id="editTitle">Edit Task</h2>
                <button class="close-btn" onclick="closeEditPanel()">&times;</button>
            </div>
            
            <form id="taskForm">
                <input type="hidden" id="taskId">

                <!-- Simplified Show Task To Selection -->
                <div class="form-group">
                    <label for="showTaskTo">Assign Task To</label>
                    <select id="showTaskTo" class="filter-select" onchange="updateShowTaskTo()">
                        <option value="usergroup">User Group → Task Group</option>
                        <option value="individual">Individual User (Direct)</option>
                    </select>
                </div>

                <!-- Individual User Selection with Search -->
                <div class="form-group" id="individualUserSection">
                    <label for="individualUserSelect">Select User</label>
                    <input type="text" id="userSearchInput" placeholder="Search by name, email, or company..." 
                           style="width: 100%; padding: 8px 12px; margin-bottom: 8px; border: 1px solid #e5e7eb; border-radius: 6px;"
                           onkeyup="filterUserDropdown()">
                    <select id="individualUserSelect" class="filter-select" size="5" 
                            style="width: 100%; height: 120px; overflow-y: auto;">
                        <!-- Users will be loaded here dynamically -->
                    </select>
                    <small style="color: #6B7280;">Select the user who should complete this task</small>
                </div>

                <!-- User Group Selection -->
                <div class="form-group" id="userGroupSection" style="display: none;">
                    <label for="userGroupSelect">Select User Group <span style="color: red;">*</span></label>
                    <select id="userGroupSelect" class="filter-select" onchange="updateTaskGroupsForUserGroup()" required>
                        <option value="">Select a user group...</option>
                        <!-- User groups will be loaded here dynamically -->
                    </select>
                    <small style="color: #6B7280;">Required: All tasks must be assigned to a user group</small>
                </div>

                <!-- Task Groups for Selected User Group -->
                <div class="form-group" id="taskGroupSection" style="display: none;">
                    <label for="taskGroupSelect">Select Task Group <span style="color: red;">*</span></label>
                    <select id="taskGroupSelect" class="filter-select" required>
                        <option value="">Select a task group...</option>
                        <!-- Task groups will be loaded here dynamically -->
                    </select>
                    <small style="color: #6B7280;">Required: All tasks must belong to a task group</small>
                </div>

                <!-- Due Date (shown for individual tasks) -->
                <div class="form-group" id="dueDateSection">
                    <label for="taskDueDate">Due Date (Optional)</label>
                    <input type="datetime-local" id="taskDueDate" style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px;">
                    <small style="color: #6B7280;">Set a deadline for this task completion</small>
                </div>

                <div class="form-group">
                    <label for="title">Task Title <span style="color: red;">*</span></label>
                    <input type="text" id="title" placeholder="Enter a descriptive task title" required>
                </div>

                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" required></textarea>
                </div>

                <div class="form-group">
                    <label for="instructionTitle">Instruction Title</label>
                    <input type="text" id="instructionTitle" required>
                </div>

                <div class="form-group">
                    <label>Instruction Content (Rich Text Editor)</label>
                    <div class="quill-container">
                        <div id="quillEditor"></div>
                    </div>
                    <small style="color: #6B7280; display: block; margin-top: 5px;">Use the editor above to create detailed instructions with formatting, lists, and images.</small>
                </div>

                <div class="form-group">
                    <label>Video (optional)</label>
                    <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 12px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="useVideoUrl" onchange="toggleVideoMode()" style="width: 18px; height: 18px; margin-right: 8px;">
                            <span style="color: #374151;">Use video URL instead</span>
                        </label>
                    </div>
                    
                    <div id="videoUploadInput">
                        <input type="file" id="videoFile" accept="video/*" onchange="handleVideoFileSelect(event)" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px;">
                        <small style="color: #6B7280; display: block; margin-top: 5px;">
                            Supported formats: MP4, WebM, MOV. Large files may take time to upload.<br>
                            <span style="color: #ef4444;">Note: Supabase free tier limits files to 50MB. For larger videos, use the URL option with YouTube, Vimeo, or other video hosting services.</span>
                        </small>
                        <div id="videoUploadProgress" style="display: none; margin-top: 10px;">
                            <div style="background: #e5e7eb; border-radius: 4px; height: 8px;">
                                <div id="videoProgressBar" style="background: #3b82f6; height: 100%; border-radius: 4px; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <small id="videoProgressText" style="color: #6B7280; margin-top: 5px; display: block;">Uploading...</small>
                        </div>
                    </div>
                    
                    <div id="videoUrlInput" style="display: none;">
                        <input type="url" id="videoUrl" placeholder="https://youtube.com/watch?v=... or https://vimeo.com/..." style="width: 100%;">
                    </div>
                    
                    <!-- Video Completion Requirement -->
                    <div id="videoCompletionOption" style="margin-top: 15px; padding: 12px; background: #F3F4F6; border-radius: 6px;">
                        <label style="display: flex; align-items: flex-start; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="requireVideoCompletion" style="width: 18px; height: 18px; margin-top: 2px;">
                            <div>
                                <span style="font-weight: 500; color: #1F2937;">Require Video Completion</span>
                                <small style="display: block; color: #6B7280; margin-top: 4px;">
                                    When enabled, users must watch at least 95% of the video before they can mark this task as complete. 
                                    Progress is saved automatically.
                                </small>
                            </div>
                        </label>
                        
                        <!-- Video Gating for Next Task -->
                        <label style="display: flex; align-items: flex-start; gap: 8px; cursor: pointer; margin-top: 12px; padding-top: 12px; border-top: 1px solid #E5E7EB;">
                            <input type="checkbox" id="gateNextTaskOnVideo" style="width: 18px; height: 18px; margin-top: 2px;">
                            <div>
                                <span style="font-weight: 500; color: #1F2937;">Gate Next Task Until Video Complete</span>
                                <small style="display: block; color: #6B7280; margin-top: 4px;">
                                    When enabled, users cannot proceed to the next task until they watch at least 95% of this video. 
                                    This creates a hard stop in the onboarding flow.
                                </small>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="hasFormEmbed" onchange="toggleFormEmbed()" style="width: 16px; height: 16px;">
                        <span>Include Embedded Form</span>
                    </label>
                </div>

                <div class="form-group" id="formEmbedGroup" style="display: none;">
                    <label for="formEmbedCode">Form Embed Code</label>
                    <textarea id="formEmbedCode" placeholder="Paste your complete form embed code here (iframe and script tags)..." style="width: 100%; height: 150px; font-family: 'Courier New', monospace; font-size: 13px; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px;"></textarea>
                    <small style="color: #6B7280; display: block; margin-top: 5px;">Paste the complete embed code including iframe and script tags</small>
                </div>



                <div class="btn-group">
                    <button type="submit" class="btn btn-primary" id="saveBtn">Save Task</button>
                    <button type="button" class="btn btn-secondary" onclick="closeTaskModal()">Cancel</button>
                </div>
            </form>

            <div id="messageArea"></div>
        </div>
    </div>

    <!-- Webhook Settings Panel -->
    <div class="webhook-panel" id="webhookPanel" style="display: none;">
        <div class="panel-header">
            <h2>Webhook Settings</h2>
            <button class="close-btn" onclick="closeWebhookPanel()">&times;</button>
        </div>
        
        <div class="webhook-content">
            <div class="webhook-list">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Current Webhooks</h3>
                    <button class="btn btn-primary" onclick="createNewWebhook()">+ Create Webhook</button>
                </div>
                <div id="webhooksList" class="webhooks-list">
                    <div class="loading">Loading webhooks...</div>
                </div>
            </div>
            
            <div class="webhook-form" style="display: none;" id="webhookForm">
                <h3 id="webhookFormTitle">Edit Webhook</h3>
                <form id="webhookEditForm">
                    <input type="hidden" id="webhookId">
                    <!-- Temporarily hidden until database column is added
                    <div class="form-group">
                        <label for="webhookDisplayName">Webhook Name</label>
                        <input type="text" id="webhookDisplayName" placeholder="e.g., Send to CRM, Notify Sales Team">
                        <small>A friendly name to identify this webhook</small>
                    </div>
                    -->
                    <div class="form-group">
                        <label for="webhookAction">Webhook Action/Event</label>
                        <select id="webhookAction" required onchange="handleWebhookActionChange()">
                            <option value="">Select an action that triggers this webhook...</option>
                            <optgroup label="📋 Task Group Actions">
                                <option value="task_completed_in_group">Task completed in specific group</option>
                                <option value="all_tasks_completed_in_group">ALL tasks completed in specific group</option>
                                <option value="task_group_assigned">Task group assigned to user</option>
                                <option value="task_group_started">User starts any task in group</option>
                            </optgroup>
                            <optgroup label="👤 User Actions">
                                <option value="user_profile_completed">User completes profile setup</option>
                                <option value="user_registered">New user registered</option>
                            </optgroup>
                            <optgroup label="👥 User Group Management">
                                <option value="user_added_to_group">User added to user group</option>
                                <option value="user_removed_from_group">User removed from user group</option>
                            </optgroup>
                            <optgroup label="🔄 Flow Actions">
                                <option value="flow_rule_triggered">Flow rule condition met</option>
                                <option value="task_group_unlocked">Task group unlocked for user</option>
                            </optgroup>
                        </select>
                        <!-- Task Group Selection for group-specific webhooks -->
                        <div id="taskGroupSelection" style="display: none; margin-top: 10px;">
                            <label for="webhookTaskGroup">Select Task Group:</label>
                            <select id="webhookTaskGroup">
                                <option value="">Choose a task group...</option>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        <small>Choose the specific action that will trigger this webhook</small>
                    </div>
                    <div class="form-group">
                        <label for="webhookUrl">Webhook URL</label>
                        <input type="url" id="webhookUrl" required>
                        <small>The endpoint URL that will receive webhook data</small>
                    </div>
                    <div class="form-group">
                        <label for="webhookDescription">Description</label>
                        <textarea id="webhookDescription"></textarea>
                        <small>Description of what this webhook does</small>
                    </div>
                    <div class="form-group">
                        <label for="firingRulesSelect">Applies To</label>
                        <select id="firingRulesSelect" onchange="handleFiringRulesChange()" multiple style="height: 120px; width: 100%;" required>
                            <!-- Groups will be populated here -->
                        </select>
                        <small>Hold Ctrl (Cmd on Mac) to select multiple groups (Required)</small>
                    </div>
                    <div class="form-group">
                        <label for="webhookActive">Status</label>
                        <div class="toggle-container">
                            <label class="toggle-switch">
                                <input type="checkbox" id="webhookActive">
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label">Active</span>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save Webhook</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelWebhookEdit()">Cancel</button>
                        <button type="button" class="btn btn-test" onclick="testWebhookEndpoint()">Test Webhook</button>
                        <button type="button" class="btn btn-danger" onclick="deleteWebhook()" id="deleteWebhookBtn" style="margin-left: auto;">Delete Webhook</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Task Groups Management Panel -->
    <div class="webhook-panel" id="taskGroupsPanel" style="display: none;">
        <div class="panel-header">
            <h2>Task Groups Management</h2>
            <button class="close-btn" onclick="closeTaskGroupsPanel()">&times;</button>
        </div>
        
        <div class="webhook-content">
            <div class="webhook-list">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Task Groups</h3>
                    <div>
                        <button class="btn btn-secondary" onclick="manageSequences()" style="margin-right: 10px;">🔄 Sequences</button>
                        <button class="btn btn-primary" onclick="createNewTaskGroup()">+ Create Task Group</button>
                    </div>
                </div>
                <div id="taskGroupsList" class="webhooks-list">
                    <div class="loading">Loading task groups...</div>
                </div>
            </div>
            
            <div class="webhook-form" style="display: none;" id="taskGroupForm">
                <h3 id="taskGroupFormTitle">Edit Task Group</h3>
                <form id="taskGroupEditForm">
                    <input type="hidden" id="taskGroupId">
                    <div class="form-group">
                        <label for="taskGroupUserGroupSelect">User Group <span style="color: red;">*</span></label>
                        <select id="taskGroupUserGroupSelect" class="filter-select" required>
                            <option value="">Select a user group...</option>
                            <!-- User groups will be loaded here dynamically -->
                        </select>
                        <small style="color: #ef4444;">Required: Task groups must belong to a user group</small>
                    </div>
                    <div class="form-group">
                        <label for="taskGroupName">Task Group Name <span style="color: red;">*</span></label>
                        <input type="text" id="taskGroupName" required>
                        <small>Name for this task group (e.g., "Onboarding Tasks", "Advanced Training")</small>
                    </div>
                    <div class="form-group">
                        <label for="taskGroupDescription">Description</label>
                        <textarea id="taskGroupDescription"></textarea>
                        <small>Description of what this task group contains</small>
                    </div>
                    <div class="form-group">
                        <label for="taskGroupOrder">Display Order</label>
                        <input type="number" id="taskGroupOrder" min="0" step="1" value="0">
                        <small>Order in which this group should appear (0 = first)</small>
                    </div>
                    <div class="form-group">
                        <label for="taskGroupActive">Status</label>
                        <div class="toggle-container">
                            <label class="toggle-switch">
                                <input type="checkbox" id="taskGroupActive">
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label">Active</span>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save Task Group</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelTaskGroupEdit()">Cancel</button>
                        <button type="button" class="btn btn-danger" onclick="deleteTaskGroup()" id="deleteTaskGroupBtn" style="display: none;">Delete</button>
                    </div>
                </form>
            </div>
            
            <!-- Task Assignment Section -->
            <div class="webhook-form" style="display: none;" id="taskAssignmentForm">
                <h3>Assign Tasks to Group: <span id="assignmentGroupName"></span></h3>
                <div class="form-group">
                    <label>Available Tasks</label>
                    <div id="availableTasksList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
                        <div class="loading">Loading tasks...</div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-primary" onclick="saveTaskAssignments()">Save Assignments</button>
                    <button type="button" class="btn btn-secondary" onclick="cancelTaskAssignment()">Cancel</button>
                </div>
            </div>
            
            <!-- Sequences Management Section -->
            <div class="webhook-form" style="display: none;" id="sequencesForm">
                <h3>Task Group Sequences</h3>
                <p style="color: #666; margin-bottom: 20px;">Set up conditional flows: When users complete ALL tasks in one group, automatically show another group.</p>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="createNewSequence()">+ Add New Sequence</button>
                </div>
                
                <div id="sequencesList">
                    <div class="loading">Loading sequences...</div>
                </div>
                
                <div class="form-actions" style="margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="backToTaskGroups()">← Back to Task Groups</button>
                </div>
            </div>
            
            <!-- Sequence Edit Form -->
            <div class="webhook-form" style="display: none;" id="sequenceEditForm">
                <h3 id="sequenceFormTitle">Create New Sequence</h3>
                <form id="sequenceForm">
                    <input type="hidden" id="sequenceId">
                    <div class="form-group">
                        <label for="sequenceName">Sequence Name</label>
                        <input type="text" id="sequenceName" required>
                        <small>Name for this sequence rule (e.g., "Basic to Advanced Onboarding")</small>
                    </div>
                    <div class="form-group">
                        <label for="sequenceDescription">Description</label>
                        <textarea id="sequenceDescription"></textarea>
                        <small>Description of what this sequence does</small>
                    </div>
                    <div class="form-group">
                        <label for="prerequisiteGroup">Prerequisite Group</label>
                        <select id="prerequisiteGroup" required>
                            <option value="">Select group that must be completed first...</option>
                        </select>
                        <small>When ALL tasks in this group are completed...</small>
                    </div>
                    <div class="form-group">
                        <label for="unlockGroup">Unlock Group</label>
                        <select id="unlockGroup" required>
                            <option value="">Select group to unlock...</option>
                        </select>
                        <small>...this group will be shown to the user</small>
                    </div>
                    <div class="form-group">
                        <label for="sequenceAppliesTo">Applies To</label>
                        <select id="sequenceAppliesTo" multiple style="height: 120px;" onchange="handleSequenceAppliesToChange()" required>
                            <!-- User groups will be populated here -->
                        </select>
                        <small>Hold Ctrl (Cmd on Mac) to select multiple user groups (Required)</small>
                    </div>
                    <div class="form-group">
                        <label for="sequenceActive">Status</label>
                        <div class="toggle-container">
                            <label class="toggle-switch">
                                <input type="checkbox" id="sequenceActive">
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label">Active</span>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save Sequence</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelSequenceEdit()">Cancel</button>
                        <button type="button" class="btn btn-danger" onclick="deleteSequence()" id="deleteSequenceBtn" style="display: none;">Delete</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Task Ordering Modal -->
    <div id="taskOrderingModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; border-radius: 12px; width: 90%; max-width: 800px; max-height: 85vh; overflow-y: auto; position: relative; margin: 20px;">
            <div class="panel-header" style="position: sticky; top: 0; background: white; z-index: 10; border-bottom: 1px solid #e5e7eb; padding: 20px 24px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <h2 id="taskOrderingTitle" style="margin: 0; font-size: 20px; font-weight: 600; color: #111827;">Arrange Task Order</h2>
                <button class="close-btn" onclick="closeTaskOrderingModal()" style="position: relative; top: 0; right: 0; width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>
            <div style="padding: 24px 24px 24px 24px;">
                <p style="color: #6b7280; margin-bottom: 20px;">Drag tasks to reorder them within the group. Your new task has been added at the end.</p>
                <div id="taskOrderingList" style="min-height: 200px;">
                    <!-- Tasks will be populated here -->
                </div>
                <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="closeTaskOrderingModal()">Skip</button>
                    <button class="btn btn-primary" onclick="saveTaskOrder()">Save Order</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Theme Management
        const THEME_KEY = 'admin-theme-preference';
        
        // Initialize theme
        function initTheme() {
            const savedTheme = localStorage.getItem(THEME_KEY) || 'light';
            setTheme(savedTheme);
            
            // Set up theme toggle button
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }
            
            // Set up keyboard shortcut (Ctrl/Cmd + Shift + D)
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'D') {
                    e.preventDefault();
                    toggleTheme();
                }
            });
            
            // Listen for system theme changes
            if (window.matchMedia) {
                const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                mediaQuery.addEventListener('change', (e) => {
                    if (!localStorage.getItem(THEME_KEY)) {
                        setTheme(e.matches ? 'dark' : 'light');
                    }
                });
            }
        }
        
        // Set theme
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem(THEME_KEY, theme);
            updateThemeIcon(theme);
            
            // Update meta theme-color
            const metaThemeColor = document.querySelector('meta[name="theme-color"]');
            if (!metaThemeColor) {
                const meta = document.createElement('meta');
                meta.name = 'theme-color';
                meta.content = theme === 'dark' ? '#111827' : '#1E3A8A';
                document.head.appendChild(meta);
            } else {
                metaThemeColor.content = theme === 'dark' ? '#111827' : '#1E3A8A';
            }
        }
        
        // Toggle theme
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        }
        
        // Update theme icon
        function updateThemeIcon(theme) {
            const lightIcon = document.querySelector('.theme-icon-light');
            const darkIcon = document.querySelector('.theme-icon-dark');
            
            if (lightIcon && darkIcon) {
                if (theme === 'dark') {
                    lightIcon.style.display = 'none';
                    darkIcon.style.display = 'block';
                } else {
                    lightIcon.style.display = 'block';
                    darkIcon.style.display = 'none';
                }
            }
        }
        
        // Initialize theme on page load
        document.addEventListener('DOMContentLoaded', initTheme);

        // Keyboard Shortcuts Management
        const shortcuts = {
            'Escape': () => closeAllModals(),
            'n': (e) => { if (e.ctrlKey || e.metaKey) { e.preventDefault(); addNewTask(); } },
            't': (e) => { if (e.ctrlKey || e.metaKey) { e.preventDefault(); toggleTaskGroupsPanel(); } },
            's': (e) => { if (e.ctrlKey || e.metaKey) { e.preventDefault(); saveCurrentTask(); } },
            '/': (e) => { 
                if (!e.ctrlKey && !e.metaKey && !e.shiftKey) {
                    e.preventDefault(); 
                    const searchInput = document.getElementById('taskSearchInput');
                    if (searchInput) searchInput.focus();
                }
            },
            'ArrowUp': (e) => { if (e.altKey) navigateTask('prev'); },
            'ArrowDown': (e) => { if (e.altKey) navigateTask('next'); },
            'Delete': (e) => { if (e.altKey && currentTask) deleteTask(currentTask.id); },
            '1': (e) => { if (e.altKey) navigateToSection('tasks'); },
            '2': (e) => { if (e.altKey) navigateToSection('users'); },
            '3': (e) => { if (e.altKey) navigateToSection('workflows'); },
            '?': (e) => { if (e.shiftKey) showKeyboardShortcuts(); }
        };

        // Initialize keyboard shortcuts
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Don't trigger shortcuts when typing in inputs
                const activeElement = document.activeElement;
                const isTyping = activeElement && (
                    activeElement.tagName === 'INPUT' ||
                    activeElement.tagName === 'TEXTAREA' ||
                    activeElement.contentEditable === 'true'
                );
                
                // Allow Escape key even when typing
                if (e.key !== 'Escape' && isTyping) return;
                
                // Check if shortcut exists and execute
                const shortcut = shortcuts[e.key];
                if (shortcut) {
                    shortcut(e);
                }
            });
        }

        // Navigate between tasks
        function navigateTask(direction) {
            const taskItems = Array.from(document.querySelectorAll('.task-item'));
            if (taskItems.length === 0) return;
            
            const currentIndex = taskItems.findIndex(item => item.classList.contains('active'));
            let nextIndex;
            
            if (direction === 'next') {
                nextIndex = currentIndex < taskItems.length - 1 ? currentIndex + 1 : 0;
            } else {
                nextIndex = currentIndex > 0 ? currentIndex - 1 : taskItems.length - 1;
            }
            
            if (taskItems[nextIndex]) {
                taskItems[nextIndex].click();
            }
        }

        // Navigate to different sections
        function navigateToSection(section) {
            const sectionMap = {
                'tasks': 0,
                'users': 1,
                'workflows': 2,
                'templates': 3,
                'analytics': 4
            };
            
            const navLinks = document.querySelectorAll('.nav-link');
            const index = sectionMap[section];
            if (navLinks[index]) {
                navLinks[index].click();
            }
        }

        // Close all modals
        function closeAllModals() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => modal.style.display = 'none');
            
            // Close edit panel if open
            if (isEditing) {
                cancelEdit();
            }
        }

        // Save current task (when in edit mode)
        function saveCurrentTask() {
            if (isEditing && currentTask) {
                saveTask();
            }
        }

        // Show keyboard shortcuts help
        function showKeyboardShortcuts() {
            const helpContent = `
                <div style="padding: 20px;">
                    <h3 style="margin-bottom: 16px; color: var(--color-text);">Keyboard Shortcuts</h3>
                    <div style="display: grid; gap: 12px;">
                        <div><kbd>Ctrl/Cmd + N</kbd> - Add new task</div>
                        <div><kbd>Ctrl/Cmd + S</kbd> - Save current task</div>
                        <div><kbd>Ctrl/Cmd + T</kbd> - Toggle task groups</div>
                        <div><kbd>Ctrl/Cmd + Shift + D</kbd> - Toggle dark mode</div>
                        <div><kbd>/</kbd> - Focus search</div>
                        <div><kbd>Alt + ↑/↓</kbd> - Navigate tasks</div>
                        <div><kbd>Alt + Delete</kbd> - Delete current task</div>
                        <div><kbd>Alt + 1-5</kbd> - Navigate sections</div>
                        <div><kbd>Escape</kbd> - Close modals/panels</div>
                        <div><kbd>?</kbd> - Show this help</div>
                    </div>
                </div>
            `;
            
            // Create and show help modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2>Keyboard Shortcuts</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${helpContent}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Initialize shortcuts on page load
        document.addEventListener('DOMContentLoaded', initKeyboardShortcuts);

        // URL Management for HighLevel
        function getCleanUrl(page) {
            // Remove .html extension and handle special cases
            const cleanPage = page.replace('.html', '').split('?')[0];
            
            // Get base URL - detect if we're on a subdomain or custom domain
            const protocol = window.location.protocol;
            const host = window.location.host;
            const pathname = window.location.pathname;
            
            // Check if we're in a subfolder or root
            const pathParts = pathname.split('/').filter(p => p);
            const isInSubfolder = pathParts.length > 1 || (pathParts.length === 1 && !pathParts[0].includes('.'));
            
            let baseUrl = `${protocol}//${host}`;
            
            // If we're in a subfolder, maintain that structure
            if (isInSubfolder && pathParts.length > 0) {
                // Remove the filename if present
                const folderParts = pathParts.filter(p => !p.includes('.'));
                if (folderParts.length > 0 && !['admin', 'analytics', 'onboarding'].includes(folderParts[folderParts.length - 1])) {
                    baseUrl += '/' + folderParts.join('/');
                }
            }
            
            // Handle special pages
            if (cleanPage === 'admin' || cleanPage === '') {
                return baseUrl + '/admin';
            }
            
            return baseUrl + '/' + cleanPage;
        }
        
        // Navigate to a page using clean URLs
        function navigateToPage(page) {
            const url = getCleanUrl(page);
            window.location.href = url;
        }

        // Global variables - declared once
        const SUPABASE_URL = 'https://vvtzalcisnpibnlunqgn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2dHphbGNpc25waWJubHVucWduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NTk4MzMsImV4cCI6MjA3MTUzNTgzM30.LJqY5AjAuwH5k65XY9cxfuqiuNNtjYo5k210IAg0PCk';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let tasks = [];
        let currentTask = null;
        let isEditing = false;
        let quillEditor = null;
        let allGroups = [];
        let allLocations = [];
        let allUsers = [];

        // Toggle form embed visibility
        function toggleFormEmbed() {
            const checkbox = document.getElementById('hasFormEmbed');
            const formGroup = document.getElementById('formEmbedGroup');
            formGroup.style.display = checkbox.checked ? 'block' : 'none';
        }
        
        // Toggle between video URL and upload
        function toggleVideoMode() {
            const useUrl = document.getElementById('useVideoUrl').checked;
            const urlInput = document.getElementById('videoUrlInput');
            const uploadInput = document.getElementById('videoUploadInput');
            
            if (useUrl) {
                // Switch to URL mode
                urlInput.style.display = 'block';
                uploadInput.style.display = 'none';
                // Clear upload input and preview if switching to URL
                document.getElementById('videoFile').value = '';
                const preview = uploadInput.querySelector('.video-preview-container');
                if (preview) preview.remove();
                selectedVideoFile = null;
                uploadedVideoUrl = null;
                uploadedVideoPath = null;
            } else {
                // Switch to upload mode
                urlInput.style.display = 'none';
                uploadInput.style.display = 'block';
                // Clear URL input if switching to upload
                document.getElementById('videoUrl').value = '';
                // Remove URL preview if exists
                const urlPreview = urlInput.querySelector('.video-preview-container');
                if (urlPreview) urlPreview.remove();
            }
        }
        
        // Handle video file selection
        let selectedVideoFile = null;
        let uploadedVideoUrl = null;
        let uploadedVideoPath = null;
        
        async function handleVideoFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                selectedVideoFile = null;
                return;
            }
            
            // No file size limit - allow unlimited video sizes
            // Note: Supabase may have its own limits, but we'll let it handle that
            console.log('Video file size:', (file.size / 1024 / 1024).toFixed(2) + 'MB');
            
            // Validate file type
            const allowedTypes = ['video/mp4', 'video/webm', 'video/quicktime'];
            if (!allowedTypes.includes(file.type)) {
                showError('Invalid video format. Please upload MP4, WebM, or MOV files.');
                event.target.value = '';
                return;
            }
            
            selectedVideoFile = file;
            console.log('Video file selected:', file.name, 'Size:', (file.size / 1024 / 1024).toFixed(2) + 'MB');
            
            // Immediately upload the video
            const uploadResult = await uploadVideoToStorage(file);
            if (uploadResult) {
                uploadedVideoUrl = uploadResult.url;
                uploadedVideoPath = uploadResult.path;
                console.log('Video uploaded successfully:', uploadedVideoUrl);
            } else {
                // Reset if upload failed
                selectedVideoFile = null;
                uploadedVideoUrl = null;
                uploadedVideoPath = null;
                event.target.value = '';
            }
        }
        
        // Upload video to Supabase storage
        async function uploadVideoToStorage(file) {
            if (!file) return null;
            
            try {
                // Show progress
                const progressDiv = document.getElementById('videoUploadProgress');
                const progressBar = document.getElementById('videoProgressBar');
                const progressText = document.getElementById('videoProgressText');
                
                progressDiv.style.display = 'block';
                progressBar.style.width = '0%';
                const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
                progressText.textContent = `Uploading video (${fileSizeMB} MB)...`;
                
                // Generate unique filename
                const timestamp = Date.now();
                const randomString = Math.random().toString(36).substring(7);
                const fileExt = file.name.split('.').pop();
                const fileName = `task-video-${timestamp}-${randomString}.${fileExt}`;
                const filePath = `videos/${fileName}`;
                
                // For large files, simulate progress (since Supabase doesn't provide real progress)
                let progressInterval;
                if (file.size > 10 * 1024 * 1024) { // If file is larger than 10MB
                    let simulatedProgress = 0;
                    progressInterval = setInterval(() => {
                        if (simulatedProgress < 90) {
                            simulatedProgress += Math.random() * 10;
                            simulatedProgress = Math.min(simulatedProgress, 90);
                            progressBar.style.width = simulatedProgress + '%';
                        }
                    }, 500);
                }
                
                // Upload to Supabase storage
                const { data, error } = await supabaseClient.storage
                    .from('task-videos')
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: false
                    });
                
                // Clear the progress interval
                if (progressInterval) {
                    clearInterval(progressInterval);
                }
                
                if (error) {
                    console.error('Storage upload error:', error);
                    console.error('Error details:', {
                        message: error.message,
                        statusCode: error.statusCode,
                        error: error.error,
                        details: error
                    });
                    
                    // Check various error conditions
                    if (error.message?.includes('bucket') || error.statusCode === 404) {
                        showError('Video storage is not configured. Please create a "task-videos" bucket in Supabase Storage.');
                    } else if (error.statusCode === 413 || error.message?.includes('PayloadTooLargeError') || error.message?.includes('too large') || error.message?.includes('File size exceeded')) {
                        showError(`File is too large for your current Supabase plan. 

Solutions:
1. Use the "Use video URL instead" option and upload to YouTube, Vimeo, or Google Drive
2. Upgrade your Supabase plan (Pro plan allows up to 5GB files)
3. Compress the video before uploading

Current Supabase limits:
- Free tier: 50MB max per file
- Pro tier: 5GB max per file`);
                    } else if (error.statusCode === 400) {
                        showError('Upload failed. Please check storage bucket permissions. The bucket should be PUBLIC or have proper RLS policies.');
                    } else if (error.statusCode === 401) {
                        showError('Authentication error. Please check your Supabase configuration.');
                    } else {
                        showError('Failed to upload video: ' + (error.message || 'Unknown error'));
                    }
                    progressDiv.style.display = 'none';
                    return null;
                }
                
                // Update progress to 100% when complete
                progressBar.style.width = '100%';
                progressText.textContent = 'Processing...';
                
                // Get public URL
                const { data: urlData } = supabaseClient.storage
                    .from('task-videos')
                    .getPublicUrl(filePath);
                
                progressText.textContent = 'Upload complete!';
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                }, 2000);
                
                // Show video preview after successful upload
                const uploadInput = document.getElementById('videoUploadInput');
                if (uploadInput && urlData.publicUrl) {
                    // Remove any existing preview
                    const existingPreview = uploadInput.querySelector('.video-preview-container');
                    if (existingPreview) {
                        existingPreview.remove();
                    }
                    
                    // Create new preview
                    const previewContainer = document.createElement('div');
                    previewContainer.className = 'video-preview-container';
                    previewContainer.style.cssText = 'margin-top: 15px; padding: 15px; background: #f0fdf4; border-radius: 8px; border: 1px solid #86efac;';
                    previewContainer.innerHTML = `
                        <div style="font-weight: 600; color: #166534; margin-bottom: 10px;">
                            <i data-lucide="check-circle" style="width: 16px; height: 16px; display: inline-block; margin-right: 6px; color: #22c55e;"></i>
                            Video Ready
                        </div>
                        <video controls style="width: 100%; max-width: 400px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <source src="${urlData.publicUrl}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                        <div style="margin-top: 10px; color: #166534; font-size: 14px;">
                            This video will be attached to the task when you save.
                        </div>
                    `;
                    uploadInput.appendChild(previewContainer);
                    
                    // Initialize lucide icons
                    setTimeout(() => lucide.createIcons(), 100);
                }
                
                return {
                    url: urlData.publicUrl,
                    path: filePath
                };
            } catch (error) {
                console.error('Error uploading video:', error);
                showError('Failed to upload video: ' + error.message);
                document.getElementById('videoUploadProgress').style.display = 'none';
                return null;
            }
        }

        // Update Show Task To selection
        function updateShowTaskTo() {
            console.log('updateShowTaskTo called');
            const showTaskTo = document.getElementById('showTaskTo');
            if (!showTaskTo) {
                console.error('showTaskTo element not found');
                return;
            }
            
            const showTaskToValue = showTaskTo.value;
            console.log('Show task to value:', showTaskToValue);
            
            const individualSection = document.getElementById('individualUserSection');
            const userGroupSection = document.getElementById('userGroupSection');
            const taskGroupSection = document.getElementById('taskGroupSection');
            const dueDateSection = document.getElementById('dueDateSection');
            
            if (!individualSection || !userGroupSection) {
                console.error('Required sections not found');
                return;
            }
            
            if (showTaskToValue === 'individual') {
                console.log('Showing individual user selection');
                // Show individual user selection
                individualSection.style.display = 'block';
                userGroupSection.style.display = 'none';
                taskGroupSection.style.display = 'none';
                dueDateSection.style.display = 'block';
                
                // Set required attributes
                document.getElementById('individualUserSelect').setAttribute('required', 'required');
                document.getElementById('userGroupSelect').removeAttribute('required');
                
                // Load users if not already loaded
                loadIndividualUsers();
            } else if (showTaskToValue === 'usergroup') {
                console.log('Showing user group selection');
                // Show user group selection
                individualSection.style.display = 'none';
                userGroupSection.style.display = 'block';
                // Task group section will be shown dynamically when user group is selected
                taskGroupSection.style.display = 'none';
                dueDateSection.style.display = 'none';
                
                // Set required attributes
                document.getElementById('userGroupSelect').setAttribute('required', 'required');
                document.getElementById('individualUserSelect').removeAttribute('required');
                
                // Load user groups
                loadUserGroupsForDropdown();
            }
        }
        
        // Task Ordering Modal Functions
        let currentOrderingGroupId = null;
        let currentNewTaskId = null;
        
        async function showTaskOrderingModal(groupId, newTaskId) {
            currentOrderingGroupId = groupId;
            currentNewTaskId = newTaskId;
            
            console.log('Opening task ordering modal for group:', groupId, 'new task:', newTaskId);
            
            try {
                // Load all tasks in this group - ensure we're using the right data type
                const groupIdInt = parseInt(groupId);
                console.log('Loading tasks for group ID (parsed):', groupIdInt);
                
                const { data: groupTasks, error } = await supabaseClient
                    .from('onboarding_tasks')
                    .select('*')
                    .eq('task_group_id', groupIdInt)
                    .order('position', { ascending: true });
                
                if (error) throw error;
                
                console.log('Tasks loaded for ordering:', groupTasks?.length || 0, 'tasks');
                
                // Get the task group name
                const taskGroup = allTaskGroupsData.find(g => g.id === parseInt(groupId));
                const groupName = taskGroup ? taskGroup.group_name : 'Task Group';
                
                document.getElementById('taskOrderingTitle').textContent = `Arrange Tasks in "${groupName}"`;
                
                // Render the tasks list
                const listContainer = document.getElementById('taskOrderingList');
                listContainer.innerHTML = '';
                
                if (groupTasks && groupTasks.length > 0) {
                    const sortableList = document.createElement('div');
                    sortableList.className = 'sortable-list';
                    sortableList.style.cssText = 'display: flex; flex-direction: column; gap: 0; padding: 8px 0;';
                    
                    groupTasks.forEach((task, index) => {
                        const taskItem = document.createElement('div');
                        taskItem.className = 'task-order-item';
                        taskItem.dataset.taskId = task.id;
                        taskItem.draggable = true;
                        
                        // Highlight the new task
                        const isNewTask = task.id === newTaskId;
                        
                        taskItem.style.cssText = `
                            padding: 14px 16px;
                            background: ${isNewTask ? '#fef3c7' : '#ffffff'};
                            border: 2px solid ${isNewTask ? '#fbbf24' : '#e5e7eb'};
                            border-radius: 8px;
                            cursor: move;
                            display: flex;
                            align-items: center;
                            gap: 12px;
                            transition: all 0.2s;
                            margin-bottom: 8px;
                            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
                        `;
                        
                        taskItem.innerHTML = `
                            <span style="color: #6b7280; user-select: none;">⋮⋮</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #374151;">
                                    ${task.title || task.task_title || 'Untitled Task'}
                                    ${isNewTask ? '<span style="background: #fbbf24; color: #78350f; font-size: 12px; padding: 2px 8px; border-radius: 4px; margin-left: 8px;">NEW</span>' : ''}
                                </div>
                                ${task.description ? `<div style="font-size: 14px; color: #6b7280; margin-top: 4px;">${task.description}</div>` : ''}
                                <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">ID: ${task.task_id || task.id}</div>
                            </div>
                            <span style="color: #9ca3af; font-size: 14px;">Position ${index + 1}</span>
                        `;
                        
                        // Add drag event listeners
                        taskItem.addEventListener('dragstart', handleDragStart);
                        taskItem.addEventListener('dragover', handleDragOver);
                        taskItem.addEventListener('drop', handleDrop);
                        taskItem.addEventListener('dragend', handleDragEnd);
                        taskItem.addEventListener('dragenter', handleDragEnter);
                        taskItem.addEventListener('dragleave', handleDragLeave);
                        
                        sortableList.appendChild(taskItem);
                    });
                    
                    listContainer.appendChild(sortableList);
                } else {
                    listContainer.innerHTML = '<p style="color: #6b7280; text-align: center;">No tasks in this group yet.</p>';
                }
                
                // Show the modal
                document.getElementById('taskOrderingModal').style.display = 'flex';
                
            } catch (error) {
                console.error('Error loading tasks for ordering:', error);
                showError('Failed to load tasks for ordering');
            }
        }
        
        // Drag and drop handlers
        let draggedElement = null;
        
        function handleDragStart(e) {
            draggedElement = e.target;
            e.target.style.opacity = '0.4';
            e.dataTransfer.effectAllowed = 'move';
        }
        
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        function handleDragEnter(e) {
            if (e.target.classList.contains('task-order-item')) {
                e.target.style.borderColor = '#3b82f6';
                e.target.style.backgroundColor = '#eff6ff';
            }
        }
        
        function handleDragLeave(e) {
            if (e.target.classList.contains('task-order-item')) {
                const isNewTask = e.target.dataset.taskId === String(currentNewTaskId);
                e.target.style.borderColor = isNewTask ? '#fbbf24' : '#e5e7eb';
                e.target.style.backgroundColor = isNewTask ? '#fef3c7' : '#ffffff';
            }
        }
        
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedElement !== e.target && e.target.classList.contains('task-order-item')) {
                const container = e.target.parentNode;
                const allItems = Array.from(container.children);
                const draggedIndex = allItems.indexOf(draggedElement);
                const targetIndex = allItems.indexOf(e.target);
                
                if (draggedIndex < targetIndex) {
                    container.insertBefore(draggedElement, e.target.nextSibling);
                } else {
                    container.insertBefore(draggedElement, e.target);
                }
            }
            
            return false;
        }
        
        function handleDragEnd(e) {
            e.target.style.opacity = '1';
            
            // Reset all items' styles
            document.querySelectorAll('.task-order-item').forEach(item => {
                const isNewTask = item.dataset.taskId === String(currentNewTaskId);
                item.style.borderColor = isNewTask ? '#fbbf24' : '#e5e7eb';
                item.style.backgroundColor = isNewTask ? '#fef3c7' : '#ffffff';
            });
            
            // Update position numbers
            document.querySelectorAll('.task-order-item').forEach((item, index) => {
                const positionSpan = item.querySelector('span:last-child');
                if (positionSpan) {
                    positionSpan.textContent = `Position ${index + 1}`;
                }
            });
        }
        
        async function saveTaskOrder() {
            try {
                const items = document.querySelectorAll('.task-order-item');
                
                if (!items || items.length === 0) {
                    console.log('No items to reorder');
                    closeTaskOrderingModal();
                    return;
                }
                
                const updates = [];
                
                items.forEach((item, index) => {
                    const taskId = item.dataset.taskId; // Don't parse as int - it's a UUID
                    console.log('Processing task item:', {
                        element: item,
                        datasetTaskId: item.dataset.taskId,
                        position: index + 1
                    });
                    
                    if (taskId && taskId !== 'undefined' && taskId !== 'null') {
                        updates.push({
                            id: taskId,
                            position: index + 1
                        });
                    } else {
                        console.warn('Invalid task ID found, skipping:', item.dataset.taskId);
                    }
                });
                
                console.log('Updating task positions:', updates);
                
                if (updates.length === 0) {
                    console.log('No valid tasks to update');
                    closeTaskOrderingModal();
                    return;
                }
                
                // Check if we're authenticated
                const { data: sessionData, error: sessionError } = await supabaseClient.auth.getSession();
                console.log('Auth session:', sessionData?.session ? 'Authenticated' : 'Not authenticated');
                
                // Update all positions in database with proper error handling
                let hasErrors = false;
                for (const update of updates) {
                    console.log(`Updating task ${update.id} to position ${update.position}`);
                    
                    const { data, error } = await supabaseClient
                        .from('onboarding_tasks')
                        .update({ position: update.position })
                        .eq('id', update.id)
                        .select();
                    
                    if (error) {
                        console.error('Error updating task position:', {
                            taskId: update.id,
                            position: update.position,
                            error: error,
                            message: error.message,
                            details: error.details,
                            hint: error.hint,
                            code: error.code,
                            statusCode: error.statusCode
                        });
                        
                        // Provide helpful error message based on error type
                        if (error.code === '42501' || error.message?.includes('permission denied') || error.message?.includes('RLS')) {
                            showError('Permission denied. Please run the fix_task_rls_policies.sql script in your Supabase SQL editor to fix RLS policies.');
                        } else if (error.code === '23503') {
                            showError('Foreign key constraint error. The task might reference invalid data.');
                        } else {
                            showError(`Failed to update task position: ${error.message || 'Unknown error'}`);
                        }
                        
                        throw error;
                    }
                    
                    console.log('Successfully updated task:', update.id, 'to position:', update.position);
                }
                
                showSuccess('Task order saved successfully!');
                
                // Reload tasks to ensure UI is in sync
                await loadTasks();
                
                // If we're in the task groups panel, refresh that too
                if (document.getElementById('taskGroupsMainPanel').style.display !== 'none') {
                    await loadTaskGroups();
                }
                
                closeTaskOrderingModal();
                
            } catch (error) {
                console.error('Error saving task order:', {
                    error: error,
                    message: error?.message,
                    details: error?.details,
                    hint: error?.hint,
                    code: error?.code
                });
                showError('Failed to save task order: ' + (error?.message || 'Unknown error'));
            }
        }
        
        function closeTaskOrderingModal() {
            document.getElementById('taskOrderingModal').style.display = 'none';
            currentOrderingGroupId = null;
            currentNewTaskId = null;
        }
        
        // Load individual users with company info for searchable dropdown
        let allUsersData = [];
        async function loadIndividualUsers() {
            const selectElement = document.getElementById('individualUserSelect');
            
            if (!selectElement) {
                console.error('Individual user select element not found');
                return;
            }
            
            try {
                console.log('Loading individual users...');
                const { data, error } = await supabaseClient
                    .from('onboarding_users')
                    .select('id, first_name, last_name, email, company_name, created_at')
                    .order('email', { ascending: true });
                
                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }
                
                console.log('Users loaded:', data?.length || 0, 'users');
                allUsersData = data || [];
                
                // Clear existing options
                selectElement.innerHTML = '';
                
                if (!data || data.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No users found';
                    selectElement.appendChild(option);
                    return;
                }
                
                // Add placeholder option
                const placeholderOption = document.createElement('option');
                placeholderOption.value = '';
                placeholderOption.textContent = 'Select a user...';
                selectElement.appendChild(placeholderOption);
                
                // Add users to dropdown
                data.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'Unnamed User';
                    option.textContent = `${fullName} - ${user.email}${user.company_name ? ' - ' + user.company_name : ''}`;
                    option.setAttribute('data-name', fullName.toLowerCase());
                    option.setAttribute('data-email', user.email?.toLowerCase() || '');
                    option.setAttribute('data-company', user.company_name?.toLowerCase() || '');
                    selectElement.appendChild(option);
                });
                
                return Promise.resolve();
            } catch (error) {
                console.error('Error loading individual users:', error);
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Error loading users';
                selectElement.appendChild(option);
                return Promise.reject(error);
            }
        }
        
        // Filter user dropdown based on search
        function filterUserDropdown() {
            const searchInput = document.getElementById('userSearchInput').value.toLowerCase();
            const selectElement = document.getElementById('individualUserSelect');
            const options = selectElement.getElementsByTagName('option');
            
            for (let option of options) {
                const name = option.getAttribute('data-name') || '';
                const email = option.getAttribute('data-email') || '';
                const company = option.getAttribute('data-company') || '';
                
                if (name.includes(searchInput) || email.includes(searchInput) || company.includes(searchInput)) {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                }
            }
        }
        
        // Load user groups for dropdown
        async function loadUserGroupsForDropdown() {
            const selectElement = document.getElementById('userGroupSelect');
            
            if (!selectElement) {
                console.error('User group select element not found');
                return;
            }
            
            try {
                console.log('Loading user groups...');
                const { data, error } = await supabaseClient
                    .from('user_groups')
                    .select('*')
                    .order('group_name', { ascending: true });
                
                if (error) {
                    console.error('Supabase error loading user groups:', error);
                    throw error;
                }
                
                console.log('User groups loaded:', data?.length || 0, 'groups');
                
                // Clear existing options (keep first one)
                while (selectElement.options.length > 1) {
                    selectElement.remove(1);
                }
                
                if (!data || data.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No user groups found';
                    selectElement.appendChild(option);
                    return;
                }
                
                // Add user groups to dropdown (excluding "All users")
                data.forEach(group => {
                    // Skip "All users" and "Default Group"
                    const groupNameLower = group.group_name ? group.group_name.toLowerCase() : '';
                    if (groupNameLower === 'all users' || groupNameLower === 'default group') {
                        return;
                    }
                    const option = document.createElement('option');
                    option.value = group.id;
                    option.textContent = group.group_name;
                    selectElement.appendChild(option);
                });
                
                return Promise.resolve();
            } catch (error) {
                console.error('Error loading user groups:', error);
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Error loading groups';
                selectElement.appendChild(option);
                return Promise.reject(error);
            }
        }
        
        // Update task groups based on selected user group
        async function updateTaskGroupsForUserGroup() {
            const userGroupId = document.getElementById('userGroupSelect').value;
            const taskGroupSection = document.getElementById('taskGroupSection');
            const taskGroupSelect = document.getElementById('taskGroupSelect');
            
            if (!userGroupId) {
                taskGroupSection.style.display = 'none';
                return Promise.resolve();
            }
            
            taskGroupSection.style.display = 'block';
            
            try {
                console.log('Loading task groups for user group:', userGroupId);
                
                // Load task groups that belong to this user group
                // Note: We now require task groups to belong to a specific user group
                const { data, error } = await supabaseClient
                    .from('task_groups')
                    .select('*')
                    .eq('user_group_id', userGroupId)
                    .order('display_order', { ascending: true });
                
                if (error) throw error;
                
                console.log('Task groups loaded:', data?.length || 0, 'groups');
                
                // Clear existing options (keep first one)
                while (taskGroupSelect.options.length > 1) {
                    taskGroupSelect.remove(1);
                }
                
                if (!data || data.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No task groups available for this user group';
                    taskGroupSelect.appendChild(option);
                    
                    // Add a help message
                    const helpText = document.createElement('small');
                    helpText.style.color = '#ef4444';
                    helpText.style.display = 'block';
                    helpText.style.marginTop = '8px';
                    helpText.textContent = 'Note: Task groups need to be associated with user groups. Please create task groups for this user group.';
                    
                    // Remove any existing help text
                    const existingHelp = taskGroupSelect.parentElement.querySelector('small.help-text');
                    if (existingHelp) existingHelp.remove();
                    
                    helpText.className = 'help-text';
                    taskGroupSelect.parentElement.appendChild(helpText);
                    return;
                }
                
                // Remove help text if it exists
                const existingHelp = taskGroupSelect.parentElement.querySelector('small.help-text');
                if (existingHelp) existingHelp.remove();
                
                // Store current value to restore after populating
                const currentValue = taskGroupSelect.value;
                
                // Add task groups to dropdown
                data.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.id;
                    option.textContent = group.group_name;
                    taskGroupSelect.appendChild(option);
                });
                
                // Try to restore the previous value if it exists
                if (currentValue) {
                    taskGroupSelect.value = currentValue;
                    console.log('Restored task group value:', currentValue);
                }
                
                return Promise.resolve();
            } catch (error) {
                console.error('Error loading task groups:', error);
                return Promise.reject(error);
            }
        }

        // Load available groups
        async function loadGroups() {
            try {
                const { data, error } = await supabaseClient
                    .from('user_groups')
                    .select('*')
                    .order('group_name');

                if (error) throw error;

                allGroups = data || [];
                renderGroupsCheckboxes();
            } catch (error) {
                console.error('Error loading groups:', error);
            }
        }

        // Render groups checkboxes
        function renderGroupsCheckboxes() {
            const container = document.getElementById('groupsCheckboxContainer');
            
            if (allGroups.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; font-style: italic;">No groups available. Groups will be created automatically when users are assigned to them.</p>';
                return;
            }

            container.innerHTML = allGroups.map(group => `
                <div class="targeting-checkbox">
                    <input type="checkbox" id="group_${group.id}" value="${group.id}">
                    <label for="group_${group.id}">${group.group_name}</label>
                </div>
                <div class="location-info">${group.group_description}</div>
            `).join('');
        }

        // Load available locations
        async function loadLocations() {
            try {
                const { data, error } = await supabaseClient
                    .from('onboarding_users')
                    .select('email, location_id')
                    .order('email');

                if (error) throw error;

                // Create unique locations array
                const locationMap = new Map();
                (data || []).forEach(user => {
                    const key = user.location_id;
                    if (!locationMap.has(key)) {
                        locationMap.set(key, {
                            location_id: user.location_id,
                            sample_email: user.email
                        });
                    }
                });

                allLocations = Array.from(locationMap.values());
                renderLocationsCheckboxes();
            } catch (error) {
                console.error('Error loading locations:', error);
            }
        }

        // Render locations checkboxes
        function renderLocationsCheckboxes() {
            const container = document.getElementById('locationsCheckboxContainer');
            
            if (allLocations.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; font-style: italic;">No locations available. Locations are created when users sign up.</p>';
                return;
            }

            container.innerHTML = allLocations.map(location => `
                <div class="targeting-checkbox">
                    <input type="checkbox" id="location_${location.location_id}" value="${location.location_id}">
                    <label for="location_${location.location_id}">${location.location_id}</label>
                </div>
                <div class="location-info">Example user: ${location.sample_email}</div>
            `).join('');
        }

        // Get selected groups
        function getSelectedGroups() {
            const checkboxes = document.querySelectorAll('#groupsCheckboxContainer input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => parseInt(cb.value));
        }

        // Get selected locations
        function getSelectedLocations() {
            const checkboxes = document.querySelectorAll('#locationsCheckboxContainer input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // Set selected groups (for editing existing tasks)
        function setSelectedGroups(groupIds) {
            groupIds.forEach(groupId => {
                const checkbox = document.getElementById(`group_${groupId}`);
                if (checkbox) checkbox.checked = true;
            });
        }

        // Set selected locations (for editing existing tasks)
        function setSelectedLocations(locationIds) {
            locationIds.forEach(locationId => {
                const checkbox = document.getElementById(`location_${locationId}`);
                if (checkbox) checkbox.checked = true;
            });
        }

        // Set selected users (for editing existing tasks)
        function setSelectedUsers(userIds) {
            userIds.forEach(userId => {
                const checkbox = document.getElementById(`user_${userId}`);
                if (checkbox) checkbox.checked = true;
            });
        }

        // Load available users
        async function loadUsers() {
            try {
                const { data, error } = await supabaseClient
                    .from('onboarding_users')
                    .select('id, email, location_id, created_at')
                    .order('email');

                if (error) throw error;

                allUsers = data || [];
                renderUsersCheckboxes();
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Render users checkboxes
        function renderUsersCheckboxes() {
            const container = document.getElementById('individualsCheckboxContainer');
            
            if (allUsers.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; font-style: italic;">No users available. Users are created when they access the onboarding system.</p>';
                return;
            }

            container.innerHTML = allUsers.map(user => `
                <div class="targeting-checkbox">
                    <input type="checkbox" id="user_${user.id}" value="${user.id}">
                    <label for="user_${user.id}">${user.email}</label>
                </div>
                <div class="location-info">Location: ${user.location_id} • Joined: ${new Date(user.created_at).toLocaleDateString()}</div>
            `).join('');
        }

        // Get selected users
        function getSelectedUsers() {
            const checkboxes = document.querySelectorAll('#individualsCheckboxContainer input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => parseInt(cb.value));
        }

        // Set selected users (for editing existing tasks)
        function setSelectedUsers(userIds) {
            userIds.forEach(userId => {
                const checkbox = document.getElementById(`user_${userId}`);
                if (checkbox) checkbox.checked = true;
            });
        }

        // Send notification webhook for individual users
        async function sendUserNotifications(users, taskData) {
            // Get notification webhook URL from database
            let notificationWebhook = null;
            try {
                const { data, error } = await supabaseClient
                    .from('webhook_settings')
                    .select('webhook_url')
                    .eq('webhook_name', 'user_notification')
                    .eq('is_active', true)
                    .single();
                    
                if (error || !data) {
                    console.warn('No active user_notification webhook found in database');
                    return;
                }
                
                notificationWebhook = data.webhook_url;
            } catch (error) {
                console.error('Failed to get notification webhook URL:', error);
                return;
            }
            
            console.log('Sending notifications to users:', users);
            
            for (const user of users) {
                try {
                    const notificationData = {
                        taskTitle: taskData.title,
                        taskDescription: taskData.description,
                        userEmail: user.email,
                        locationId: user.location_id,
                        taskId: taskData.task_id,
                        createdAt: new Date().toISOString(),
                        notificationType: 'task_assigned'
                    };

                    console.log('Sending notification:', notificationData);

                    const response = await fetch(notificationWebhook, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(notificationData)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    console.log(`Notification sent successfully to ${user.email}`);
                } catch (error) {
                    console.error(`Failed to send notification to ${user.email}:`, error);
                }
            }
        }

        // Load all tasks from database
        async function loadTasks() {
            try {
                console.log('Loading tasks from database...');
                
                // Check if supabaseClient exists
                if (!supabaseClient) {
                    console.error('Supabase client is not initialized!');
                    showError('Database connection not initialized. Please refresh the page.');
                    return;
                }
                
                // Load tasks
                console.log('Fetching tasks from onboarding_tasks table...');
                const { data: tasksData, error: tasksError } = await supabaseClient
                    .from('onboarding_tasks')
                    .select('*')
                    .order('position');

                if (tasksError) {
                    console.error('Database error loading tasks:', tasksError);
                    console.error('Error details:', {
                        message: tasksError.message,
                        details: tasksError.details,
                        hint: tasksError.hint,
                        code: tasksError.code
                    });
                    showError('Failed to load tasks: ' + tasksError.message);
                    throw tasksError;
                }
                
                console.log('Tasks loaded successfully:', tasksData?.length || 0, 'tasks');
                
                // Also load task groups for reference
                const { data: groupsData, error: groupsError } = await supabaseClient
                    .from('task_groups')
                    .select('*')
                    .order('display_order');
                    
                if (groupsError) {
                    console.error('Error loading task groups:', groupsError);
                    // Don't throw, just log - task groups are not critical
                }

                tasks = tasksData || [];
                allTaskGroupsData = groupsData || [];
                
                console.log('Data loaded - Tasks:', tasks.length, 'Task groups:', allTaskGroupsData.length);
                
                // Check if tasksList element exists
                const tasksList = document.getElementById('tasksList');
                if (!tasksList) {
                    console.error('tasksList element not found in DOM!');
                    showError('UI element missing. Please refresh the page.');
                    return;
                }
                
                renderTasks();
            } catch (error) {
                console.error('Error in loadTasks:', error);
                console.error('Stack trace:', error.stack);
                showError('Failed to load tasks: ' + (error.message || 'Unknown error'));
            }
        }

        // Render tasks list
        // Get task targeting indicator
        function getTaskIndicator(targetType, task) {
            const icons = {
                'groups': { class: 'groups', label: 'Groups' },
                'locations': { class: 'locations', label: 'Locations' },
                'individuals': { class: 'individuals', label: 'Users' }
            };
            
            const icon = icons[targetType] || icons['groups'];
            return `<span class="task-indicator ${icon.class}">
                        <span class="task-indicator-icon"></span>
                        ${icon.label}
                    </span>`;
        }

        // Search tasks with debouncing
        let searchTimeout;
        function searchTasks() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                renderTasks();
            }, 300); // 300ms debounce
        }

        // Filter tasks function
        // Handle main filter change and show/hide secondary dropdowns
        async function handleFilterChange() {
            const filterValue = document.getElementById('taskFilter').value;
            const taskGroupsContainer = document.getElementById('taskGroupsFilterContainer');
            const usersContainer = document.getElementById('usersFilterContainer');
            
            // Hide all secondary dropdowns first
            taskGroupsContainer.style.display = 'none';
            usersContainer.style.display = 'none';
            
            // Show appropriate secondary dropdown and populate it
            if (filterValue === 'groups') {
                taskGroupsContainer.style.display = 'inline-block';
                await loadTaskGroupsForFilter();
            } else if (filterValue === 'individuals') {
                usersContainer.style.display = 'inline-block';
                await loadUsersForFilter();
            }
            
            // Apply the filter
            filterTasks();
        }

        function filterTasks() {
            renderTasks(); // Re-render with new filter
        }

        function renderTasks() {
            try {
                console.log('Starting renderTasks...');
                const tasksList = document.getElementById('tasksList');
                
                if (!tasksList) {
                    console.error('tasksList element not found!');
                    return;
                }
                
                const filterValue = document.getElementById('taskFilter')?.value || 'all';
                const taskGroupFilter = document.getElementById('taskGroupsFilter')?.value || '';
                const userFilter = document.getElementById('usersFilter')?.value || '';
                const searchTerm = document.getElementById('taskSearchInput')?.value?.toLowerCase() || '';
                
                console.log('Rendering with filters:', {
                    filter: filterValue,
                    taskGroup: taskGroupFilter,
                    user: userFilter,
                    search: searchTerm,
                    totalTasks: tasks.length
                });
                
                // Clear any existing messages when filters change
                clearMessages();
            
            // Filter tasks based on selected filter
            let filteredTasks = tasks;
            
            // Apply search filter first
            if (searchTerm) {
                filteredTasks = filteredTasks.filter(task => {
                    const title = (task.title || '').toLowerCase();
                    const description = (task.description || '').toLowerCase();
                    return title.includes(searchTerm) || description.includes(searchTerm);
                });
            }
            
            // Then apply category filters
            if (filterValue !== 'all') {
                filteredTasks = filteredTasks.filter(task => {
                    const targetType = task.target_type || 'groups';
                    
                    // First filter by target type
                    let matchesTargetType = false;
                    if (filterValue === 'groups') matchesTargetType = targetType === 'groups';
                    else if (filterValue === 'individuals') matchesTargetType = targetType === 'individuals';
                    else matchesTargetType = true;
                    
                    if (!matchesTargetType) return false;
                    
                    // Apply secondary filters
                    if (filterValue === 'groups' && taskGroupFilter) {
                        // Filter by specific task group
                        return task.task_group_id && task.task_group_id.toString() === taskGroupFilter;
                    }
                    
                    if (filterValue === 'individuals' && userFilter) {
                        // Filter by specific user - check if user would see this task
                        return doesTaskApplyToUser(task, userFilter);
                    }
                    
                    return true;
                });
            }
            
            // Update search results info
            const searchResultsInfo = document.getElementById('searchResultsInfo');
            const searchResultsText = document.getElementById('searchResultsText');
            
            if (searchTerm || filterValue !== 'all') {
                const totalTasks = tasks.length;
                const foundTasks = filteredTasks.length;
                let infoText = `Showing ${foundTasks} of ${totalTasks} tasks`;
                
                if (searchTerm) {
                    infoText += ` matching "${searchTerm}"`;
                }
                if (filterValue !== 'all') {
                    infoText += ` (filtered by ${document.getElementById('taskFilter').selectedOptions[0].text})`;
                }
                
                searchResultsText.textContent = infoText;
                searchResultsInfo.classList.add('active');
            } else {
                searchResultsInfo.classList.remove('active');
            }
            
            if (filteredTasks.length === 0) {
                const message = tasks.length === 0 
                    ? 'No tasks found. Click "Add New Task" to create your first task.'
                    : searchTerm 
                        ? `No tasks found matching "${searchTerm}"`
                        : `No tasks found for "${document.getElementById('taskFilter').selectedOptions[0].text}" filter.`;
                tasksList.innerHTML = `<div class="loading">${message}</div>`;
                return;
            }

            tasksList.innerHTML = filteredTasks.map(task => {
                const targetType = task.target_type || 'groups';
                const indicator = getTaskIndicator(targetType, task);
                
                return `
                <div class="task-item ${currentTask && currentTask.id === task.id ? 'active' : ''}" 
                     onclick="editTask('${task.id}')">
                    <div class="task-position">${task.position}</div>
                    <div class="task-content">
                        <div class="task-title">
                            ${task.title}
                            ${indicator}
                        </div>
                        <div class="task-description">${task.description}</div>
                    </div>
                    <div class="task-actions">
                        <div class="task-toggle ${task.is_active ? 'active' : ''}" 
                             onclick="event.stopPropagation(); toggleTaskActive('${task.id}', ${!task.is_active})"></div>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteTask('${task.id}')">&times;</button>
                    </div>
                </div>
                `;
            }).join('');
            
            console.log('Rendered', filteredTasks.length, 'tasks successfully');
            } catch (error) {
                console.error('Error in renderTasks:', error);
                console.error('Stack trace:', error.stack);
                showError('Failed to render tasks: ' + error.message);
            }
        }

        // Load task groups for dropdown in Add/Edit Task form
        async function loadTaskGroupsForDropdown() {
            try {
                const { data: taskGroups, error } = await supabaseClient
                    .from('task_groups')
                    .select('id, group_name')
                    .eq('is_active', true)
                    .order('display_order');

                if (error) throw error;

                const select = document.getElementById('taskGroupSelect');
                select.innerHTML = '<option value="">No Group (Standalone Task)</option>';
                
                if (taskGroups && taskGroups.length > 0) {
                    taskGroups.forEach(group => {
                        select.innerHTML += `<option value="${group.id}">${group.group_name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading task groups for dropdown:', error);
            }
        }

        // Load task groups for filter dropdown
        async function loadTaskGroupsForFilter() {
            try {
                const { data: taskGroups, error } = await supabaseClient
                    .from('task_groups')
                    .select('id, group_name')
                    .eq('is_active', true)
                    .order('display_order');

                if (error) throw error;

                const select = document.getElementById('taskGroupsFilter');
                select.innerHTML = '<option value="">All task groups...</option>';
                
                if (taskGroups && taskGroups.length > 0) {
                    taskGroups.forEach(group => {
                        select.innerHTML += `<option value="${group.id}">${group.group_name}</option>`;
                    });
                } else {
                    select.innerHTML += '<option value="">No task groups available</option>';
                }
            } catch (error) {
                console.error('Error loading task groups for filter:', error);
                const select = document.getElementById('taskGroupsFilter');
                select.innerHTML = '<option value="">Error loading groups</option>';
            }
        }

        // Load users for filter dropdown
        async function loadUsersForFilter() {
            try {
                const { data: users, error } = await supabaseClient
                    .from('onboarding_users')
                    .select('id, email, first_name, last_name, location_id')
                    .order('email');

                if (error) throw error;

                const select = document.getElementById('usersFilter');
                select.innerHTML = '<option value="">All users...</option>';
                
                if (users && users.length > 0) {
                    users.forEach(user => {
                        const displayName = user.first_name && user.last_name 
                            ? `${user.first_name} ${user.last_name} (${user.email})`
                            : user.email;
                        select.innerHTML += `<option value="${user.id}">${displayName}</option>`;
                    });
                } else {
                    select.innerHTML += '<option value="">No users found</option>';
                }
            } catch (error) {
                console.error('Error loading users for filter:', error);
                const select = document.getElementById('usersFilter');
                select.innerHTML = '<option value="">Error loading users</option>';
            }
        }

        // Check if a task applies to a specific user
        function doesTaskApplyToUser(task, userId) {
            // Tasks must have a target type
            if (!task.target_type) {
                return false;
            }

            // If task targets individuals, check if this user is in the target list
            if (task.target_type === 'individuals') {
                const targetUsers = task.target_users || [];
                return targetUsers.includes(parseInt(userId));
            }

            // For groups and locations, we'd need to check user's groups/location
            // This would require more complex logic based on user data
            // For now, show all group/location tasks when filtering by individual
            if (task.target_type === 'groups' || task.target_type === 'locations') {
                return true; // Placeholder - would need user group/location data
            }

            return false;
        }

        // Show edit panel
        function showEditPanel(task) {
            const container = document.getElementById('container');
            const editTitle = document.getElementById('editTitle');
            
            container.classList.add('editing');
            
            if (task) {
                editTitle.textContent = 'Edit Task';
            } else {
                editTitle.textContent = 'Add New Task';
            }

            initQuillEditor();
            
            // Populate form after editor is ready
            setTimeout(() => {
                if (task) {
                    populateForm(task);
                }
                // clearForm is already called in addNewTask() for new tasks
            }, 100);
            
            isEditing = true;
        }

        // Close edit panel
        function closeEditPanel() {
            const container = document.getElementById('container');
            container.classList.remove('editing');
            
            // Remove any modal overlay that might be present
            const taskOverlay = document.getElementById('taskModalOverlay');
            if (taskOverlay) {
                document.body.removeChild(taskOverlay);
            }
            const modalOverlay = document.getElementById('modalOverlay');
            if (modalOverlay) {
                document.body.removeChild(modalOverlay);
            }
            
            // Completely destroy Quill editor and clean up
            if (quillEditor) {
                destroyQuillEditor();
            }
            
            // Check if we came from Task Sequences panel
            const taskSequencesPanel = document.getElementById('taskSequencesPanel');
            if (taskSequencesPanel && taskSequencesPanel.style.display !== 'none') {
                // We're editing a sequence, return to Task Sequences
                document.getElementById('editPanel').style.display = 'none';
                taskSequencesPanel.style.display = 'block';
                updateNavigationActive('task-sequences');
                return;
            }
            
            // Additional cleanup - remove any stray Quill elements from the entire edit panel
            const editPanel = document.getElementById('editPanel');
            const strayElements = editPanel.querySelectorAll('.ql-toolbar, .ql-container:not(#quillEditor)');
            strayElements.forEach(element => {
                console.log('Removing stray Quill element:', element);
                element.remove();
            });
            
            // Clear all form fields
            document.getElementById('taskForm').reset();
            
            // Clear the preview content completely
            const previewContent = document.getElementById('previewContent');
            previewContent.innerHTML = 'Preview will appear here as you type...';
            
            // Reset quill container to pristine state
            const quillContainer = document.getElementById('quillEditor');
            quillContainer.innerHTML = '';
            quillContainer.className = '';
            quillContainer.removeAttribute('data-html-mode');
            quillContainer.style.cssText = '';
            
            // Reset states
            currentTask = null;
            isEditing = false;
            clearMessages();
            
            // Re-render tasks to remove active state highlighting
            renderTasks();
            
            console.log('Edit panel completely closed and reset with enhanced cleanup');
        }

        // Initialize Quill editor - simple direct approach
        function initQuillEditor() {
            const container = document.getElementById('quillEditor');
            
            // Clean up any existing Quill elements first
            document.querySelectorAll('.ql-toolbar').forEach(el => el.remove());
            
            // Reset container 
            container.innerHTML = '';
            container.className = '';
            container.removeAttribute('data-html-mode');
            container.style.cssText = '';

            // Create new Quill instance
            quillEditor = new Quill(container, {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [2, 3, false] }],
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['link'],
                        ['code-block'],
                        ['clean']
                    ]
                }
            });

            // Add custom HTML editing button
            addHtmlEditButton();
            
            // Add custom link handler
            setupCustomLinkHandler();
            

            // Update preview on content change - removed as updatePreview is not needed
            // quillEditor.on('text-change', updatePreview);
            
            console.log('Quill editor initialized');
        }
        

        // Setup custom link handler for Quill
        function setupCustomLinkHandler() {
            const toolbar = quillEditor.getModule('toolbar');
            
            // Override the default link handler
            toolbar.addHandler('link', function(value) {
                if (value) {
                    const range = quillEditor.getSelection();
                    if (range == null || range.length == 0) return;
                    
                    const selectedText = quillEditor.getText(range.index, range.length);
                    
                    // Check if we're editing an existing link
                    const formats = quillEditor.getFormat(range);
                    const existingUrl = formats.link || '';
                    
                    // Try to detect if the existing link opens in new tab
                    let existingTarget = '_blank'; // Default to new tab
                    if (existingUrl) {
                        const content = quillEditor.root.innerHTML;
                        const linkRegex = new RegExp(`<a[^>]*href=["']${existingUrl.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}["'][^>]*>`, 'i');
                        const match = content.match(linkRegex);
                        if (match && match[0].includes('target="_self"')) {
                            existingTarget = '_self';
                        }
                    }
                    
                    // Create custom link dialog
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        padding: 24px;
                        border-radius: 8px;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                        z-index: 10000;
                        width: 420px;
                    `;
                    
                    modal.innerHTML = `
                        <h3 style="margin: 0 0 16px 0; color: #1f2937;">${existingUrl ? 'Edit' : 'Add'} Link</h3>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">URL:</label>
                            <input type="url" id="linkUrl" placeholder="https://example.com" value="${existingUrl}"
                                style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 14px;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Link Text:</label>
                            <input type="text" id="linkText" value="${selectedText}" 
                                style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 14px;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Open in:</label>
                            <div style="display: flex; gap: 16px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="linkTarget" value="_blank" ${existingTarget === '_blank' ? 'checked' : ''}>
                                    <span>New Tab (Recommended)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="linkTarget" value="_self" ${existingTarget === '_self' ? 'checked' : ''}>
                                    <span>Same Window</span>
                                </label>
                            </div>
                            <small style="color: #6b7280; display: block; margin-top: 8px;">
                                Note: "Same Window" will navigate users away from the task in the CRM
                            </small>
                        </div>
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button id="cancelLink" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: white; border-radius: 4px; cursor: pointer;">Cancel</button>
                            <button id="insertLink" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">Insert Link</button>
                        </div>
                    `;
                    
                    // Create overlay
                    const overlay = document.createElement('div');
                    overlay.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0,0,0,0.5);
                        z-index: 9999;
                    `;
                    
                    document.body.appendChild(overlay);
                    document.body.appendChild(modal);
                    
                    // Focus URL input
                    setTimeout(() => {
                        document.getElementById('linkUrl').focus();
                    }, 100);
                    
                    // Handle insert
                    document.getElementById('insertLink').onclick = function() {
                        const url = document.getElementById('linkUrl').value;
                        const text = document.getElementById('linkText').value || url;
                        const target = document.querySelector('input[name="linkTarget"]:checked').value;
                        
                        if (url) {
                            // Delete the selected text first
                            quillEditor.deleteText(range.index, range.length);
                            
                            // Insert the link with custom HTML
                            const linkHtml = `<a href="${url}" target="${target}">${text}</a>`;
                            quillEditor.clipboard.dangerouslyPasteHTML(range.index, linkHtml);
                        }
                        
                        document.body.removeChild(modal);
                        document.body.removeChild(overlay);
                    };
                    
                    // Handle cancel
                    document.getElementById('cancelLink').onclick = function() {
                        document.body.removeChild(modal);
                        document.body.removeChild(overlay);
                    };
                    
                    // Handle Enter key in URL field
                    document.getElementById('linkUrl').onkeypress = function(e) {
                        if (e.key === 'Enter') {
                            document.getElementById('insertLink').click();
                        }
                    };
                    
                } else {
                    // Remove link
                    quillEditor.format('link', false);
                }
            });
        }
        
        // Add custom HTML editing functionality
        function addHtmlEditButton() {
            const toolbar = quillEditor.getModule('toolbar');
            const toolbarElement = document.querySelector('.ql-toolbar');
            
            // Add HTML edit button
            const htmlButton = document.createElement('button');
            htmlButton.innerHTML = '&lt;/&gt;';
            htmlButton.title = 'Edit HTML';
            htmlButton.className = 'ql-html-edit';
            htmlButton.style.cssText = `
                border: none;
                background: #f0f0f0;
                padding: 6px 8px;
                border-radius: 4px;
                cursor: pointer;
                margin-left: 8px;
                font-weight: bold;
            `;
            
            htmlButton.onclick = function(e) {
                e.preventDefault();
                toggleHtmlMode();
            };
            
            toolbarElement.appendChild(htmlButton);
        }

        // Toggle between visual and HTML editing modes
        function toggleHtmlMode() {
            const editorContainer = document.querySelector('#quillEditor');
            const isHtmlMode = editorContainer.dataset.htmlMode === 'true';
            
            if (isHtmlMode) {
                // Switch back to visual mode
                const htmlContent = editorContainer.querySelector('.html-editor').value;
                quillEditor.root.innerHTML = htmlContent;
                editorContainer.querySelector('.html-editor').remove();
                quillEditor.root.style.display = 'block';
                editorContainer.dataset.htmlMode = 'false';
            } else {
                // Switch to HTML mode
                const htmlContent = quillEditor.root.innerHTML;
                
                // Create HTML textarea
                const htmlEditor = document.createElement('textarea');
                htmlEditor.className = 'html-editor';
                htmlEditor.value = htmlContent;
                htmlEditor.style.cssText = `
                    width: 100%;
                    height: 200px;
                    font-family: 'Courier New', monospace;
                    font-size: 13px;
                    padding: 10px;
                    border: 1px solid #ccc;
                    border-radius: 4px;
                    resize: vertical;
                `;
                
                let updateTimeout;
                htmlEditor.oninput = function() {
                    // Debounce updates to prevent too many rapid calls
                    // HTML mode input handling
                    // No preview update needed
                };
                
                // HTML mode keyup handling
                // No preview update needed
                
                quillEditor.root.style.display = 'none';
                editorContainer.appendChild(htmlEditor);
                editorContainer.dataset.htmlMode = 'true';
                
                // HTML mode enabled
            }
        }

        // Properly destroy Quill editor
        function destroyQuillEditor() {
            if (quillEditor) {
                const container = document.getElementById('quillEditor');
                
                // Find and remove ALL Quill toolbars in the entire edit panel
                const editPanel = document.getElementById('editPanel');
                const allToolbars = editPanel.querySelectorAll('.ql-toolbar');
                allToolbars.forEach(toolbar => {
                    console.log('Removing toolbar:', toolbar);
                    toolbar.remove();
                });
                
                // Remove any HTML editor textarea if in HTML mode
                const htmlEditor = container.querySelector('.html-editor');
                if (htmlEditor) {
                    htmlEditor.remove();
                }
                
                // Remove any remaining Quill containers
                const quillContainers = editPanel.querySelectorAll('.ql-container');
                quillContainers.forEach(qContainer => {
                    if (qContainer !== container) {
                        console.log('Removing extra Quill container:', qContainer);
                        qContainer.remove();
                    }
                });
                
                // Clear container completely and reset all attributes
                container.innerHTML = '';
                container.className = '';
                container.removeAttribute('data-html-mode');
                container.style.cssText = '';
                
                // Clear Quill instance
                quillEditor = null;
                
                console.log('Quill editor completely destroyed with enhanced cleanup');
            }
        }

        // Execute embedded scripts for live preview
        function executeEmbeddedScripts(container) {
            // Find and execute script tags in the preview
            const scripts = container.querySelectorAll('script');
            scripts.forEach(script => {
                if (script.src) {
                    // External script
                    const newScript = document.createElement('script');
                    newScript.src = script.src;
                    newScript.async = true;
                    newScript.onload = function() {
                        console.log('External script loaded:', script.src);
                        // Trigger any form initialization that might be needed
                        if (window.FormEmbed && typeof window.FormEmbed.init === 'function') {
                            window.FormEmbed.init();
                        }
                    };
                    document.head.appendChild(newScript);
                } else if (script.innerHTML) {
                    // Inline script - execute safely
                    try {
                        eval(script.innerHTML);
                    } catch (e) {
                        console.log('Script execution skipped for preview:', e.message);
                    }
                }
            });

            // Force refresh iframes to ensure they load properly
            const iframes = container.querySelectorAll('iframe');
            iframes.forEach(iframe => {
                if (iframe.src) {
                    const originalSrc = iframe.src;
                    iframe.src = '';
                    setTimeout(() => {
                        iframe.src = originalSrc;
                    }, 10);
                }
            });
        }

        // Populate form with task data
        function populateForm(task) {
            document.getElementById('taskId').value = task.task_id;
            document.getElementById('title').value = task.title;
            document.getElementById('description').value = task.description;
            document.getElementById('instructionTitle').value = task.instruction_title;
            
            // Set video completion requirement
            const requireVideoCheckbox = document.getElementById('requireVideoCompletion');
            if (requireVideoCheckbox) {
                requireVideoCheckbox.checked = task.require_video_completion || false;
            }
            
            // Set video gating requirement
            const gateNextTaskCheckbox = document.getElementById('gateNextTaskOnVideo');
            if (gateNextTaskCheckbox) {
                gateNextTaskCheckbox.checked = task.gate_next_task_on_video || false;
            }
            
            // Handle video based on type
            if (task.video_type === 'upload' && task.video_url) {
                // Uploaded video
                document.getElementById('useVideoUrl').checked = false;
                toggleVideoMode();
                uploadedVideoUrl = task.video_url;
                uploadedVideoPath = task.video_storage_path;
                // Show video preview
                const uploadInput = document.getElementById('videoUploadInput');
                if (uploadInput) {
                    let previewContainer = uploadInput.querySelector('.video-preview-container');
                    if (!previewContainer) {
                        previewContainer = document.createElement('div');
                        previewContainer.className = 'video-preview-container';
                        previewContainer.style.cssText = 'margin-top: 15px; padding: 15px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;';
                        previewContainer.innerHTML = `
                            <div style="font-weight: 600; color: #374151; margin-bottom: 10px;">Current Video:</div>
                            <video controls style="width: 100%; max-width: 400px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <source src="${task.video_url}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            <div style="margin-top: 10px; color: #6b7280; font-size: 14px;">
                                <i data-lucide="info" style="width: 14px; height: 14px; display: inline-block; margin-right: 4px;"></i>
                                Select a new file above to replace this video
                            </div>
                        `;
                        uploadInput.appendChild(previewContainer);
                        // Initialize lucide icons for the info icon
                        setTimeout(() => lucide.createIcons(), 100);
                    }
                }
            } else if (task.video_url) {
                // URL video - show preview for URL videos too
                document.getElementById('useVideoUrl').checked = true;
                toggleVideoMode();
                document.getElementById('videoUrl').value = task.video_url;
                
                // Show video preview for URL videos
                const urlInput = document.getElementById('videoUrlInput');
                if (urlInput && task.video_url) {
                    setTimeout(() => {
                        let previewContainer = urlInput.querySelector('.video-preview-container');
                        if (!previewContainer) {
                            previewContainer = document.createElement('div');
                            previewContainer.className = 'video-preview-container';
                            previewContainer.style.cssText = 'margin-top: 15px; padding: 15px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;';
                            
                            // Determine if it's YouTube, Vimeo, or direct video
                            let videoContent = '';
                            if (task.video_url.includes('youtube.com') || task.video_url.includes('youtu.be')) {
                                // Extract YouTube video ID
                                let videoId = '';
                                if (task.video_url.includes('youtube.com')) {
                                    const urlParams = new URLSearchParams(new URL(task.video_url).search);
                                    videoId = urlParams.get('v');
                                } else if (task.video_url.includes('youtu.be')) {
                                    videoId = task.video_url.split('/').pop();
                                }
                                if (videoId) {
                                    videoContent = `<iframe width="400" height="225" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen style="border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></iframe>`;
                                }
                            } else if (task.video_url.includes('vimeo.com')) {
                                // Extract Vimeo video ID
                                const videoId = task.video_url.split('/').pop().split('?')[0];
                                videoContent = `<iframe width="400" height="225" src="https://player.vimeo.com/video/${videoId}" frameborder="0" allowfullscreen style="border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></iframe>`;
                            } else {
                                // Direct video URL or other platform
                                videoContent = `
                                    <video controls style="width: 100%; max-width: 400px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <source src="${task.video_url}" type="video/mp4">
                                        Your browser does not support the video tag.
                                    </video>
                                `;
                            }
                            
                            previewContainer.innerHTML = `
                                <div style="font-weight: 600; color: #374151; margin-bottom: 10px;">Current Video:</div>
                                ${videoContent}
                                <div style="margin-top: 10px; color: #6b7280; font-size: 14px;">
                                    <i data-lucide="info" style="width: 14px; height: 14px; display: inline-block; margin-right: 4px;"></i>
                                    Change the URL above to update the video
                                </div>
                            `;
                            urlInput.appendChild(previewContainer);
                            // Initialize lucide icons for the info icon
                            setTimeout(() => lucide.createIcons(), 100);
                        }
                    }, 200);
                }
            } else {
                // No video - default to upload mode
                document.getElementById('useVideoUrl').checked = false;
                toggleVideoMode();
                document.getElementById('videoUrl').value = '';
                uploadedVideoUrl = null;
                uploadedVideoPath = null;
            }

            // Check if there's form embed code
            if (task.form_embed_code) {
                document.getElementById('hasFormEmbed').checked = true;
                document.getElementById('formEmbedCode').value = task.form_embed_code;
                document.getElementById('formEmbedGroup').style.display = 'block';
            } else {
                document.getElementById('hasFormEmbed').checked = false;
                document.getElementById('formEmbedCode').value = '';
                document.getElementById('formEmbedGroup').style.display = 'none';
            }

            // Determine if it's individual or group task
            if (task.target_type === 'individuals' && task.target_users && task.target_users.length > 0) {
                // Individual task
                document.getElementById('showTaskTo').value = 'individual';
                updateShowTaskTo();
                
                // Load users and set selection with a delay to ensure dropdown is populated
                loadIndividualUsers().then(() => {
                    setTimeout(() => {
                        const individualSelect = document.getElementById('individualUserSelect');
                        if (individualSelect) {
                            individualSelect.value = task.target_users[0];
                            // If value wasn't set (user might not be in list), try again
                            if (!individualSelect.value && task.target_users[0]) {
                                console.log('User not found in dropdown, ID:', task.target_users[0]);
                            }
                        }
                    }, 100);
                });
                
                // Set due date if it exists
                if (task.due_date) {
                    const dueDate = new Date(task.due_date);
                    const localDateTime = new Date(dueDate.getTime() - dueDate.getTimezoneOffset() * 60000)
                        .toISOString()
                        .slice(0, 16);
                    document.getElementById('taskDueDate').value = localDateTime;
                }
            } else if (task.target_type === 'groups' && task.target_groups && task.target_groups.length > 0) {
                // User group task
                document.getElementById('showTaskTo').value = 'usergroup';
                updateShowTaskTo();
                
                // Store task group ID to preserve it
                const savedTaskGroupId = task.task_group_id;
                console.log('Loading task with user group:', task.target_groups[0], 'and task group:', savedTaskGroupId);
                
                // Load user groups and set selection with proper chaining
                loadUserGroupsForDropdown().then(() => {
                    setTimeout(() => {
                        const userGroupSelect = document.getElementById('userGroupSelect');
                        if (userGroupSelect && task.target_groups[0]) {
                            userGroupSelect.value = task.target_groups[0];
                            console.log('Set user group to:', task.target_groups[0]);
                            
                            // Then load task groups and set selection if exists
                            updateTaskGroupsForUserGroup().then(() => {
                                setTimeout(() => {
                                    const taskGroupSelect = document.getElementById('taskGroupSelect');
                                    if (taskGroupSelect && savedTaskGroupId) {
                                        console.log('Setting task group to:', savedTaskGroupId);
                                        taskGroupSelect.value = savedTaskGroupId;
                                        
                                        // Verify it was set
                                        if (taskGroupSelect.value != savedTaskGroupId) {
                                            console.warn('Task group not found in dropdown:', savedTaskGroupId);
                                            // Try to find if it exists in options
                                            for (let option of taskGroupSelect.options) {
                                                console.log('Available option:', option.value, option.text);
                                            }
                                        }
                                    }
                                }, 200); // Increased timeout for better reliability
                            });
                        }
                    }, 100);
                });
            } else if (task.task_group_id) {
                // Task has a task group but no target groups - this might be legacy data
                // Try to find the user group from the task group
                document.getElementById('showTaskTo').value = 'usergroup';
                updateShowTaskTo();
                
                loadUserGroupsForDropdown().then(() => {
                    // If we have allTaskGroupsData, find the user group for this task group
                    const taskGroupData = allTaskGroupsData.find(g => g.id === task.task_group_id);
                    if (taskGroupData && taskGroupData.user_group_id) {
                        setTimeout(() => {
                            document.getElementById('userGroupSelect').value = taskGroupData.user_group_id;
                            updateTaskGroupsForUserGroup().then(() => {
                                setTimeout(() => {
                                    document.getElementById('taskGroupSelect').value = task.task_group_id;
                                }, 100);
                            });
                        }, 100);
                    }
                });
            } else {
                // Default to user group if unclear
                document.getElementById('showTaskTo').value = 'usergroup';
                updateShowTaskTo();
            }

            // Set Quill content after editor is initialized
            setTimeout(() => {
                if (quillEditor && task.instruction_content) {
                    quillEditor.root.innerHTML = task.instruction_content;
                }
            }, 100);
        }

        // Clear form
        function clearForm() {
            document.getElementById('taskForm').reset();
            document.getElementById('taskId').value = generateTaskId(); // Auto-generate new task ID
            document.getElementById('showTaskTo').value = 'usergroup';
            document.getElementById('formEmbedCode').value = '';
            document.getElementById('formEmbedGroup').style.display = 'none';
            document.getElementById('taskDueDate').value = '';
            document.getElementById('userSearchInput').value = '';
            
            // Reset video inputs - default to upload mode
            document.getElementById('useVideoUrl').checked = false;
            toggleVideoMode();
            selectedVideoFile = null;
            uploadedVideoUrl = null;
            uploadedVideoPath = null;
            document.getElementById('videoFile').value = '';
            document.getElementById('videoUrl').value = '';
            
            // Reset video completion checkbox
            const requireVideoCheckbox = document.getElementById('requireVideoCompletion');
            if (requireVideoCheckbox) {
                requireVideoCheckbox.checked = false;
            }
            
            // Reset video gating checkbox
            const gateNextTaskCheckbox = document.getElementById('gateNextTaskOnVideo');
            if (gateNextTaskCheckbox) {
                gateNextTaskCheckbox.checked = false;
            }
            // Remove any video preview
            const uploadInput = document.getElementById('videoUploadInput');
            if (uploadInput) {
                const preview = uploadInput.querySelector('.video-preview-container');
                if (preview) preview.remove();
            }
            const urlInput = document.getElementById('videoUrlInput');
            if (urlInput) {
                const urlPreview = urlInput.querySelector('.video-preview-container');
                if (urlPreview) urlPreview.remove();
            }
            
            // Reset to user group view (default)
            updateShowTaskTo();

            // Clear Quill content
            setTimeout(() => {
                if (quillEditor) {
                    quillEditor.setContents([]);
                }
            }, 100);
        }

        // Edit task
        async function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            // If we're currently editing a different task, save it first
            if (currentTask && currentTask.id !== taskId && isEditing) {
                console.log('Auto-saving current task before switching...');
                await autoSaveCurrentTask();
            }

            // If clicking the same task that's already being edited, do nothing
            if (currentTask && currentTask.id === taskId && isEditing) {
                return;
            }

            // Show task modal for editing
            showTaskModal(task);
            renderTasks(); // Re-render to show active state
        }

        // Auto-save current task without user interaction
        async function autoSaveCurrentTask() {
            if (!currentTask || !quillEditor) return;

            try {
                const targetType = document.getElementById('targetType').value;
                const targetGroups = targetType === 'groups' ? getSelectedGroups() : [];
                const targetLocations = targetType === 'locations' ? getSelectedLocations() : [];
                const targetUsers = targetType === 'individuals' ? getSelectedUsers() : [];
                // const notifyUsers = targetType === 'individuals' ? (document.getElementById('notifyUsers')?.checked || false) : false; // Removed - column doesn't exist
                const taskGroupId = document.getElementById('taskGroupSelect').value;

                const formData = {
                    task_id: document.getElementById('taskId').value.trim(),
                    title: document.getElementById('title').value.trim(),
                    description: document.getElementById('description').value.trim(),
                    instruction_title: document.getElementById('instructionTitle').value.trim(),
                    instruction_content: cleanContentForSaving(),
                    video_url: document.getElementById('videoUrl').value.trim() || null,
                    form_embed_code: document.getElementById('hasFormEmbed').checked ? document.getElementById('formEmbedCode').value.trim() : null,
                    task_group_id: taskGroupId ? parseInt(taskGroupId) : null,
                    position: currentTask.position, // Keep existing position for edits
                    target_type: targetType,
                    target_groups: targetGroups,
                    target_locations: targetLocations,
                    target_users: targetUsers,
                    // notify_users: notifyUsers, // Removed - column doesn't exist in database
                    is_active: currentTask.is_active
                };

                console.log('Auto-saving task:', formData);

                const { error } = await supabaseClient
                    .from('onboarding_tasks')
                    .update({
                        ...cleanDataForSupabase(formData),
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentTask.id);

                if (error) {
                    console.error('Auto-save error:', error);
                } else {
                    console.log('Task auto-saved successfully');
                    // Update the task in the local array
                    const taskIndex = tasks.findIndex(t => t.id === currentTask.id);
                    if (taskIndex !== -1) {
                        tasks[taskIndex] = { ...currentTask, ...formData };
                    }
                }
            } catch (error) {
                console.error('Auto-save failed:', error);
            }
        }

        // Generate unique task ID
        function generateTaskId() {
            const timestamp = Date.now();
            const randomStr = Math.random().toString(36).substring(2, 8);
            return `TASK-${timestamp}-${randomStr}`.toUpperCase();
        }
        
        // Add new task
        async function addNewTask() {
            console.log('addNewTask called');
            
            // Clear form first for new task
            clearForm();
            
            // Create new task modal
            showTaskModal(null);
        }

        // Show task modal (for add/edit tasks)
        function showTaskModal(task) {
            const editPanel = document.getElementById('editPanel');
            
            // Make edit panel a larger centered modal for comprehensive task editing
            editPanel.style.position = 'fixed';
            editPanel.style.top = '50%';
            editPanel.style.left = '50%';
            editPanel.style.transform = 'translate(-50%, -50%)';
            editPanel.style.width = '1100px';
            editPanel.style.maxWidth = '98vw';
            editPanel.style.maxHeight = '95vh';
            editPanel.style.overflowY = 'auto';
            editPanel.style.zIndex = '1000';
            editPanel.style.display = 'block';
            editPanel.style.visibility = 'visible';
            editPanel.style.opacity = '1';
            editPanel.style.background = 'white';
            editPanel.style.padding = '24px';
            editPanel.style.borderRadius = '12px';
            editPanel.style.boxShadow = '0 10px 25px rgba(0, 0, 0, 0.2)';
            editPanel.style.border = '1px solid #E5E7EB';
            
            // Add dark overlay behind modal
            const overlay = document.createElement('div');
            overlay.id = 'taskModalOverlay';
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            overlay.style.zIndex = '999';
            overlay.onclick = () => closeTaskModal();
            document.body.appendChild(overlay);
            
            // Update title
            const editTitle = document.getElementById('editTitle');
            if (task) {
                editTitle.textContent = 'Edit Task';
                currentTask = task;
            } else {
                editTitle.textContent = 'Add New Task';
                currentTask = null;
            }
            
            // Override the close button to call our cancel function
            const closeBtn = editPanel.querySelector('.close-btn');
            if (closeBtn) {
                closeBtn.onclick = closeTaskModal;
            }
            
            // Initialize editor and populate form
            initQuillEditor();
            
            // Initialize the form with proper view
            setTimeout(() => {
                if (task) {
                    populateForm(task);
                } else {
                    clearForm();
                    // For new tasks, load user groups for the default user group view
                    loadUserGroups();
                }
            }, 100);
            
            isEditing = true;
        }

        // Close task modal
        function closeTaskModal() {
            const editPanel = document.getElementById('editPanel');
            
            // Reset panel styles
            editPanel.style.position = '';
            editPanel.style.top = '';
            editPanel.style.left = '';
            editPanel.style.transform = '';
            editPanel.style.width = '';
            editPanel.style.maxWidth = '';
            editPanel.style.maxHeight = '';
            editPanel.style.overflowY = '';
            editPanel.style.zIndex = '';
            editPanel.style.visibility = '';
            editPanel.style.opacity = '';
            editPanel.style.background = '';
            editPanel.style.padding = '';
            editPanel.style.borderRadius = '';
            editPanel.style.boxShadow = '';
            editPanel.style.border = '';
            editPanel.style.display = 'none';
            
            // Remove overlay
            const overlay = document.getElementById('taskModalOverlay');
            if (overlay) {
                document.body.removeChild(overlay);
            }
            
            // Clean up editor
            if (quillEditor) {
                destroyQuillEditor();
            }
            
            // Reset form
            if (document.getElementById('taskForm')) {
                document.getElementById('taskForm').reset();
            }
            
            // Clear preview content
            const previewContent = document.getElementById('previewContent');
            if (previewContent) {
                previewContent.innerHTML = '';
            }
            
            isEditing = false;
            currentTask = null;
        }

        // Clean content before saving
        function cleanContentForSaving() {
            const editorContainer = document.querySelector('#quillEditor');
            const isHtmlMode = editorContainer.dataset.htmlMode === 'true';
            
            let content;
            if (isHtmlMode) {
                // Get content from HTML textarea
                const htmlEditor = editorContainer.querySelector('.html-editor');
                content = htmlEditor ? htmlEditor.value : '';
            } else {
                // Get content from Quill editor
                content = quillEditor.root.innerHTML;
            }
            
            // Clean any Quill artifacts that might have been included
            content = content.replace(/<div class="ql-toolbar[^>]*>[\s\S]*?<\/div>/gi, '');
            content = content.replace(/<span class="ql-[^"]*"[^>]*>[\s\S]*?<\/span>/gi, '');
            content = content.replace(/class="ql-[^"]*"/gi, '');
            content = content.replace(/<div[^>]*>\s*<\/div>/gi, '');
            
            return content.trim();
        }

        // Remove fields that don't exist in database
        function cleanDataForSupabase(data) {
            // Only include fields that definitely exist in the database
            const cleaned = {
                task_id: data.task_id,
                title: data.title,
                description: data.description || null,
                instruction_title: data.instruction_title,
                instruction_content: data.instruction_content || null,
                video_url: data.video_url || null,
                video_type: data.video_type || null,
                video_storage_path: data.video_storage_path || null,
                form_embed_code: data.form_embed_code || null,
                position: data.position,
                is_active: data.is_active !== undefined ? data.is_active : true,
                target_type: data.target_type || 'groups',
                due_date: data.due_date || null
            };
            
            // Add JSONB columns with proper defaults
            // These should be arrays, not undefined
            cleaned.target_groups = data.target_groups || [];
            cleaned.target_users = data.target_users || [];
            cleaned.target_locations = data.target_locations || [];
            
            // Only add task_group_id if it exists
            if (data.task_group_id !== undefined) {
                cleaned.task_group_id = data.task_group_id;
            }
            
            return cleaned;
        }

        // Get next position for a new task
        async function getNextPosition(groupId = null) {
            try {
                let query = supabaseClient
                    .from('onboarding_tasks')
                    .select('position')
                    .order('position', { ascending: false })
                    .limit(1);
                
                // If groupId is provided, filter by that group
                if (groupId) {
                    query = query.eq('task_group_id', groupId);
                }
                
                const { data: existingTasks, error } = await query;
                
                if (error) {
                    console.error('Error getting next position:', error);
                    return 1;
                }
                
                return existingTasks && existingTasks.length > 0 ? existingTasks[0].position + 1 : 1;
            } catch (error) {
                console.error('Error in getNextPosition:', error);
                return 1;
            }
        }

        // Save task
        async function saveTask(event) {
            event.preventDefault();
            
            // Clear any previous field errors
            clearFieldErrors();
            
            if (!quillEditor) {
                showError('Editor not initialized. Please try again.');
                return;
            }

            try {
                // Validate required fields
                const title = document.getElementById('title').value.trim();
                if (!title) {
                    showFieldError('title', 'Task title is required');
                    return;
                }

                const description = document.getElementById('description').value.trim();
                if (!description) {
                    showFieldError('description', 'Task description is required');
                    return;
                }

                const showTaskTo = document.getElementById('showTaskTo').value;
                let targetType, targetGroups, targetUsers, taskGroupId, dueDate;
                
                if (showTaskTo === 'individual') {
                    // Individual user task
                    const individualUserId = document.getElementById('individualUserSelect').value;
                    if (!individualUserId) {
                        showFieldError('individualUserSelect', 'Please select a user for this task');
                        return;
                    }
                    
                    targetType = 'individuals';
                    targetGroups = [];
                    targetUsers = [individualUserId];
                    taskGroupId = null;
                    
                    // Get due date for individual task
                    const dueDateValue = document.getElementById('taskDueDate').value;
                    dueDate = dueDateValue ? new Date(dueDateValue).toISOString() : null;
                    
                } else if (showTaskTo === 'usergroup') {
                    // User group task
                    const userGroupId = document.getElementById('userGroupSelect').value;
                    if (!userGroupId) {
                        showFieldError('userGroupSelect', 'User group is required. All tasks must be assigned to a user group.');
                        return;
                    }
                    
                    taskGroupId = document.getElementById('taskGroupSelect').value;
                    if (!taskGroupId) {
                        showFieldError('taskGroupSelect', 'Task group is required. All tasks must belong to a task group.');
                        return;
                    }
                    
                    targetType = 'groups';
                    targetGroups = [userGroupId];
                    targetUsers = [];
                    dueDate = null;
                }
                
                // Handle video based on selected option
                let videoUrl = null;
                let videoType = null;
                let videoStoragePath = null;
                
                const useUrl = document.getElementById('useVideoUrl').checked;
                
                if (useUrl) {
                    // Use URL input
                    videoUrl = document.getElementById('videoUrl').value.trim() || null;
                    videoType = videoUrl ? 'url' : null;
                } else {
                    // Use uploaded video if available
                    if (uploadedVideoUrl) {
                        videoUrl = uploadedVideoUrl;
                        videoType = 'upload';
                        videoStoragePath = uploadedVideoPath;
                        console.log('Using already uploaded video:', videoUrl);
                    }
                }
                
                // Only get next position for new tasks
                let position;
                if (currentTask && currentTask.position) {
                    // Editing existing task - keep current position
                    position = currentTask.position;
                } else {
                    // New task - get next position
                    position = await getNextPosition(taskGroupId ? parseInt(taskGroupId) : null);
                }
                
                const formData = {
                    task_id: document.getElementById('taskId').value.trim(),
                    title: document.getElementById('title').value.trim(),
                    description: document.getElementById('description').value.trim(),
                    instruction_title: document.getElementById('instructionTitle').value.trim(),
                    instruction_content: cleanContentForSaving(),
                    video_url: videoUrl,
                    video_type: videoType,
                    video_storage_path: videoStoragePath,
                    require_video_completion: document.getElementById('requireVideoCompletion')?.checked || false,
                    gate_next_task_on_video: document.getElementById('gateNextTaskOnVideo')?.checked || false,
                    form_embed_code: document.getElementById('hasFormEmbed').checked ? document.getElementById('formEmbedCode').value.trim() : null,
                    task_group_id: taskGroupId ? parseInt(taskGroupId) : null,
                    position: position,
                    target_type: targetType,
                    target_groups: targetGroups,
                    target_locations: [],
                    target_users: targetUsers,
                    due_date: dueDate,
                    is_active: true
                };

                console.log('Saving task:', formData);

                let result;
                if (currentTask) {
                    // Update existing task
                    result = await supabaseClient
                        .from('onboarding_tasks')
                        .update({
                            ...cleanDataForSupabase(formData),
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', currentTask.id)
                        .select();
                } else {
                    // Create new task
                    result = await supabaseClient
                        .from('onboarding_tasks')
                        .insert([cleanDataForSupabase(formData)])
                        .select();
                }

                const { data, error } = result;

                if (error) {
                    console.error('Save error:', error);
                    throw error;
                }

                console.log('Task saved:', data);
                console.log('Returned data structure:', {
                    data: data,
                    firstItem: data?.[0],
                    id: data?.[0]?.id
                });
                
                // If this is a new task with a task group, show the ordering modal
                if (!currentTask && taskGroupId) {
                    showSuccess('Task created successfully!');
                    
                    // Get the newly created task ID
                    const newTaskId = data && data[0] ? data[0].id : null;
                    
                    if (!newTaskId) {
                        console.error('New task ID not found in response:', data);
                        // If we don't have the ID, just reload and close without showing ordering
                        await loadTasks();
                        closeTaskModal();
                        return;
                    }
                    
                    // Reload tasks to get the latest data including the new task
                    await loadTasks();
                    closeTaskModal();
                    
                    console.log('Showing ordering modal for task group:', taskGroupId, 'new task ID:', newTaskId);
                    // Show task ordering modal with the correct new task ID
                    showTaskOrderingModal(taskGroupId, newTaskId);
                } else {
                    showSuccess(currentTask ? 'Task updated successfully!' : 'Task created successfully!');
                    // Reload tasks and close modal
                    await loadTasks();
                    setTimeout(closeTaskModal, 1500);
                }

            } catch (error) {
                console.error('Error saving task:', error);
                if (error.code === '23505') {
                    showError('Task ID already exists. Please choose a different ID.');
                } else {
                    showError('Failed to save task: ' + error.message);
                }
            }
        }

        // Toggle task active status
        async function toggleTaskActive(taskId, isActive) {
            try {
                console.log('Toggling task active:', taskId, isActive);
                
                const { error } = await supabaseClient
                    .from('onboarding_tasks')
                    .update({ 
                        is_active: isActive,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', taskId);

                if (error) {
                    console.error('Toggle error:', error);
                    throw error;
                }

                // Update local data
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    task.is_active = isActive;
                    renderTasks();
                }

                console.log('Task status updated successfully');
            } catch (error) {
                console.error('Error toggling task:', error);
                showError('Failed to update task status.');
            }
        }

        // Delete task
        async function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task? This action cannot be undone.')) {
                return;
            }

            try {
                console.log('Deleting task:', taskId);
                
                const { error } = await supabaseClient
                    .from('onboarding_tasks')
                    .delete()
                    .eq('id', taskId);

                if (error) {
                    console.error('Delete error:', error);
                    throw error;
                }

                console.log('Task deleted successfully');
                showSuccess('Task deleted successfully!');
                
                // Remove from local array and re-render
                tasks = tasks.filter(t => t.id !== taskId);
                renderTasks();

                // Close edit panel if deleting current task
                if (currentTask && currentTask.id === taskId) {
                    closeEditPanel();
                }

            } catch (error) {
                console.error('Error deleting task:', error);
                showError('Failed to delete task.');
            }
        }

        // Show error message
        function showError(message) {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="error">${message}</div>`;
            setTimeout(clearMessages, 5000);
        }

        // Show success message
        function showSuccess(message) {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="success">${message}</div>`;
        }

        // Clear messages
        function clearMessages() {
            document.getElementById('messageArea').innerHTML = '';
        }

        // Show field validation error
        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            if (!field) return;
            
            // Remove any existing error styling
            clearFieldErrors();
            
            // Add error styling to field
            field.style.borderColor = '#ef4444';
            field.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
            
            // Show error message
            showError(message);
            
            // Focus on the field
            field.focus();
            
            // Scroll field into view
            field.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Clear field validation errors
        function clearFieldErrors() {
            const fields = document.querySelectorAll('input, select, textarea');
            fields.forEach(field => {
                field.style.borderColor = '';
                field.style.boxShadow = '';
            });
        }


        // Initialize application
        async function init() {
            try {
                console.log('Starting application initialization...');
                
                // Check if Supabase library is loaded
                if (!window.supabase) {
                    console.error('Supabase library not loaded!');
                    showError('Failed to load Supabase library. Please refresh the page.');
                    return;
                }
                
                // Check if Supabase client is initialized
                if (!supabaseClient) {
                    console.error('Supabase client not initialized!');
                    showError('Failed to initialize Supabase client. Please check configuration.');
                    return;
                }
                
                console.log('Supabase client initialized, loading tasks...');
                
                // Load tasks (which also loads task groups)
                await loadTasks();
                
                
                // Ensure task groups are loaded for form population
                if (!allTaskGroupsData || allTaskGroupsData.length === 0) {
                    console.log('Loading task groups for form population...');
                    const { data: groupsData, error: groupsError } = await supabaseClient
                        .from('task_groups')
                        .select('*')
                        .order('display_order');
                    
                    if (!groupsError) {
                        allTaskGroupsData = groupsData || [];
                        console.log('Task groups loaded:', allTaskGroupsData.length);
                    } else {
                        console.error('Error loading task groups:', groupsError);
                    }
                }
                
                console.log('Application initialization complete')
                
                // Add form submit handler
                document.getElementById('taskForm').addEventListener('submit', saveTask);
                
                // Add field event listeners to clear validation errors on input
                const fieldsToWatch = ['title', 'description', 'individualUserSelect', 'userGroupSelect'];
                fieldsToWatch.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.addEventListener('input', clearFieldErrors);
                        field.addEventListener('change', clearFieldErrors);
                    }
                });
                
                console.log('Admin panel initialized successfully');
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('tasksList').innerHTML = '<div class="error">Failed to initialize admin panel. Please refresh the page.</div>';
            }
        }

        
        
        
        
        // Task Groups Management Functions
        let allTaskGroupsData = [];
        
        // Open task groups management panel (replace main view)
        async function openTaskGroups() {
            // Hide all panels
            document.getElementById('tasksPanel').style.display = 'none';
            document.getElementById('taskGroupsMainPanel').style.display = 'none';
            document.getElementById('taskSequencesPanel').style.display = 'none';
            document.getElementById('editPanel').style.display = 'none';
            
            // Show only task groups panel
            document.getElementById('taskGroupsMainPanel').style.display = 'block';
            document.getElementById('taskGroupsMainTitle').textContent = 'Task Groups Management';
            
            // Update page title
            document.querySelector('.page-title').textContent = 'Task Groups Management';
            
            // Update button to show "Back to Tasks"
            updateTaskGroupsButton(true);
            
            // Load task groups data
            await loadTaskGroupsMain();
            
            // Update navigation active states
            updateNavigationActive('task-groups');
        }

        async function openTaskSequences() {
            // Hide all panels
            document.getElementById('tasksPanel').style.display = 'none';
            document.getElementById('taskGroupsMainPanel').style.display = 'none';
            document.getElementById('taskSequencesPanel').style.display = 'none';
            document.getElementById('editPanel').style.display = 'none';
            
            // Show task sequences panel
            document.getElementById('taskSequencesPanel').style.display = 'block';
            
            // Update page title
            document.querySelector('.page-title').textContent = 'Task Sequences Management';
            
            // Load sequences data
            await loadTaskSequences();
            
            // Update navigation active states
            updateNavigationActive('task-sequences');
        }

        function updateNavigationActive(activeSection) {
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Add active class to appropriate nav link
            if (activeSection === 'task-groups') {
                document.querySelector('.nav-link[onclick="openTaskGroups()"]')?.classList.add('active');
            } else if (activeSection === 'task-sequences') {
                document.querySelector('.nav-link[onclick="openTaskSequences()"]')?.classList.add('active');
            }
        }

        // Back to tasks from groups
        function backToTasksFromGroups() {
            document.getElementById('taskGroupsMainPanel').style.display = 'none';
            document.getElementById('tasksPanel').style.display = 'block';
            updateTaskGroupsButton(false);
            document.querySelector('.page-title').textContent = 'Task Management';
        }

        // Go back to tasks (from DFY CRM title click)
        function goBackToTasks() {
            // Hide all panels except tasks
            document.getElementById('taskGroupsMainPanel').style.display = 'none';
            document.getElementById('taskSequencesPanel').style.display = 'none';
            document.getElementById('editPanel').style.display = 'none';
            document.getElementById('tasksPanel').style.display = 'block';
            
            // Update button and page title
            updateTaskGroupsButton(false);
            document.querySelector('.page-title').textContent = 'Task Management';
            
            // Clear navigation active states
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
        }

        // Toggle between Tasks and Task Groups panels
        function toggleTaskGroupsPanel() {
            const tasksPanel = document.getElementById('tasksPanel');
            const taskGroupsPanel = document.getElementById('taskGroupsMainPanel');
            
            if (taskGroupsPanel.style.display === 'block') {
                // Currently showing task groups, go back to tasks
                backToTasksFromGroups();
            } else {
                // Currently showing tasks, go to task groups
                openTaskGroups();
            }
        }

        // Update the task groups button text and function
        function updateTaskGroupsButton(isOnTaskGroups) {
            const button = document.getElementById('taskGroupsToggleBtn');
            if (isOnTaskGroups) {
                button.innerHTML = '<i data-lucide="arrow-left" style="width: 16px; height: 16px; margin-right: 6px;"></i>Back to Tasks';
                button.onclick = backToTasksFromGroups;
            } else {
                button.innerHTML = '<i data-lucide="folder" style="width: 16px; height: 16px; margin-right: 6px;"></i>Task Groups';
                button.onclick = toggleTaskGroupsPanel;
            }
            // Re-initialize icons after updating innerHTML
            lucide.createIcons();
        }

        // Main view functions for task groups
        async function loadTaskGroupsMain() {
            try {
                const { data, error } = await supabaseClient
                    .from('task_groups')
                    .select('*')
                    .order('display_order');

                if (error) throw error;
                
                allTaskGroupsData = data || [];
                renderTaskGroupsMain();
            } catch (error) {
                console.error('Error loading task groups:', error);
                document.getElementById('taskGroupsMainList').innerHTML = '<div class="error">Failed to load task groups</div>';
            }
        }

        // Render task groups in main view
        function renderTaskGroupsMain() {
            const taskGroupsList = document.getElementById('taskGroupsMainList');
            
            if (allTaskGroupsData.length === 0) {
                taskGroupsList.innerHTML = '<div class="loading">No task groups found. Create your first task group!</div>';
                return;
            }

            taskGroupsList.innerHTML = allTaskGroupsData.map((group, index) => {
                const cardColor = group.card_color || '#f8fafc';
                return `
                    <div class="group-card" style="background: ${cardColor}; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; margin-bottom: 12px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s; position: relative;">
                        <div style="display: flex; justify-content: between; align-items: flex-start; gap: 16px;">
                            <!-- Left section: Icon and main info -->
                            <div style="display: flex; align-items: flex-start; gap: 12px; flex: 1;">
                                <div style="margin-top: 2px;"><i data-lucide="folder" style="width: 24px; height: 24px; color: #4b5563;"></i></div>
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <h3 style="margin: 0; color: #1f2937; font-size: 18px; font-weight: 600;">${group.group_name}</h3>
                                        <span class="status-badge ${group.is_active ? 'active' : 'inactive'}" style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; ${group.is_active ? 'background: #dcfce7; color: #166534;' : 'background: #fef2f2; color: #dc2626;'}">${group.is_active ? 'Active' : 'Inactive'}</span>
                                    </div>
                                    <div style="color: #6b7280; font-size: 14px; margin-bottom: 8px;">
                                        Display Order: ${group.display_order}
                                    </div>
                                    <div style="color: #4b5563; font-size: 14px; line-height: 1.4;">
                                        ${group.group_description || '<em style="color: #9ca3af;">No description</em>'}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Right section: Actions -->
                            <div style="display: flex; gap: 8px; flex-shrink: 0;">
                                <button class="btn-small btn-edit" onclick="editTaskGroupMain(${group.id})" style="padding: 8px 12px; font-size: 13px;">Edit</button>
                                <button class="btn-small btn-primary" onclick="manageTasks(${group.id}, '${group.group_name.replace(/'/g, '\\\'')}')" style="padding: 8px 12px; font-size: 13px;">Manage Tasks</button>
                            </div>
                        </div>
                        
                        <!-- Separator line (except for last item) -->
                        ${index < allTaskGroupsData.length - 1 ? '<div style="position: absolute; bottom: -6px; left: 20px; right: 20px; height: 1px; background: linear-gradient(to right, rgba(0,0,0,0.1), transparent);"></div>' : ''}
                    </div>
                `;
            }).join('');
            
            // Refresh icons for dynamically created content
            setTimeout(() => lucide.createIcons(), 100);
        }

        // Create new task group in main view
        function createNewTaskGroupMain() {
            console.log('createNewTaskGroupMain called');
            
            // Hide main panel
            document.getElementById('taskGroupsMainPanel').style.display = 'none';
            
            const container = document.getElementById('container');
            const editPanel = document.getElementById('editPanel');
            
            // Make edit panel a centered modal
            editPanel.style.position = 'fixed';
            editPanel.style.top = '50%';
            editPanel.style.left = '50%';
            editPanel.style.transform = 'translate(-50%, -50%)';
            editPanel.style.width = '600px';
            editPanel.style.maxWidth = '90vw';
            editPanel.style.maxHeight = '80vh';
            editPanel.style.overflowY = 'auto';
            editPanel.style.zIndex = '1000';
            editPanel.style.display = 'block';
            editPanel.style.visibility = 'visible';
            editPanel.style.opacity = '1';
            editPanel.style.background = 'white';
            editPanel.style.padding = '24px';
            editPanel.style.borderRadius = '12px';
            editPanel.style.boxShadow = '0 10px 25px rgba(0, 0, 0, 0.2)';
            editPanel.style.border = '1px solid #E5E7EB';
            
            // Add dark overlay behind modal
            const overlay = document.createElement('div');
            overlay.id = 'modalOverlay';
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            overlay.style.zIndex = '999';
            overlay.onclick = () => cancelTaskGroupForm();
            document.body.appendChild(overlay);
            
            document.getElementById('editTitle').textContent = 'Create New Task Group';
            
            // Override the close button to call our cancel function
            const closeBtn = editPanel.querySelector('.close-btn');
            if (closeBtn) {
                closeBtn.onclick = cancelTaskGroupForm;
            }
            
            // Show task group form in edit panel
            showTaskGroupFormInEditPanel();
        }

        // Edit task group in main view
        function editTaskGroupMain(groupId) {
            console.log('editTaskGroupMain called with ID:', groupId);
            
            const group = allTaskGroupsData.find(g => g.id === groupId);
            if (!group) return;

            // Hide main panel
            document.getElementById('taskGroupsMainPanel').style.display = 'none';
            
            const container = document.getElementById('container');
            const editPanel = document.getElementById('editPanel');
            
            // Make edit panel a centered modal
            editPanel.style.position = 'fixed';
            editPanel.style.top = '50%';
            editPanel.style.left = '50%';
            editPanel.style.transform = 'translate(-50%, -50%)';
            editPanel.style.width = '600px';
            editPanel.style.maxWidth = '90vw';
            editPanel.style.maxHeight = '80vh';
            editPanel.style.overflowY = 'auto';
            editPanel.style.zIndex = '1000';
            editPanel.style.display = 'block';
            editPanel.style.visibility = 'visible';
            editPanel.style.opacity = '1';
            editPanel.style.background = 'white';
            editPanel.style.padding = '24px';
            editPanel.style.borderRadius = '12px';
            editPanel.style.boxShadow = '0 10px 25px rgba(0, 0, 0, 0.2)';
            editPanel.style.border = '1px solid #E5E7EB';
            
            // Add dark overlay behind modal
            const overlay = document.createElement('div');
            overlay.id = 'modalOverlay';
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            overlay.style.zIndex = '999';
            overlay.onclick = () => cancelTaskGroupForm();
            document.body.appendChild(overlay);
            
            document.getElementById('editTitle').textContent = 'Edit Task Group';
            
            // Override the close button to call our cancel function
            const closeBtn = editPanel.querySelector('.close-btn');
            if (closeBtn) {
                closeBtn.onclick = cancelTaskGroupForm;
            }
            
            // Show task group form in edit panel with data
            showTaskGroupFormInEditPanel(group);
        }

        // Manage tasks for a task group
        function manageTasks(groupId, groupName) {
            console.log('manageTasks called for group:', groupName);
            
            currentAssignmentGroupId = groupId;
            
            // Hide main panel
            document.getElementById('taskGroupsMainPanel').style.display = 'none';
            
            const container = document.getElementById('container');
            const editPanel = document.getElementById('editPanel');
            
            // Make edit panel a larger modal for task management
            editPanel.style.position = 'fixed';
            editPanel.style.top = '50%';
            editPanel.style.left = '50%';
            editPanel.style.transform = 'translate(-50%, -50%)';
            editPanel.style.width = '1000px';
            editPanel.style.maxWidth = '98vw';
            editPanel.style.maxHeight = '90vh';
            editPanel.style.overflowY = 'auto';
            editPanel.style.zIndex = '1000';
            editPanel.style.display = 'block';
            editPanel.style.visibility = 'visible';
            editPanel.style.opacity = '1';
            editPanel.style.background = 'white';
            editPanel.style.padding = '24px';
            editPanel.style.borderRadius = '12px';
            editPanel.style.boxShadow = '0 10px 25px rgba(0, 0, 0, 0.2)';
            editPanel.style.border = '1px solid #E5E7EB';
            
            // Add dark overlay behind modal
            const overlay = document.createElement('div');
            overlay.id = 'modalOverlay';
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            overlay.style.zIndex = '999';
            overlay.onclick = () => cancelTaskGroupForm();
            document.body.appendChild(overlay);
            
            document.getElementById('editTitle').textContent = `Manage Tasks: ${groupName}`;
            
            // Override the close button to call our cancel function
            const closeBtn = editPanel.querySelector('.close-btn');
            if (closeBtn) {
                closeBtn.onclick = cancelTaskGroupForm;
            }
            
            // Show task management interface
            showTaskManagementInterface(groupId, groupName);
        }

        // Sequences management in main view
        async function manageSequencesMain() {
            document.getElementById('taskGroupsMainView').style.display = 'none';
            document.getElementById('sequencesMainView').style.display = 'block';
            document.getElementById('taskGroupsMainTitle').textContent = 'Task Group Sequences';
            
            await loadSequencesMain();
        }

        // Back to task groups from sequences
        function backToTaskGroupsMain() {
            document.getElementById('sequencesMainView').style.display = 'none';
            document.getElementById('taskGroupsMainView').style.display = 'block';
            document.getElementById('taskGroupsMainTitle').textContent = 'Task Groups';
        }

        // Load sequences for main view
        async function loadSequencesMain() {
            try {
                const { data, error } = await supabaseClient
                    .from('task_group_sequences')
                    .select(`
                        *,
                        prerequisite_group:prerequisite_group_id(group_name),
                        unlock_group:unlock_group_id(group_name)
                    `)
                    .order('created_at');

                if (error) throw error;

                allSequences = data || [];
                renderSequencesMain();
            } catch (error) {
                console.error('Error loading sequences:', error);
                document.getElementById('sequencesMainList').innerHTML = '<div class="error">Failed to load sequences</div>';
            }
        }

        // Render sequences in main view
        function renderSequencesMain() {
            const sequencesList = document.getElementById('sequencesMainList');

            if (allSequences.length === 0) {
                sequencesList.innerHTML = '<div class="loading">No sequences configured. Create your first sequence to set up conditional task group flows!</div>';
                return;
            }

            sequencesList.innerHTML = allSequences.map((sequence, index) => {
                const prerequisiteName = sequence.prerequisite_group?.group_name || 'Unknown Group';
                const unlockName = sequence.unlock_group?.group_name || 'Unknown Group';
                const cardColor = sequence.card_color || '#fef7f0';
                
                return `
                    <div class="sequence-card" style="background: ${cardColor}; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; margin-bottom: 12px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s; position: relative;">
                        <div style="display: flex; justify-content: between; align-items: flex-start; gap: 16px;">
                            <!-- Left section: Icon and main info -->
                            <div style="display: flex; align-items: flex-start; gap: 12px; flex: 1;">
                                <div style="margin-top: 2px;"><i data-lucide="workflow" style="width: 24px; height: 24px; color: #4b5563;"></i></div>
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <h3 style="margin: 0; color: #1f2937; font-size: 18px; font-weight: 600;">${sequence.sequence_name}</h3>
                                        <span class="status-badge ${sequence.is_active ? 'active' : 'inactive'}" style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; ${sequence.is_active ? 'background: #dcfce7; color: #166534;' : 'background: #fef2f2; color: #dc2626;'}">${sequence.is_active ? 'Active' : 'Inactive'}</span>
                                    </div>
                                    <div style="color: #4b5563; font-size: 14px; line-height: 1.4; margin-bottom: 12px;">
                                        ${sequence.description || '<em style="color: #9ca3af;">No description</em>'}
                                    </div>
                                    <div style="background: rgba(255,255,255,0.4); border: 1px solid rgba(0,0,0,0.1); border-radius: 6px; padding: 12px; font-size: 13px; color: #374151;">
                                        <strong>Flow:</strong> Complete "<span style="color: #059669; font-weight: 600;">${prerequisiteName}</span>" → Unlock "<span style="color: #0284c7; font-weight: 600;">${unlockName}</span>"
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Right section: Actions -->
                            <div style="display: flex; gap: 8px; flex-shrink: 0;">
                                <button class="btn-small btn-edit" onclick="editSequenceMain(${sequence.id})" style="padding: 8px 12px; font-size: 13px;">Edit</button>
                            </div>
                        </div>
                        
                        <!-- Separator line (except for last item) -->
                        ${index < allSequences.length - 1 ? '<div style="position: absolute; bottom: -6px; left: 20px; right: 20px; height: 1px; background: linear-gradient(to right, rgba(0,0,0,0.1), transparent);"></div>' : ''}
                    </div>
                `;
            }).join('');
            
            // Refresh icons for dynamically created content
            setTimeout(() => lucide.createIcons(), 100);
        }

        // Create new sequence in main view
        function createNewSequenceMain() {
            // Switch to edit panel
            document.getElementById('taskGroupsMainPanel').style.display = 'none';
            document.getElementById('editPanel').style.display = 'block';
            document.getElementById('editTitle').textContent = 'Create New Sequence';
            
            // Show sequence form in edit panel
            showSequenceFormInEditPanel();
        }

        // Edit sequence in main view
        function editSequenceMain(sequenceId) {
            const sequence = allSequences.find(s => s.id === sequenceId);
            if (!sequence) return;

            // Switch to edit panel
            document.getElementById('taskGroupsMainPanel').style.display = 'none';
            document.getElementById('editPanel').style.display = 'block';
            document.getElementById('editTitle').textContent = 'Edit Sequence';
            
            // Show sequence form in edit panel with data
            showSequenceFormInEditPanel(sequence);
        }

        // Show forms in edit panel functions
        async function showTaskGroupFormInEditPanel(group = null) {
            // First, load user groups for the dropdown
            const { data: userGroups, error } = await supabaseClient
                .from('user_groups')
                .select('*')
                .order('group_name', { ascending: true });
            
            if (error) {
                console.error('Error loading user groups:', error);
                showError('Failed to load user groups');
                return;
            }
            
            const editPanelContent = document.querySelector('#editPanel form');
            editPanelContent.innerHTML = `
                <input type="hidden" id="editTaskGroupId" value="${group ? group.id : ''}">
                <div class="form-group">
                    <label for="editTaskGroupUserGroup">User Group <span style="color: red;">*</span></label>
                    <select id="editTaskGroupUserGroup" class="filter-select" required>
                        <option value="">Select a user group...</option>
                        ${userGroups.map(ug => `
                            <option value="${ug.id}" ${group && group.user_group_id === ug.id ? 'selected' : ''}>
                                ${ug.group_name}
                            </option>
                        `).join('')}
                    </select>
                    <small style="color: #ef4444;">Required: Task groups must belong to a user group</small>
                </div>
                <div class="form-group">
                    <label for="editTaskGroupName">Task Group Name <span style="color: red;">*</span></label>
                    <input type="text" id="editTaskGroupName" value="${group ? group.group_name : ''}" required>
                    <small>Name for this task group (e.g., "Onboarding Tasks", "Advanced Training")</small>
                </div>
                <div class="form-group">
                    <label for="editTaskGroupDescription">Description</label>
                    <textarea id="editTaskGroupDescription">${group ? (group.group_description || '') : ''}</textarea>
                    <small>Description of what this task group contains</small>
                </div>
                <div class="form-group">
                    <label for="editTaskGroupOrder">Display Order</label>
                    <input type="number" id="editTaskGroupOrder" min="0" step="1" value="${group ? group.display_order : allTaskGroupsData.length}">
                    <small>Order in which this group should appear (0 = first)</small>
                </div>
                <div class="form-group">
                    <label for="editTaskGroupActive">Status</label>
                    <div class="toggle-container">
                        <label class="toggle-switch">
                            <input type="checkbox" id="editTaskGroupActive" ${group ? (group.is_active ? 'checked' : '') : 'checked'}>
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">Active</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editTaskGroupColor">Card Color</label>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <input type="color" id="editTaskGroupColor" value="${group ? (group.card_color || '#f8fafc') : '#f8fafc'}" style="width: 50px; height: 40px; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                        <div style="flex: 1;">
                            <input type="text" id="editTaskGroupColorText" value="${group ? (group.card_color || '#f8fafc') : '#f8fafc'}" style="width: 100px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-family: monospace;" onchange="updateColorPicker('editTaskGroupColor', this.value)">
                            <small style="display: block; margin-top: 4px;">Choose a light background color for the task group card</small>
                        </div>
                        <div id="colorPreview" style="width: 60px; height: 40px; border: 1px solid #e5e7eb; border-radius: 6px; background: ${group ? (group.card_color || '#f8fafc') : '#f8fafc'};"></div>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
                        <button type="button" onclick="setGroupColor('#f8fafc')" style="width: 24px; height: 24px; border: 1px solid #ccc; border-radius: 4px; background: #f8fafc; cursor: pointer;" title="Light Gray"></button>
                        <button type="button" onclick="setGroupColor('#fef7f0')" style="width: 24px; height: 24px; border: 1px solid #ccc; border-radius: 4px; background: #fef7f0; cursor: pointer;" title="Light Orange"></button>
                        <button type="button" onclick="setGroupColor('#f0f9ff')" style="width: 24px; height: 24px; border: 1px solid #ccc; border-radius: 4px; background: #f0f9ff; cursor: pointer;" title="Light Blue"></button>
                        <button type="button" onclick="setGroupColor('#ecfdf5')" style="width: 24px; height: 24px; border: 1px solid #ccc; border-radius: 4px; background: #ecfdf5; cursor: pointer;" title="Light Green"></button>
                        <button type="button" onclick="setGroupColor('#fef2f2')" style="width: 24px; height: 24px; border: 1px solid #ccc; border-radius: 4px; background: #fef2f2; cursor: pointer;" title="Light Red"></button>
                        <button type="button" onclick="setGroupColor('#faf5ff')" style="width: 24px; height: 24px; border: 1px solid #ccc; border-radius: 4px; background: #faf5ff; cursor: pointer;" title="Light Purple"></button>
                        <button type="button" onclick="setGroupColor('#fffbeb')" style="width: 24px; height: 24px; border: 1px solid #ccc; border-radius: 4px; background: #fffbeb; cursor: pointer;" title="Light Yellow"></button>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Task Group</button>
                    <button type="button" class="btn btn-secondary" onclick="cancelEditPanelForm()">Cancel</button>
                    ${group ? '<button type="button" class="btn btn-danger" onclick="deleteTaskGroupMain()">Delete</button>' : ''}
                </div>
            `;
            
            // Add form submission handler
            editPanelContent.onsubmit = saveTaskGroupFromEditPanel;
        }

        // Cancel edit panel form
        function cancelEditPanelForm() {
            document.getElementById('editPanel').style.display = 'none';
            document.getElementById('taskGroupsMainPanel').style.display = 'block';
        }

        // Save task group from edit panel
        async function saveTaskGroupFromEditPanel(e) {
            e.preventDefault();
            
            // Clear any previous field errors
            clearFieldErrors();
            
            try {
                const groupId = document.getElementById('editTaskGroupId').value;
                const userGroupId = document.getElementById('editTaskGroupUserGroup').value;
                const groupName = document.getElementById('editTaskGroupName').value.trim();
                
                // Validate required fields
                if (!userGroupId) {
                    showFieldError('editTaskGroupUserGroup', 'Please select a user group. Task groups must belong to a user group.');
                    return;
                }
                
                if (!groupName) {
                    showFieldError('editTaskGroupName', 'Task group name is required');
                    return;
                }
                
                const formData = {
                    group_name: document.getElementById('editTaskGroupName').value,
                    group_description: document.getElementById('editTaskGroupDescription').value,
                    user_group_id: parseInt(userGroupId),
                    display_order: parseInt(document.getElementById('editTaskGroupOrder').value) || 0,
                    is_active: document.getElementById('editTaskGroupActive').checked,
                    card_color: document.getElementById('editTaskGroupColor').value,
                    updated_at: new Date().toISOString()
                };

                let data, error;

                if (groupId) {
                    // Update existing task group
                    const result = await supabaseClient
                        .from('task_groups')
                        .update(formData)
                        .eq('id', groupId)
                        .select();
                    data = result.data;
                    error = result.error;
                } else {
                    // Create new task group
                    formData.created_at = new Date().toISOString();
                    const result = await supabaseClient
                        .from('task_groups')
                        .insert([formData])
                        .select();
                    data = result.data;
                    error = result.error;
                }

                if (error) throw error;

                showSuccess(groupId ? 'Task group updated successfully!' : 'Task group created successfully!');
                await loadTaskGroupsMain();
                setTimeout(() => {
                    document.getElementById('editPanel').style.display = 'none';
                    document.getElementById('taskGroupsMainPanel').style.display = 'block';
                }, 1500);

            } catch (error) {
                console.error('Error saving task group:', error);
                showError('Failed to save task group: ' + error.message);
            }
        }

        // Delete task group from main view
        async function deleteTaskGroupMain() {
            const groupId = document.getElementById('editTaskGroupId').value;
            if (!groupId) return;

            const group = allTaskGroupsData.find(g => g.id === parseInt(groupId));
            if (!confirm(`Are you sure you want to delete the task group "${group.group_name}"? This will also remove all task assignments to this group.`)) {
                return;
            }

            try {
                // First, remove task_group_id from all tasks that belong to this group
                const { error: updateError } = await supabaseClient
                    .from('onboarding_tasks')
                    .update({ task_group_id: null })
                    .eq('task_group_id', groupId);

                if (updateError) {
                    console.error('Error updating tasks:', updateError);
                    throw updateError;
                }

                // Now delete the task group
                const { error: deleteError } = await supabaseClient
                    .from('task_groups')
                    .delete()
                    .eq('id', groupId);

                if (deleteError) throw deleteError;

                showSuccess('Task group deleted successfully!');
                await loadTaskGroupsMain();
                
                // Remove any modal overlay and close panels
                const taskOverlay = document.getElementById('taskModalOverlay');
                if (taskOverlay) {
                    document.body.removeChild(taskOverlay);
                }
                const modalOverlay = document.getElementById('modalOverlay');
                if (modalOverlay) {
                    document.body.removeChild(modalOverlay);
                }
                document.getElementById('editPanel').style.display = 'none';
                document.getElementById('taskGroupsMainPanel').style.display = 'block';
            } catch (error) {
                console.error('Error deleting task group:', error);
                showError('Failed to delete task group: ' + error.message);
            }
        }

        // Show task assignment in edit panel
        async function showTaskAssignmentInEditPanel(groupId) {
            try {
                const { data: allTasks, error } = await supabaseClient
                    .from('onboarding_tasks')
                    .select('*')
                    .order('position');

                if (error) throw error;

                const editPanelContent = document.querySelector('#editPanel form');
                
                if (!allTasks || allTasks.length === 0) {
                    editPanelContent.innerHTML = `
                        <div class="loading">No tasks available for assignment</div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="cancelEditPanelForm()">Back</button>
                        </div>
                    `;
                    return;
                }

                editPanelContent.innerHTML = `
                    <div class="form-group">
                        <label>Available Tasks</label>
                        <div id="editPanelTasksList" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
                            ${allTasks.map(task => {
                                const isAssigned = task.task_group_id === groupId;
                                return `
                                    <label style="display: block; margin-bottom: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
                                        <input type="checkbox" value="${task.id}" ${isAssigned ? 'checked' : ''} style="margin-right: 8px;">
                                        <strong>${task.title}</strong>
                                        <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                            Position: ${task.position}
                                        </div>
                                    </label>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-primary" onclick="saveTaskAssignmentsFromEditPanel()">Save Assignments</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelEditPanelForm()">Cancel</button>
                    </div>
                `;

            } catch (error) {
                console.error('Error loading tasks for assignment:', error);
                const editPanelContent = document.querySelector('#editPanel form');
                editPanelContent.innerHTML = `
                    <div class="error">Failed to load tasks</div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="cancelEditPanelForm()">Back</button>
                    </div>
                `;
            }
        }

        // Save task assignments from edit panel
        async function saveTaskAssignmentsFromEditPanel() {
            try {
                const checkboxes = document.querySelectorAll('#editPanelTasksList input[type="checkbox"]');
                const selectedTaskIds = [];
                const unselectedTaskIds = [];

                checkboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        selectedTaskIds.push(parseInt(checkbox.value));
                    } else {
                        unselectedTaskIds.push(parseInt(checkbox.value));
                    }
                });

                // Assign selected tasks to the group
                if (selectedTaskIds.length > 0) {
                    const { error: assignError } = await supabaseClient
                        .from('onboarding_tasks')
                        .update({ task_group_id: currentAssignmentGroupId })
                        .in('id', selectedTaskIds);

                    if (assignError) throw assignError;
                }

                // Remove unselected tasks from the group
                if (unselectedTaskIds.length > 0) {
                    const { error: unassignError } = await supabaseClient
                        .from('onboarding_tasks')
                        .update({ task_group_id: null })
                        .in('id', unselectedTaskIds)
                        .eq('task_group_id', currentAssignmentGroupId);

                    if (unassignError) throw unassignError;
                }

                showSuccess('Task assignments updated successfully!');
                setTimeout(() => {
                    document.getElementById('editPanel').style.display = 'none';
                    document.getElementById('taskGroupsMainPanel').style.display = 'block';
                    loadTasks(); // Reload main tasks view to show changes
                }, 1500);

            } catch (error) {
                console.error('Error saving task assignments:', error);
                showError('Failed to save task assignments: ' + error.message);
            }
        }

        // Show task management interface
        async function showTaskManagementInterface(groupId, groupName) {
            try {
                // Load existing tasks for this group
                const { data: groupTasks, error: groupError } = await supabaseClient
                    .from('onboarding_tasks')
                    .select('*')
                    .eq('task_group_id', groupId)
                    .order('position');

                if (groupError) throw groupError;

                // Load all tasks for dropdown
                const { data: allTasks, error: allError } = await supabaseClient
                    .from('onboarding_tasks')
                    .select('*')
                    .order('position');

                if (allError) throw allError;

                const editPanelContent = document.querySelector('#editPanel form');
                
                editPanelContent.innerHTML = `
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px;">
                        <!-- Left Column: Current Tasks -->
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 style="margin: 0;">Tasks in "${groupName}"</h3>
                                <div style="display: flex; gap: 8px;">
                                    <button type="button" class="btn btn-secondary" onclick="showTaskOrderingModal(${groupId}, null)">🔄 Reorder Tasks</button>
                                    <button type="button" class="btn btn-primary" onclick="showCreateTaskForm(${groupId})">+ Create New Task</button>
                                </div>
                            </div>
                            
                            <div id="currentTasksList" style="min-height: 200px; border: 2px dashed #E5E7EB; border-radius: 8px; padding: 16px;">
                                ${groupTasks && groupTasks.length > 0 ? 
                                    `<div style="margin-bottom: 12px; padding: 8px; background: #EBF5FF; border: 1px solid #3B82F6; border-radius: 4px; font-size: 13px; color: #1E40AF;">
                                        <strong>${groupTasks.length} task${groupTasks.length !== 1 ? 's' : ''}</strong> in this group
                                    </div>` +
                                    groupTasks.map((task, index) => `
                                        <div class="task-item" data-task-id="${task.id}" style="background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 6px; padding: 12px; margin-bottom: 8px; cursor: move; transition: all 0.2s;">
                                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                                <div style="flex: 1;">
                                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                                        <span style="color: #6B7280; font-size: 14px;">⋮⋮</span>
                                                        <strong style="color: #374151;">${task.title || task.task_title || 'Untitled Task'}</strong>
                                                    </div>
                                                    <div style="font-size: 12px; color: #6B7280; margin-bottom: 8px;">
                                                        Position: ${task.position} | ID: ${task.task_id || task.id}
                                                    </div>
                                                    <div style="font-size: 13px; color: #4B5563; line-height: 1.4;">
                                                        ${task.description ? task.description.substring(0, 100) + (task.description.length > 100 ? '...' : '') : 'No description'}
                                                    </div>
                                                </div>
                                                <div style="display: flex; gap: 4px;">
                                                    <button type="button" class="btn btn-small btn-edit" onclick="editTaskInGroup(${task.id})" style="padding: 4px 8px; font-size: 12px;">Edit</button>
                                                    <button type="button" class="btn btn-small btn-danger" onclick="removeTaskFromGroup(${task.id})" style="padding: 4px 8px; font-size: 12px;">Remove</button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('') 
                                    : '<div style="text-align: center; color: #9CA3AF; padding: 40px;">No tasks in this group yet.<br>Create a new task or add existing tasks from the right panel.</div>'
                                }
                            </div>
                            
                            <div style="margin-top: 16px; padding: 12px; background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 6px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <span style="font-size: 16px;">🔄</span>
                                    <strong style="color: #92400E;">Drag & Drop Ordering</strong>
                                </div>
                                <p style="color: #92400E; margin: 0; font-size: 14px;">
                                    Drag tasks up or down to reorder them. The order here determines how they appear to users in the onboarding flow.
                                </p>
                            </div>
                        </div>

                        <!-- Right Column: Add Existing Tasks -->
                        <div>
                            <h4 style="margin: 0 0 16px 0; color: #374151;">Add Existing Tasks</h4>
                            
                            <div class="form-group" style="margin-bottom: 16px;">
                                <label for="existingTaskSelect" style="display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px;">Choose from existing tasks:</label>
                                <select id="existingTaskSelect" style="width: 100%; padding: 8px; border: 1px solid #E5E7EB; border-radius: 4px; font-size: 14px;">
                                    <option value="">Select a task to add...</option>
                                    ${allTasks ? allTasks.filter(task => !task.task_group_id || task.task_group_id !== groupId).map(task => 
                                        `<option value="${task.id}">${task.title}</option>`
                                    ).join('') : ''}
                                </select>
                                <button type="button" class="btn btn-secondary" onclick="addExistingTaskToGroup()" style="width: 100%; margin-top: 8px; padding: 8px;">Add Selected Task</button>
                            </div>

                            <div style="border-top: 1px solid #E5E7EB; padding-top: 16px; margin-top: 16px;">
                                <h4 style="margin: 0 0 12px 0; color: #374151; font-size: 14px;">Quick Actions</h4>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <button type="button" class="btn btn-secondary" onclick="reorderTasksByTitle()" style="padding: 8px; font-size: 13px;">Sort Alphabetically</button>
                                    <button type="button" class="btn btn-secondary" onclick="resetTaskPositions()" style="padding: 8px; font-size: 13px;">Reset Positions (1,2,3...)</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions" style="margin-top: 24px; border-top: 1px solid #E5E7EB; padding-top: 16px;">
                        <button type="button" class="btn btn-secondary" onclick="cancelTaskGroupForm()">Close</button>
                    </div>
                `;

                // Initialize drag and drop functionality
                initTaskDragAndDrop();

            } catch (error) {
                console.error('Error loading task management interface:', error);
                const editPanelContent = document.querySelector('#editPanel form');
                editPanelContent.innerHTML = `
                    <div class="error">Failed to load task management interface: ${error.message}</div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="cancelTaskGroupForm()">Close</button>
                    </div>
                `;
            }
        }

        // Show sequence form in edit panel (simplified version)
        async function showSequenceFormInEditPanel(sequence = null) {
            // Load task groups for dropdowns
            await loadTaskGroupsMain();
            
            const editPanelContent = document.querySelector('#editPanel form');
            
            const taskGroupOptions = allTaskGroupsData.map(group => 
                `<option value="${group.id}" ${sequence && sequence.prerequisite_group_id === group.id ? 'selected' : ''}>${group.group_name}</option>`
            ).join('');
            
            const unlockGroupOptions = allTaskGroupsData.map(group => 
                `<option value="${group.id}" ${sequence && sequence.unlock_group_id === group.id ? 'selected' : ''}>${group.group_name}</option>`
            ).join('');
            
            editPanelContent.innerHTML = `
                <input type="hidden" id="editSequenceId" value="${sequence ? sequence.id : ''}">
                <div class="form-group">
                    <label for="editSequenceName">Sequence Name</label>
                    <input type="text" id="editSequenceName" value="${sequence ? sequence.sequence_name : ''}" required>
                    <small>Name for this sequence rule (e.g., "Basic to Advanced Onboarding")</small>
                </div>
                <div class="form-group">
                    <label for="editSequenceDescription">Description</label>
                    <textarea id="editSequenceDescription">${sequence ? (sequence.description || '') : ''}</textarea>
                    <small>Description of what this sequence does</small>
                </div>
                <div class="form-group">
                    <label for="editPrerequisiteGroup">Prerequisite Group</label>
                    <select id="editPrerequisiteGroup" required>
                        <option value="">Select group that must be completed first...</option>
                        ${taskGroupOptions}
                    </select>
                    <small>When ALL tasks in this group are completed...</small>
                </div>
                <div class="form-group">
                    <label for="editUnlockGroup">Unlock Group</label>
                    <select id="editUnlockGroup" required>
                        <option value="">Select group to unlock...</option>
                        ${unlockGroupOptions}
                    </select>
                    <small>...this group will be shown to the user</small>
                </div>
                <div class="form-group">
                    <label for="editSequenceActive">Status</label>
                    <div class="toggle-container">
                        <label class="toggle-switch">
                            <input type="checkbox" id="editSequenceActive" ${sequence ? (sequence.is_active ? 'checked' : '') : 'checked'}>
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">Active</span>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Sequence</button>
                    <button type="button" class="btn btn-secondary" onclick="cancelEditPanelForm()">Cancel</button>
                    ${sequence ? '<button type="button" class="btn btn-danger" onclick="deleteSequenceMain()">Delete</button>' : ''}
                </div>
            `;
            
            // Add form submission handler
            editPanelContent.onsubmit = saveSequenceFromEditPanel;
        }

        // Save sequence from edit panel
        async function saveSequenceFromEditPanel(e) {
            e.preventDefault();
            
            try {
                const sequenceId = document.getElementById('editSequenceId').value;
                const formData = {
                    sequence_name: document.getElementById('editSequenceName').value,
                    description: document.getElementById('editSequenceDescription').value,
                    prerequisite_group_id: parseInt(document.getElementById('editPrerequisiteGroup').value),
                    unlock_group_id: parseInt(document.getElementById('editUnlockGroup').value),
                    applies_to: 'all',
                    target_groups: [],
                    is_active: document.getElementById('editSequenceActive').checked,
                    updated_at: new Date().toISOString()
                };

                let data, error;
                if (sequenceId) {
                    const result = await supabaseClient.from('task_group_sequences').update(formData).eq('id', sequenceId).select();
                    data = result.data; error = result.error;
                } else {
                    formData.created_at = new Date().toISOString();
                    const result = await supabaseClient.from('task_group_sequences').insert([formData]).select();
                    data = result.data; error = result.error;
                }

                if (error) throw error;
                showSuccess(sequenceId ? 'Sequence updated successfully!' : 'Sequence created successfully!');
                await loadSequencesMain();
                setTimeout(() => {
                    document.getElementById('editPanel').style.display = 'none';
                    document.getElementById('taskGroupsMainPanel').style.display = 'block';
                    document.getElementById('sequencesMainView').style.display = 'block';
                    document.getElementById('taskGroupsMainView').style.display = 'none';
                }, 1500);
            } catch (error) {
                console.error('Error saving sequence:', error);
                showError('Failed to save sequence: ' + error.message);
            }
        }

        // Delete sequence from main view
        async function deleteSequenceMain() {
            const sequenceId = document.getElementById('editSequenceId').value;
            if (!sequenceId) return;
            const sequence = allSequences.find(s => s.id === parseInt(sequenceId));
            if (!confirm(`Are you sure you want to delete the sequence "${sequence.sequence_name}"?`)) return;

            try {
                const { error } = await supabaseClient.from('task_group_sequences').delete().eq('id', sequenceId);
                if (error) throw error;
                showSuccess('Sequence deleted successfully!');
                await loadSequencesMain();
                document.getElementById('editPanel').style.display = 'none';
                document.getElementById('taskGroupsMainPanel').style.display = 'block';
                document.getElementById('sequencesMainView').style.display = 'block';
                document.getElementById('taskGroupsMainView').style.display = 'none';
            } catch (error) {
                console.error('Error deleting sequence:', error);
                showError('Failed to delete sequence: ' + error.message);
            }
        }

        // Close task groups panel
        function closeTaskGroupsPanel() {
            // Remove any modal overlay that might be present
            const taskOverlay = document.getElementById('taskModalOverlay');
            if (taskOverlay) {
                document.body.removeChild(taskOverlay);
            }
            const modalOverlay = document.getElementById('modalOverlay');
            if (modalOverlay) {
                document.body.removeChild(modalOverlay);
            }
            
            document.getElementById('taskGroupsPanel').style.display = 'none';
            document.getElementById('taskGroupForm').style.display = 'none';
            document.getElementById('taskAssignmentForm').style.display = 'none';
        }

        // Load task groups from database
        async function loadTaskGroups() {
            try {
                const { data, error } = await supabaseClient
                    .from('task_groups')
                    .select('*')
                    .order('display_order');

                if (error) throw error;
                
                allTaskGroupsData = data || [];
                renderTaskGroups();
            } catch (error) {
                console.error('Error loading task groups:', error);
                document.getElementById('taskGroupsList').innerHTML = '<div class="error">Failed to load task groups</div>';
            }
        }

        // Render task groups list
        function renderTaskGroups() {
            const taskGroupsList = document.getElementById('taskGroupsList');
            
            if (allTaskGroupsData.length === 0) {
                taskGroupsList.innerHTML = '<div class="loading">No task groups found. Create your first task group!</div>';
                return;
            }

            taskGroupsList.innerHTML = allTaskGroupsData.map(group => {
                return `
                    <div class="webhook-item">
                        <div class="webhook-item-header">
                            <div class="webhook-name">📋 ${group.group_name}</div>
                            <div class="webhook-status ${group.is_active ? 'active' : 'inactive'}">
                                ${group.is_active ? 'Active' : 'Inactive'}
                            </div>
                        </div>
                        <div class="webhook-description">${group.group_description || 'No description'}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 4px;">
                            🔢 Display Order: ${group.display_order}
                        </div>
                        <div class="webhook-actions">
                            <button class="btn-small btn-edit" onclick="editTaskGroup(${group.id})">Edit</button>
                            <button class="btn-small btn-primary" onclick="assignTasks(${group.id}, '${group.group_name}')">Assign Tasks</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Create new task group
        async function createNewTaskGroup() {
            // Load user groups for dropdown
            await loadUserGroupsForTaskGroupForm();
            
            // Clear form for new task group
            document.getElementById('taskGroupId').value = '';
            document.getElementById('taskGroupUserGroupSelect').value = '';
            document.getElementById('taskGroupName').value = '';
            document.getElementById('taskGroupDescription').value = '';
            document.getElementById('taskGroupOrder').value = allTaskGroupsData.length;
            document.getElementById('taskGroupActive').checked = true;

            document.getElementById('taskGroupFormTitle').textContent = 'Create New Task Group';
            document.getElementById('deleteTaskGroupBtn').style.display = 'none';
            document.getElementById('taskGroupForm').style.display = 'block';
        }

        // Edit task group
        async function editTaskGroup(groupId) {
            const group = allTaskGroupsData.find(g => g.id === groupId);
            if (!group) return;

            // Load user groups for dropdown
            await loadUserGroupsForTaskGroupForm();

            document.getElementById('taskGroupId').value = group.id;
            document.getElementById('taskGroupUserGroupSelect').value = group.user_group_id || '';
            document.getElementById('taskGroupName').value = group.group_name;
            document.getElementById('taskGroupDescription').value = group.group_description || '';
            document.getElementById('taskGroupOrder').value = group.display_order;
            document.getElementById('taskGroupActive').checked = group.is_active;

            document.getElementById('taskGroupFormTitle').textContent = 'Edit Task Group';
            document.getElementById('deleteTaskGroupBtn').style.display = 'inline-block';
            document.getElementById('taskGroupForm').style.display = 'block';
        }

        // Load user groups for task group form dropdown
        async function loadUserGroupsForTaskGroupForm() {
            try {
                const { data, error } = await supabaseClient
                    .from('user_groups')
                    .select('*')
                    .order('group_name', { ascending: true });
                
                if (error) throw error;
                
                const selectElement = document.getElementById('taskGroupUserGroupSelect');
                
                // Clear existing options (keep first one)
                while (selectElement.options.length > 1) {
                    selectElement.remove(1);
                }
                
                // Add user groups to dropdown (excluding "All users")
                data.forEach(group => {
                    // Skip "All users" and "Default Group"
                    const groupNameLower = group.group_name ? group.group_name.toLowerCase() : '';
                    if (groupNameLower === 'all users' || groupNameLower === 'default group') {
                        return;
                    }
                    const option = document.createElement('option');
                    option.value = group.id;
                    option.textContent = group.group_name;
                    selectElement.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading user groups for task group form:', error);
            }
        }
        
        // Cancel task group edit
        function cancelTaskGroupEdit() {
            document.getElementById('taskGroupForm').style.display = 'none';
        }

        // Save task group (form submission handler)
        document.getElementById('taskGroupEditForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const groupId = document.getElementById('taskGroupId').value;
                const userGroupId = document.getElementById('taskGroupUserGroupSelect').value;
                
                if (!userGroupId) {
                    showError('Please select a user group. Task groups must belong to a user group.');
                    return;
                }
                
                const formData = {
                    group_name: document.getElementById('taskGroupName').value,
                    group_description: document.getElementById('taskGroupDescription').value,
                    user_group_id: parseInt(userGroupId),
                    display_order: parseInt(document.getElementById('taskGroupOrder').value) || 0,
                    is_active: document.getElementById('taskGroupActive').checked,
                    updated_at: new Date().toISOString()
                };

                let data, error;

                if (groupId) {
                    // Update existing task group
                    const result = await supabaseClient
                        .from('task_groups')
                        .update(formData)
                        .eq('id', groupId)
                        .select();
                    data = result.data;
                    error = result.error;
                } else {
                    // Create new task group
                    formData.created_at = new Date().toISOString();
                    const result = await supabaseClient
                        .from('task_groups')
                        .insert([formData])
                        .select();
                    data = result.data;
                    error = result.error;
                }

                if (error) throw error;

                showSuccess(groupId ? 'Task group updated successfully!' : 'Task group created successfully!');
                await loadTaskGroups();
                setTimeout(() => {
                    document.getElementById('taskGroupForm').style.display = 'none';
                }, 1500);

            } catch (error) {
                console.error('Error saving task group:', error);
                showError('Failed to save task group: ' + error.message);
            }
        });

        // Task Assignment Functions
        let currentAssignmentGroupId = null;
        
        // Assign tasks to group
        async function assignTasks(groupId, groupName) {
            currentAssignmentGroupId = groupId;
            document.getElementById('assignmentGroupName').textContent = groupName;
            
            // Load available tasks
            await loadAvailableTasksForAssignment(groupId);
            
            document.getElementById('taskAssignmentForm').style.display = 'block';
            document.getElementById('taskGroupForm').style.display = 'none';
        }

        // Load available tasks for assignment
        async function loadAvailableTasksForAssignment(groupId) {
            try {
                const { data: allTasks, error } = await supabaseClient
                    .from('onboarding_tasks')
                    .select('*')
                    .order('position');

                if (error) throw error;

                const tasksList = document.getElementById('availableTasksList');
                if (!allTasks || allTasks.length === 0) {
                    tasksList.innerHTML = '<div class="loading">No tasks available for assignment</div>';
                    return;
                }

                tasksList.innerHTML = allTasks.map(task => {
                    const isAssigned = task.task_group_id === groupId;
                    return `
                        <label style="display: block; margin-bottom: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
                            <input type="checkbox" value="${task.id}" ${isAssigned ? 'checked' : ''} style="margin-right: 8px;">
                            <strong>${task.title}</strong>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                Position: ${task.position}
                            </div>
                        </label>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading tasks for assignment:', error);
                document.getElementById('availableTasksList').innerHTML = '<div class="error">Failed to load tasks</div>';
            }
        }

        // Save task assignments
        async function saveTaskAssignments() {
            try {
                const checkboxes = document.querySelectorAll('#availableTasksList input[type="checkbox"]');
                const selectedTaskIds = [];
                const unselectedTaskIds = [];

                checkboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        selectedTaskIds.push(parseInt(checkbox.value));
                    } else {
                        unselectedTaskIds.push(parseInt(checkbox.value));
                    }
                });

                // Assign selected tasks to the group
                if (selectedTaskIds.length > 0) {
                    const { error: assignError } = await supabaseClient
                        .from('onboarding_tasks')
                        .update({ task_group_id: currentAssignmentGroupId })
                        .in('id', selectedTaskIds);

                    if (assignError) throw assignError;
                }

                // Remove unselected tasks from the group
                if (unselectedTaskIds.length > 0) {
                    const { error: unassignError } = await supabaseClient
                        .from('onboarding_tasks')
                        .update({ task_group_id: null })
                        .in('id', unselectedTaskIds)
                        .eq('task_group_id', currentAssignmentGroupId);

                    if (unassignError) throw unassignError;
                }

                showSuccess('Task assignments updated successfully!');
                setTimeout(() => {
                    document.getElementById('taskAssignmentForm').style.display = 'none';
                    loadTasks(); // Reload main tasks view to show changes
                }, 1500);

            } catch (error) {
                console.error('Error saving task assignments:', error);
                showError('Failed to save task assignments: ' + error.message);
            }
        }

        // Cancel task assignment
        function cancelTaskAssignment() {
            document.getElementById('taskAssignmentForm').style.display = 'none';
            currentAssignmentGroupId = null;
        }

        // Sequence Management Functions
        let allSequences = [];

        // Manage sequences
        async function manageSequences() {
            document.getElementById('sequencesForm').style.display = 'block';
            document.getElementById('taskGroupForm').style.display = 'none';
            document.getElementById('taskAssignmentForm').style.display = 'none';
            await loadSequences();
        }

        // Back to task groups
        function backToTaskGroups() {
            document.getElementById('sequencesForm').style.display = 'none';
            document.getElementById('sequenceEditForm').style.display = 'none';
        }

        // Load sequences from database
        async function loadSequences() {
            try {
                const { data, error } = await supabaseClient
                    .from('task_group_sequences')
                    .select(`
                        *,
                        prerequisite_group:prerequisite_group_id(group_name),
                        unlock_group:unlock_group_id(group_name)
                    `)
                    .order('created_at');

                if (error) throw error;

                allSequences = data || [];
                renderSequences();
            } catch (error) {
                console.error('Error loading sequences:', error);
                document.getElementById('sequencesList').innerHTML = '<div class="error">Failed to load sequences</div>';
            }
        }

        // Render sequences list
        function renderSequences() {
            const sequencesList = document.getElementById('sequencesList');

            if (allSequences.length === 0) {
                sequencesList.innerHTML = '<div class="loading">No sequences configured. Create your first sequence to set up conditional task group flows!</div>';
                return;
            }

            sequencesList.innerHTML = allSequences.map(sequence => {
                const prerequisiteName = sequence.prerequisite_group?.group_name || 'Unknown Group';
                const unlockName = sequence.unlock_group?.group_name || 'Unknown Group';
                
                return `
                    <div class="webhook-item">
                        <div class="webhook-item-header">
                            <div class="webhook-name">🔄 ${sequence.sequence_name}</div>
                            <div class="webhook-status ${sequence.is_active ? 'active' : 'inactive'}">
                                ${sequence.is_active ? 'Active' : 'Inactive'}
                            </div>
                        </div>
                        <div class="webhook-description">${sequence.description || 'No description'}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 4px;">
                            📋 Complete "${prerequisiteName}" → Unlock "${unlockName}"
                        </div>
                        <div class="webhook-actions">
                            <button class="btn-small btn-edit" onclick="editSequence(${sequence.id})">Edit</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Create new sequence
        async function createNewSequence() {
            // Clear form for new sequence
            document.getElementById('sequenceId').value = '';
            document.getElementById('sequenceName').value = '';
            document.getElementById('sequenceDescription').value = '';
            document.getElementById('prerequisiteGroup').value = '';
            document.getElementById('unlockGroup').value = '';
            document.getElementById('sequenceActive').checked = true;

            // Load task groups for dropdowns
            await loadTaskGroupsForSequence();
            await loadUserGroupsForSequence();

            // Reset applies to
            const select = document.getElementById('sequenceAppliesTo');
            Array.from(select.options).forEach(option => {
                option.selected = option.value === 'all';
            });

            document.getElementById('sequenceFormTitle').textContent = 'Create New Sequence';
            document.getElementById('deleteSequenceBtn').style.display = 'none';
            document.getElementById('sequenceEditForm').style.display = 'block';
            document.getElementById('sequencesForm').style.display = 'none';
        }

        // Load task groups for sequence dropdowns
        async function loadTaskGroupsForSequence() {
            const prerequisiteSelect = document.getElementById('prerequisiteGroup');
            const unlockSelect = document.getElementById('unlockGroup');

            prerequisiteSelect.innerHTML = '<option value="">Select group that must be completed first...</option>';
            unlockSelect.innerHTML = '<option value="">Select group to unlock...</option>';

            allTaskGroupsData.forEach(group => {
                const option1 = document.createElement('option');
                option1.value = group.id;
                option1.textContent = group.group_name;
                prerequisiteSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = group.id;
                option2.textContent = group.group_name;
                unlockSelect.appendChild(option2);
            });
        }

        // Load user groups for sequence applies to
        async function loadUserGroupsForSequence() {
            try {
                const { data: userGroups, error } = await supabaseClient
                    .from('user_groups')
                    .select('*')
                    .order('group_name');

                if (error) throw error;

                const select = document.getElementById('sequenceAppliesTo');
                
                // Add user groups to the dropdown (excluding "All users")
                if (userGroups && userGroups.length > 0) {
                    userGroups.forEach(group => {
                        // Skip "All users" group
                        if (group.group_name && group.group_name.toLowerCase() === 'all users') {
                            return;
                        }
                        const option = document.createElement('option');
                        option.value = group.id;
                        option.textContent = group.group_name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading user groups for sequence:', error);
            }
        }

        // Edit sequence
        async function editSequence(sequenceId) {
            const sequence = allSequences.find(s => s.id === sequenceId);
            if (!sequence) return;

            document.getElementById('sequenceId').value = sequence.id;
            document.getElementById('sequenceName').value = sequence.sequence_name;
            document.getElementById('sequenceDescription').value = sequence.description || '';
            document.getElementById('sequenceActive').checked = sequence.is_active;

            // Load task groups and user groups
            await loadTaskGroupsForSequence();
            await loadUserGroupsForSequence();

            // Set selections
            document.getElementById('prerequisiteGroup').value = sequence.prerequisite_group_id;
            document.getElementById('unlockGroup').value = sequence.unlock_group_id;

            // Set applies to
            const appliesToSelect = document.getElementById('sequenceAppliesTo');
            if (sequence.applies_to === 'groups' && sequence.target_groups && sequence.target_groups.length > 0) {
                Array.from(appliesToSelect.options).forEach(option => {
                    if (option.value === 'all') {
                        option.selected = false;
                    } else {
                        option.selected = sequence.target_groups.includes(parseInt(option.value));
                    }
                });
            } else {
                Array.from(appliesToSelect.options).forEach(option => {
                    option.selected = option.value === 'all';
                });
            }

            document.getElementById('sequenceFormTitle').textContent = 'Edit Sequence';
            document.getElementById('deleteSequenceBtn').style.display = 'inline-block';
            document.getElementById('sequenceEditForm').style.display = 'block';
            document.getElementById('sequencesForm').style.display = 'none';
        }

        // Cancel sequence edit
        function cancelSequenceEdit() {
            document.getElementById('sequenceEditForm').style.display = 'none';
            document.getElementById('sequencesForm').style.display = 'block';
        }

        // Handle sequence applies to dropdown change (like webhook rules)
        function handleSequenceAppliesToChange() {
            const select = document.getElementById('sequenceAppliesTo');
            const selectedValues = Array.from(select.selectedOptions).map(option => option.value);
            
            // Ensure at least one group is selected
            if (selectedValues.length === 0) {
                showError('Please select at least one user group');
            }
        }

        // Save sequence (form submission handler)
        document.getElementById('sequenceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const sequenceId = document.getElementById('sequenceId').value;
                
                // Build applies to rules
                const select = document.getElementById('sequenceAppliesTo');
                const selectedValues = Array.from(select.selectedOptions).map(option => option.value);
                
                let appliesTo = 'all';
                let targetGroups = [];
                
                if (!selectedValues.includes('all') && selectedValues.length > 0) {
                    appliesTo = 'groups';
                    targetGroups = selectedValues.map(val => parseInt(val)).filter(val => !isNaN(val));
                }
                
                const formData = {
                    sequence_name: document.getElementById('sequenceName').value,
                    description: document.getElementById('sequenceDescription').value,
                    prerequisite_group_id: parseInt(document.getElementById('prerequisiteGroup').value),
                    unlock_group_id: parseInt(document.getElementById('unlockGroup').value),
                    applies_to: appliesTo,
                    target_groups: targetGroups,
                    is_active: document.getElementById('sequenceActive').checked,
                    updated_at: new Date().toISOString()
                };

                let data, error;

                if (sequenceId) {
                    // Update existing sequence
                    const result = await supabaseClient
                        .from('task_group_sequences')
                        .update(formData)
                        .eq('id', sequenceId)
                        .select();
                    data = result.data;
                    error = result.error;
                } else {
                    // Create new sequence
                    formData.created_at = new Date().toISOString();
                    const result = await supabaseClient
                        .from('task_group_sequences')
                        .insert([formData])
                        .select();
                    data = result.data;
                    error = result.error;
                }

                if (error) throw error;

                showSuccess(sequenceId ? 'Sequence updated successfully!' : 'Sequence created successfully!');
                await loadSequences();
                setTimeout(() => {
                    document.getElementById('sequenceEditForm').style.display = 'none';
                    document.getElementById('sequencesForm').style.display = 'block';
                }, 1500);

            } catch (error) {
                console.error('Error saving sequence:', error);
                showError('Failed to save sequence: ' + error.message);
            }
        });

        // Delete sequence
        async function deleteSequence() {
            const sequenceId = document.getElementById('sequenceId').value;
            if (!sequenceId) return;

            const sequence = allSequences.find(s => s.id === parseInt(sequenceId));
            if (!confirm(`Are you sure you want to delete the sequence "${sequence.sequence_name}"?`)) {
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('task_group_sequences')
                    .delete()
                    .eq('id', sequenceId);

                if (error) throw error;

                showSuccess('Sequence deleted successfully!');
                await loadSequences();
                document.getElementById('sequenceEditForm').style.display = 'none';
                document.getElementById('sequencesForm').style.display = 'block';
            } catch (error) {
                console.error('Error deleting sequence:', error);
                showError('Failed to delete sequence: ' + error.message);
            }
        }

        // Delete task group
        async function deleteTaskGroup() {
            const groupId = document.getElementById('taskGroupId').value;
            if (!groupId) return;

            const group = allTaskGroupsData.find(g => g.id === parseInt(groupId));
            if (!confirm(`Are you sure you want to delete the task group "${group.group_name}"? This will also remove all task assignments to this group.`)) {
                return;
            }

            try {
                // First, remove task_group_id from all tasks that belong to this group
                const { error: updateError } = await supabaseClient
                    .from('onboarding_tasks')
                    .update({ task_group_id: null })
                    .eq('task_group_id', groupId);

                if (updateError) {
                    console.error('Error updating tasks:', updateError);
                    throw updateError;
                }

                // Now delete the task group
                const { error: deleteError } = await supabaseClient
                    .from('task_groups')
                    .delete()
                    .eq('id', groupId);

                if (deleteError) throw deleteError;

                showSuccess('Task group deleted successfully!');
                await loadTaskGroups();
                
                // Remove any modal overlay and close form
                const taskOverlay = document.getElementById('taskModalOverlay');
                if (taskOverlay) {
                    document.body.removeChild(taskOverlay);
                }
                const modalOverlay = document.getElementById('modalOverlay');
                if (modalOverlay) {
                    document.body.removeChild(modalOverlay);
                }
                document.getElementById('taskGroupForm').style.display = 'none';
            } catch (error) {
                console.error('Error deleting task group:', error);
                showError('Failed to delete task group: ' + error.message);
            }
        }

        // Webhook Management Functions
        let allWebhooks = [];
        let allTaskGroups = [];

        // Open webhook settings panel
        async function openWebhookSettings() {
            document.getElementById('webhookPanel').style.display = 'block';
            await loadWebhooks();
        }

        // Close webhook settings panel
        function closeWebhookPanel() {
            document.getElementById('webhookPanel').style.display = 'none';
            document.getElementById('webhookForm').style.display = 'none';
        }

        // Load webhooks from database
        async function loadWebhooks() {
            try {
                // Load webhooks, user groups, and task groups concurrently
                const [webhooksResult, groupsResult, taskGroupsResult] = await Promise.all([
                    supabaseClient.from('webhook_settings').select('*').order('created_at'),
                    supabaseClient.from('user_groups').select('*').order('group_name'),
                    supabaseClient.from('task_groups').select('*').order('display_order')
                ]);

                if (webhooksResult.error) throw webhooksResult.error;
                if (groupsResult.error) console.warn('Could not load user groups for webhook rules display:', groupsResult.error);
                if (taskGroupsResult.error) console.warn('Could not load task groups for webhook display:', taskGroupsResult.error);
                
                allWebhooks = webhooksResult.data || [];
                allGroups = groupsResult.data || [];
                allTaskGroups = taskGroupsResult.data || [];
                renderWebhooks();
            } catch (error) {
                console.error('Error loading webhooks:', error);
                document.getElementById('webhooksList').innerHTML = '<div class="error">Failed to load webhooks</div>';
            }
        }

        // Render webhooks list
        function renderWebhooks() {
            const webhooksList = document.getElementById('webhooksList');
            
            if (allWebhooks.length === 0) {
                webhooksList.innerHTML = '<div class="loading">No webhooks configured</div>';
                return;
            }

            webhooksList.innerHTML = allWebhooks.map(webhook => {
                // Format rules display
                let rulesDisplay = '';
                if (webhook.rules && webhook.rules.type === 'groups' && webhook.rules.groups && webhook.rules.groups.length > 0) {
                    const groupNames = webhook.rules.groups.map(groupId => {
                        const group = allGroups.find(g => g.id === groupId);
                        return group ? group.group_name : `Group ${groupId}`;
                    });
                    rulesDisplay = `<div class="webhook-rules" style="font-size: 12px; color: #666; margin-top: 4px;">
                        📋 Rules: Only fires for groups: ${groupNames.join(', ')}
                    </div>`;
                } else {
                    rulesDisplay = `<div class="webhook-rules" style="font-size: 12px; color: #666; margin-top: 4px;">
                        ⚠️ Rules: No specific rules configured
                    </div>`;
                }
                
                // Get task group name if webhook is tied to a specific task group
                let taskGroupName = '';
                if (webhook.metadata && webhook.metadata.task_group_id) {
                    const taskGroup = allTaskGroups.find(tg => tg.id === webhook.metadata.task_group_id);
                    taskGroupName = taskGroup ? taskGroup.group_name : '';
                }
                
                return `
                    <div class="webhook-item">
                        <div class="webhook-item-header">
                            <div class="webhook-name">${getActionDisplayName(webhook.webhook_name, taskGroupName)}</div>
                            <div class="webhook-status ${webhook.is_active ? 'active' : 'inactive'}">
                                ${webhook.is_active ? 'Active' : 'Inactive'}
                            </div>
                        </div>
                        <div class="webhook-url">${webhook.webhook_url}</div>
                        <div class="webhook-description">${webhook.description || 'No description'}</div>
                        ${rulesDisplay}
                        <div class="webhook-actions">
                            <button class="btn-small btn-edit" onclick="editWebhook(${webhook.id})">Edit</button>
                            <button class="btn-small btn-test" onclick="testSingleWebhook(${webhook.id})">Test</button>
                        </div>
                        <div class="webhook-test-result" id="test-result-${webhook.id}" style="display: none; margin-top: 10px; padding: 10px; border-radius: 4px; font-size: 14px;"></div>
                    </div>
                `;
            }).join('');
        }

        // Create new webhook
        async function createNewWebhook() {
            // Clear form for new webhook
            document.getElementById('webhookId').value = '';
            // document.getElementById('webhookDisplayName').value = ''; // Temporarily disabled
            document.getElementById('webhookAction').value = '';
            document.getElementById('webhookUrl').value = '';
            document.getElementById('webhookDescription').value = '';
            document.getElementById('webhookActive').checked = true;
            
            // Hide delete button for new webhooks
            document.getElementById('deleteWebhookBtn').style.display = 'none';

            // Load groups for rules dropdown
            await loadGroupsForRulesDropdown();
            
            // Reset dropdown - clear selection
            const select = document.getElementById('firingRulesSelect');
            Array.from(select.options).forEach(option => {
                option.selected = false;
            });

            document.getElementById('webhookFormTitle').textContent = 'Create New Webhook';
            document.getElementById('webhookForm').style.display = 'block';
        }

        // Edit webhook
        async function editWebhook(webhookId) {
            const webhook = allWebhooks.find(w => w.id === webhookId);
            if (!webhook) return;

            document.getElementById('webhookId').value = webhook.id;
            // Temporarily disabled until DB column is added:
            // document.getElementById('webhookDisplayName').value = webhook.display_name || '';
            document.getElementById('webhookAction').value = webhook.webhook_name;
            document.getElementById('webhookUrl').value = webhook.webhook_url;
            document.getElementById('webhookDescription').value = webhook.description || '';
            document.getElementById('webhookActive').checked = webhook.is_active;
            
            // Show delete button for existing webhooks
            document.getElementById('deleteWebhookBtn').style.display = 'block';

            // Handle task group selection for group-specific webhooks
            await handleWebhookActionChange();
            
            // Set task group if webhook has one
            if (webhook.metadata && webhook.metadata.task_group_id) {
                document.getElementById('webhookTaskGroup').value = webhook.metadata.task_group_id;
            }

            // Load and populate groups for rules dropdown
            await loadGroupsForRulesDropdown();
            
            // Set up rules in dropdown
            const rules = webhook.rules || { type: 'all' };
            const select = document.getElementById('firingRulesSelect');
            
            if (rules.type === 'groups' && rules.groups) {
                // Select the specific groups
                Array.from(select.options).forEach(option => {
                    option.selected = rules.groups.includes(parseInt(option.value));
                });
            } else {
                // No specific groups selected - clear selection
                Array.from(select.options).forEach(option => {
                    option.selected = false;
                });
            }

            document.getElementById('webhookFormTitle').textContent = 'Edit Webhook';
            document.getElementById('webhookForm').style.display = 'block';
        }

        // Load groups for rules dropdown
        async function loadGroupsForRulesDropdown() {
            try {
                const { data: groups, error } = await supabaseClient
                    .from('user_groups')
                    .select('*')
                    .order('group_name');

                if (error) throw error;

                const select = document.getElementById('firingRulesSelect');
                // Clear existing options
                select.innerHTML = '<option value="" disabled selected>Select User Groups</option>';
                
                if (groups && groups.length > 0) {
                    groups.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group.id;
                        option.textContent = group.group_name + (group.group_description ? ` - ${group.group_description}` : '');
                        select.appendChild(option);
                    });
                }

            } catch (error) {
                console.error('Error loading groups:', error);
            }
        }

        // Handle firing rules dropdown change
        function handleFiringRulesChange() {
            const select = document.getElementById('firingRulesSelect');
            const selectedValues = Array.from(select.selectedOptions).map(option => option.value);
            
            // Ensure at least one group is selected
            if (selectedValues.length === 0) {
                showError('Please select at least one user group');
            }
        }

        // Handle webhook action change - show/hide task group selection
        async function handleWebhookActionChange() {
            const actionSelect = document.getElementById('webhookAction');
            const taskGroupContainer = document.getElementById('taskGroupSelection');
            const actionValue = actionSelect.value;
            
            // Show task group selection for group-specific actions
            const groupSpecificActions = ['task_completed_in_group', 'all_tasks_completed_in_group', 'task_group_assigned', 'task_group_started'];
            
            if (groupSpecificActions.includes(actionValue)) {
                taskGroupContainer.style.display = 'block';
                await loadTaskGroupsForWebhook();
            } else {
                taskGroupContainer.style.display = 'none';
            }
        }

        // Load task groups for webhook selection
        async function loadTaskGroupsForWebhook() {
            try {
                const { data: taskGroups, error } = await supabaseClient
                    .from('task_groups')
                    .select('*')
                    .eq('is_active', true)
                    .order('display_order');

                if (error) throw error;

                const select = document.getElementById('webhookTaskGroup');
                select.innerHTML = '<option value="">Choose a task group...</option>';
                
                if (taskGroups && taskGroups.length > 0) {
                    taskGroups.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group.id;
                        option.textContent = group.group_name + (group.group_description ? ` - ${group.group_description}` : '');
                        select.appendChild(option);
                    });
                }

            } catch (error) {
                console.error('Error loading task groups:', error);
            }
        }

        // Cancel webhook edit
        function cancelWebhookEdit() {
            document.getElementById('webhookForm').style.display = 'none';
            document.getElementById('webhookEditForm').reset();
            // Reset dropdown - clear selection
            const select = document.getElementById('firingRulesSelect');
            Array.from(select.options).forEach(option => {
                option.selected = false;
            });
        }

        // Save webhook
        document.getElementById('webhookEditForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            console.log('Starting webhook save...');
            
            try {
                const webhookId = document.getElementById('webhookId').value;
                console.log('Webhook ID:', webhookId || 'New webhook');
                
                // Build rules object from dropdown
                const select = document.getElementById('firingRulesSelect');
                const selectedValues = Array.from(select.selectedOptions).map(option => option.value);
                
                let rules = { type: 'all' };
                if (!selectedValues.includes('all') && selectedValues.length > 0) {
                    rules = {
                        type: 'groups',
                        groups: selectedValues.map(val => parseInt(val)).filter(val => !isNaN(val))
                    };
                }
                
                // Build metadata object for task group specific webhooks
                let metadata = {};
                const taskGroupId = document.getElementById('webhookTaskGroup').value;
                if (taskGroupId) {
                    metadata.task_group_id = parseInt(taskGroupId);
                }
                
                // Build form data - TEMPORARILY removing display_name until DB is updated
                // const displayName = document.getElementById('webhookDisplayName').value;
                const webhookAction = document.getElementById('webhookAction').value;
                const webhookUrl = document.getElementById('webhookUrl').value;
                
                // Validate required fields
                if (!webhookAction) {
                    showError('Please select a webhook action/event');
                    return;
                }
                if (!webhookUrl) {
                    showError('Please enter a webhook URL');
                    return;
                }
                
                const formData = {
                    webhook_name: webhookAction,
                    webhook_url: webhookUrl,
                    description: document.getElementById('webhookDescription').value || '',
                    is_active: document.getElementById('webhookActive').checked,
                    rules: rules,
                    metadata: metadata,
                    updated_at: new Date().toISOString()
                };
                
                // NOTE: display_name field is commented out until database column is added
                // Uncomment this after running the migration:
                // if (displayName) {
                //     formData.display_name = displayName;
                // }
                
                console.log('Form data to save:', formData);

                let data, error;

                if (webhookId) {
                    // Update existing webhook
                    const result = await supabaseClient
                        .from('webhook_settings')
                        .update(formData)
                        .eq('id', webhookId)
                        .select();
                    data = result.data;
                    error = result.error;
                } else {
                    // Create new webhook
                    formData.created_at = new Date().toISOString();
                    const result = await supabaseClient
                        .from('webhook_settings')
                        .insert([formData])
                        .select();
                    data = result.data;
                    error = result.error;
                }

                if (error) {
                    console.error('Database error:', error);
                    throw error;
                }
                
                console.log('Webhook saved successfully:', data);
                showSuccess(webhookId ? 'Webhook updated successfully!' : 'Webhook created successfully!');
                
                // Reset form
                document.getElementById('webhookEditForm').reset();
                document.getElementById('webhookForm').style.display = 'none';
                
                // Reload webhooks list
                await loadWebhooks();

            } catch (error) {
                console.error('Error saving webhook:', error);
                console.error('Error details:', error);
                
                // Check for specific database errors
                if (error.message && error.message.includes('display_name')) {
                    showError('Database column issue. Please contact support to update database schema.');
                } else {
                    showError('Failed to save webhook: ' + (error.message || 'Unknown error'));
                }
            }
        });

        // Test single webhook
        async function testSingleWebhook(webhookId) {
            const webhook = allWebhooks.find(w => w.id === parseInt(webhookId));
            if (!webhook) {
                showWebhookTestResult(webhookId, 'Webhook not found', false);
                return;
            }

            // Show testing message in the specific webhook result area
            showWebhookTestResult(webhookId, 'Testing webhook: ' + webhook.webhook_name + '...', null);

            try {
                // Create comprehensive test payload with all fields needed for HighLevel contact mapping
                const testPayload = {
                    // === CONTACT IDENTIFICATION ===
                    userEmail: 'test@example.com',
                    locationId: 'test_location_123',
                    userId: 'test_user_001',
                    
                    // === CONTACT PROFILE DATA ===
                    firstName: 'John',
                    lastName: 'Doe',
                    fullName: 'John Doe',
                    cellPhone: '(555) 123-4567',
                    companyName: 'Test Company Inc.',
                    
                    // === USER GROUP INFORMATION ===
                    userGroup: {
                        id: 1,
                        name: 'New Employees',
                        description: 'Group for new employee onboarding'
                    },
                    userGroupId: 1,
                    userGroupName: 'New Employees',
                    
                    // === CURRENT TASK INFORMATION ===
                    currentTaskGroup: {
                        id: 1,
                        name: 'Onboarding Tasks',
                        display_order: 1,
                        description: 'Initial onboarding task group'
                    },
                    currentTaskGroupId: 1,
                    currentTaskGroupName: 'Onboarding Tasks',
                    
                    // === PROGRESS TRACKING ===
                    groupProgress: {
                        completed: 2,
                        total: 5,
                        percentage: 40,
                        remaining: 3
                    },
                    overallProgress: {
                        completed: 7,
                        total: 20,
                        percentage: 35,
                        remaining: 13
                    },
                    
                    // === TASK-SPECIFIC DATA (will be added dynamically below) ===
                    taskId: null,
                    taskTitle: null,
                    taskDescription: null,
                    taskCompleted: false,
                    
                    // === TIMESTAMPS ===
                    timestamp: new Date().toISOString(),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    
                    // === WEBHOOK METADATA ===
                    webhookName: webhook.webhook_name,
                    webhookEvent: webhook.webhook_name,
                    testData: true,
                    source: 'DFY_CRM_Admin_Test',
                    version: '1.0',
                    message: `Test webhook from DFY CRM Admin for ${getActionDisplayName(webhook.webhook_name)}`
                };

                // Add action-specific data based on webhook type
                if (webhook.webhook_name.startsWith('task_')) {
                    testPayload.taskId = 'test_task_123';
                    testPayload.taskTitle = 'Complete Profile Information';
                    testPayload.taskDescription = 'Fill out all required profile fields including name, phone, and company';
                    testPayload.taskPosition = 1;
                    testPayload.taskGroupId = 1;
                    testPayload.taskGroupName = 'Onboarding Tasks';
                    
                    if (webhook.webhook_name === 'task_completed' || webhook.webhook_name === 'task_completed_in_group') {
                        testPayload.taskCompleted = true;
                        testPayload.completed = true;
                        testPayload.completedAt = new Date().toISOString();
                        testPayload.completionTimeSeconds = 300;
                        testPayload.taskStatus = 'completed';
                    } else if (webhook.webhook_name === 'task_started') {
                        testPayload.startedAt = new Date().toISOString();
                        testPayload.taskStatus = 'in_progress';
                    } else if (webhook.webhook_name === 'task_assigned') {
                        testPayload.assignedAt = new Date().toISOString();
                        testPayload.assignedToGroups = ['New Employees'];
                        testPayload.taskStatus = 'assigned';
                    }
                } else if (webhook.webhook_name.startsWith('user_')) {
                    if (webhook.webhook_name === 'user_profile_completed') {
                        testPayload.profileCompleted = true;
                        testPayload.profileCompletedAt = new Date().toISOString();
                        testPayload.profileData = {
                            firstName: 'John',
                            lastName: 'Doe',
                            companyName: 'Test Company Inc.',
                            cellPhone: '(555) 123-4567',
                            email: 'test@example.com'
                        };
                        testPayload.eventType = 'profile_completed';
                    } else if (webhook.webhook_name === 'user_registered') {
                        testPayload.registrationDate = new Date().toISOString();
                        testPayload.registeredAt = new Date().toISOString();
                        testPayload.eventType = 'user_registered';
                        testPayload.isNewUser = true;
                    } else if (webhook.webhook_name === 'user_added_to_group') {
                        testPayload.groupId = 1;
                        testPayload.groupName = 'New Employees';
                        testPayload.addedToGroupAt = new Date().toISOString();
                        testPayload.eventType = 'user_added_to_group';
                        testPayload.previousGroupId = null;
                        testPayload.previousGroupName = null;
                    } else if (webhook.webhook_name === 'user_removed_from_group') {
                        testPayload.groupId = null;
                        testPayload.groupName = null;
                        testPayload.removedFromGroupAt = new Date().toISOString();
                        testPayload.eventType = 'user_removed_from_group';
                        testPayload.previousGroupId = 1;
                        testPayload.previousGroupName = 'New Employees';
                    }
                } else if (webhook.webhook_name.startsWith('flow_') || webhook.webhook_name.includes('sequence')) {
                    testPayload.sequenceId = 1;
                    testPayload.sequenceName = 'Onboarding Flow';
                    testPayload.prerequisiteGroupId = 1;
                    testPayload.prerequisiteGroupName = 'Basic Training';
                    testPayload.unlockedGroupId = 2;
                    testPayload.unlockedGroupName = 'Advanced Training';
                    testPayload.sequenceTriggeredAt = new Date().toISOString();
                    testPayload.eventType = webhook.webhook_name;
                }

                console.log('Testing webhook with payload:', testPayload);
                console.log('Webhook URL:', webhook.webhook_url);

                // Send the webhook using proper CORS mode
                // Note: If this fails due to CORS, we'll fall back to sending via backend proxy
                try {
                    const response = await fetch(webhook.webhook_url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'User-Agent': 'DFY-CRM-Webhook-Test/1.0'
                        },
                        body: JSON.stringify(testPayload)
                    });

                    if (response.ok) {
                        const responseText = await response.text();
                        showWebhookTestResult(webhookId, `✓ Test successful! Status: ${response.status}`, true);
                        console.log('Webhook test response:', responseText);
                    } else {
                        showWebhookTestResult(webhookId, `✗ Test failed with status: ${response.status}`, false);
                    }
                } catch (fetchError) {
                    console.log('Direct fetch failed, likely due to CORS. Error:', fetchError);
                    
                    // If CORS blocks the request, we need to acknowledge that the webhook might still work
                    // when called from the backend (which doesn't have CORS restrictions)
                    if (fetchError.message.includes('Failed to fetch') || fetchError.message.includes('CORS')) {
                        // Try sending through a CORS proxy or just inform the user
                        showWebhookTestResult(webhookId, 
                            `⚠️ Test blocked by browser CORS policy. The webhook will work when triggered from the backend. ` +
                            `Please check your HighLevel workflow for the test data.`, 
                            null);
                        
                        // Log the payload so user can manually verify
                        console.log('Test payload that would be sent:', JSON.stringify(testPayload, null, 2));
                    } else {
                        throw fetchError;
                    }
                }

            } catch (error) {
                console.error('Error testing webhook:', error);
                
                // Provide more helpful error messages
                if (error.message.includes('Failed to fetch')) {
                    showWebhookTestResult(webhookId, `✗ Could not reach webhook endpoint. This might be due to CORS restrictions. The webhook may still be working - check your endpoint logs.`, false);
                } else if (error.message.includes('NetworkError')) {
                    showWebhookTestResult(webhookId, `✗ Network error when testing webhook. Please check the webhook URL is correct.`, false);
                } else {
                    showWebhookTestResult(webhookId, `✗ Webhook test error: ${error.message}`, false);
                }
            }
        }

        // Get user-friendly action name (updated for simplified group-based system)
        function getActionDisplayName(actionCode, taskGroupName = '') {
            const actionNames = {
                // Task Group Actions
                'task_completed_in_group': `📋 Task completed in ${taskGroupName || 'specific group'}`,
                'all_tasks_completed_in_group': `📋 ALL tasks completed in ${taskGroupName || 'specific group'}`,
                'task_group_assigned': `📋 Task group assigned: ${taskGroupName || 'specific group'}`,
                'task_group_started': `📋 User starts task in ${taskGroupName || 'specific group'}`,
                
                // User Actions
                'user_profile_completed': '👤 User completes profile setup',
                'user_registered': '👤 New user registered',
                
                // User Group Management
                'user_added_to_group': '👥 User added to user group',
                'user_removed_from_group': '👥 User removed from user group',
                
                // Flow Actions
                'flow_rule_triggered': '🔄 Flow rule condition met',
                'task_group_unlocked': '🔄 Task group unlocked for user',
                
                // Legacy actions (for backwards compatibility)
                'task_completion': '📋 User completes a task (Legacy)',
                'user_notification': '👤 User notification (Legacy)'
            };
            
            return actionNames[actionCode] || actionCode;
        }

        // Show webhook test result in specific webhook's result area
        function showWebhookTestResult(webhookId, message, success) {
            const resultElement = document.getElementById(`test-result-${webhookId}`);
            if (!resultElement) return;

            resultElement.textContent = message;
            resultElement.style.display = 'block';
            
            // Style based on result type
            if (success === true) {
                resultElement.style.backgroundColor = '#d4edda';
                resultElement.style.color = '#155724';
                resultElement.style.border = '1px solid #c3e6cb';
            } else if (success === false) {
                resultElement.style.backgroundColor = '#f8d7da';
                resultElement.style.color = '#721c24';
                resultElement.style.border = '1px solid #f5c6cb';
            } else {
                // Testing/neutral state
                resultElement.style.backgroundColor = '#d1ecf1';
                resultElement.style.color = '#0c5460';
                resultElement.style.border = '1px solid #bee5eb';
            }
        }

        // Test webhook endpoint (for individual webhook form)
        async function testWebhookEndpoint() {
            const webhookUrl = document.getElementById('webhookUrl').value;
            if (!webhookUrl) {
                showError('Please enter a webhook URL first');
                return;
            }

            await testSingleWebhook(document.getElementById('webhookId').value);
        }

        // Delete webhook function
        async function deleteWebhook() {
            const webhookId = document.getElementById('webhookId').value;
            if (!webhookId) {
                showError('No webhook selected for deletion');
                return;
            }
            
            const webhook = allWebhooks.find(w => w.id === parseInt(webhookId));
            if (!webhook) {
                showError('Webhook not found');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete the webhook "${webhook.display_name || getActionDisplayName(webhook.webhook_name)}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('webhook_settings')
                    .delete()
                    .eq('id', webhookId);
                
                if (error) throw error;
                
                showSuccess('Webhook deleted successfully');
                cancelWebhookEdit();
                await loadWebhooks();
            } catch (error) {
                console.error('Error deleting webhook:', error);
                showError('Failed to delete webhook: ' + error.message);
            }
        }

        // Quick function to update all webhooks with new URL
        async function updateAllWebhooksURL(newUrl) {
            try {
                const { data: webhooks, error: fetchError } = await supabaseClient
                    .from('webhook_settings')
                    .select('*');
                
                if (fetchError) throw fetchError;
                
                console.log(`Updating ${webhooks.length} webhooks with new URL: ${newUrl}`);
                
                for (const webhook of webhooks) {
                    const { error: updateError } = await supabaseClient
                        .from('webhook_settings')
                        .update({ webhook_url: newUrl })
                        .eq('id', webhook.id);
                    
                    if (updateError) {
                        console.error(`Failed to update webhook ${webhook.webhook_name}:`, updateError);
                    } else {
                        console.log(`✓ Updated webhook: ${webhook.webhook_name}`);
                    }
                }
                
                console.log('All webhooks updated successfully!');
                await loadWebhooks(); // Reload the list
                return true;
            } catch (error) {
                console.error('Error updating webhooks:', error);
                return false;
            }
        }

        // Enhanced Global Admin Navigation System
        function initAdminNavigation() {
            // Get current page for active state detection
            const currentPath = window.location.pathname;
            const pathParts = currentPath.split('/').filter(p => p);
            const currentPage = pathParts[pathParts.length - 1] || 'admin';
            const currentFile = currentPage.replace('.html', '');
            
            // Navigation configuration with smart active detection
            const navItems = [
                { 
                    file: 'admin', 
                    iconClass: 'tasks', 
                    label: 'Task Groups',
                    activePatterns: ['admin.html', 'admin', ''],
                    onclick: 'openTaskGroups()',
                    isActive: currentFile === 'admin' || currentFile === ''
                },
                { 
                    file: 'admin', 
                    iconClass: 'workflow', 
                    label: 'Task Sequences',
                    activePatterns: ['admin.html', 'admin', ''],
                    onclick: 'openTaskSequences()',
                    isActive: false // Will be set programmatically based on current view
                },
                { 
                    file: 'analytics', 
                    iconClass: 'analytics', 
                    label: 'Users',
                    activePatterns: ['analytics.html', 'analytics']
                },
                { 
                    file: 'test', 
                    iconClass: 'test', 
                    label: 'System Test',
                    activePatterns: ['test.html', 'test', 'diagnostic']
                },
                { 
                    file: 'onboarding?email=admin@test.com&locationid=admin_preview', 
                    iconClass: 'preview', 
                    label: 'Preview',
                    activePatterns: ['onboarding.html', 'onboarding'],
                    isPreview: true
                }
            ];
            
            // Generate enhanced navigation HTML
            const navHtml = navItems.map(item => {
                // Smart active state detection
                const isActive = item.isActive !== undefined ? item.isActive : 
                    item.activePatterns.some(pattern => {
                        const cleanPattern = pattern.replace('.html', '');
                        return currentFile === cleanPattern || 
                               (cleanPattern === '' && (currentFile === 'admin' || currentFile === 'index'));
                    });
                
                const activeClass = isActive ? ' active' : '';
                const href = item.onclick ? 'javascript:void(0)' : getCleanUrl(item.file);
                const target = item.isPreview ? ' target="_blank"' : '';
                const onclick = item.onclick ? ` onclick="${item.onclick}"` : '';
                
                return `<a href="${href}" class="nav-link${activeClass}"${target}${onclick}>
                    <div class="nav-icon ${item.iconClass}"></div>
                    <span>${item.label}</span>
                </a>`;
            }).join('');
            
            // Insert navigation with fade-in effect
            const navContainer = document.getElementById('adminNav');
            navContainer.style.opacity = '0';
            navContainer.innerHTML = navHtml;
            
            // Animate in
            setTimeout(() => {
                navContainer.style.transition = 'opacity 0.3s ease';
                navContainer.style.opacity = '1';
            }, 50);
        }

        // Simple Task Sequences Functions
        async function loadTaskSequences() {
            try {
                const { data: sequences, error } = await supabaseClient
                    .from('task_group_sequences')
                    .select('*')
                    .eq('is_active', true)
                    .order('created_at');

                if (error) throw error;

                const { data: taskGroups, error: groupsError } = await supabaseClient
                    .from('task_groups')
                    .select('*')
                    .eq('is_active', true);

                if (groupsError) throw groupsError;

                renderSimpleSequences(sequences || [], taskGroups || []);

            } catch (error) {
                console.error('Error loading task sequences:', error);
                document.getElementById('sequencesList').innerHTML = `
                    <div class="empty-sequences">
                        <h3>Error loading sequences</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function renderSimpleSequences(sequences, taskGroups) {
            const list = document.getElementById('sequencesList');

            if (!sequences || sequences.length === 0) {
                list.innerHTML = `
                    <div class="empty-sequences">
                        <h3>No sequences configured</h3>
                        <p>Create your first sequence to set up conditional task group flows.</p>
                        <button class="btn btn-primary" onclick="addNewSequence()">Create First Sequence</button>
                    </div>
                `;
                return;
            }

            const sequenceHtml = sequences.map(seq => {
                const prerequisiteGroup = taskGroups.find(g => g.id === seq.prerequisite_group_id);
                const unlockGroup = taskGroups.find(g => g.id === seq.unlock_group_id);

                return `
                    <div class="sequence-item">
                        <div class="sequence-header">
                            <div>
                                <div class="sequence-title">${seq.sequence_name}</div>
                                <div class="sequence-flow">
                                    When <strong>${prerequisiteGroup?.group_name || 'Unknown Group'}</strong> is completed → 
                                    Show <strong>${unlockGroup?.group_name || 'Unknown Group'}</strong>
                                </div>
                                ${seq.description ? `<div class="flow-text">${seq.description}</div>` : ''}
                            </div>
                            <div class="sequence-actions">
                                <button class="btn btn-small btn-secondary" onclick="editSequence(${seq.id})">Edit</button>
                                <button class="btn btn-small btn-danger" onclick="deleteSequence(${seq.id})">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            list.innerHTML = sequenceHtml;
        }

        function addNewSequence() {
            console.log('addNewSequence called');
            
            // Switch to edit panel and force visibility
            document.getElementById('taskSequencesPanel').style.display = 'none';
            
            const container = document.getElementById('container');
            const editPanel = document.getElementById('editPanel');
            
            // Make edit panel a centered modal
            editPanel.style.position = 'fixed';
            editPanel.style.top = '50%';
            editPanel.style.left = '50%';
            editPanel.style.transform = 'translate(-50%, -50%)';
            editPanel.style.width = '600px';
            editPanel.style.maxWidth = '90vw';
            editPanel.style.maxHeight = '80vh';
            editPanel.style.overflowY = 'auto';
            editPanel.style.zIndex = '1000';
            editPanel.style.display = 'block';
            editPanel.style.visibility = 'visible';
            editPanel.style.opacity = '1';
            editPanel.style.background = 'white';
            editPanel.style.padding = '24px';
            editPanel.style.borderRadius = '12px';
            editPanel.style.boxShadow = '0 10px 25px rgba(0, 0, 0, 0.2)';
            editPanel.style.border = '1px solid #E5E7EB';
            
            // Add dark overlay behind modal
            const overlay = document.createElement('div');
            overlay.id = 'modalOverlay';
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            overlay.style.zIndex = '999';
            overlay.onclick = () => cancelSequenceForm();
            document.body.appendChild(overlay);
            
            document.getElementById('editTitle').textContent = 'Add New Sequence';
            
            // Override the close button to call our cancel function
            const closeBtn = editPanel.querySelector('.close-btn');
            if (closeBtn) {
                closeBtn.onclick = cancelSequenceForm;
            }
            
            console.log('Edit panel display after setting:', editPanel.style.display);
            console.log('Panel switched, calling showSimpleSequenceForm...');
            
            // Add a delay to ensure panel switching is complete
            setTimeout(() => {
                console.log('Delayed call to showSimpleSequenceForm');
                console.log('Edit panel display in timeout:', document.getElementById('editPanel').style.display);
                
                // Force the panel to stay visible
                document.getElementById('editPanel').style.display = 'block';
                console.log('Edit panel forced to block in timeout');
                
                // Try simple form first without async
                const form = document.getElementById('taskForm');
                if (!form) {
                    console.error('Form not found!');
                    return;
                }
                
                console.log('Setting simple test form...');
                form.innerHTML = `
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="editSequenceName" style="display: block; margin-bottom: 8px; font-weight: 600;">Sequence Name</label>
                        <input type="text" id="editSequenceName" required style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="editTargetType" style="display: block; margin-bottom: 8px; font-weight: 600;">Who does this sequence apply to?</label>
                        <select id="editTargetType" required style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px;" onchange="toggleUserGroupSelection()">
                            <option value="groups" selected>User Groups</option>
                            <option value="manual">Manual Task Assignment</option>
                        </select>
                    </div>
                    
                    <div id="userGroupSelection" class="form-group" style="margin-bottom: 20px; display: none;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Select User Group</label>
                        <select id="editUserGroup" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px;">
                            <option value="">Loading user groups...</option>
                        </select>
                        <small style="color: #6B7280; display: block; margin-top: 4px;">This sequence will only apply to users in the selected User Group.</small>
                    </div>
                    
                    <div id="manualTaskInfo" class="form-group" style="margin-bottom: 20px; display: none; padding: 16px; background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="font-size: 18px;">⚠️</span>
                            <strong style="color: #92400E;">Manual Task Assignment</strong>
                        </div>
                        <p style="color: #92400E; margin: 0; font-size: 14px;">
                            Tasks in this sequence will not be automatically assigned. You'll need to manually assign them to users through the Task Groups interface.
                        </p>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="editSequenceDescription" style="display: block; margin-bottom: 8px; font-weight: 600;">Description (optional)</label>
                        <textarea id="editSequenceDescription" rows="2" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; resize: vertical;" placeholder="Describe what this sequence does"></textarea>
                    </div>
                    
                    <div style="border: 2px solid #E5E7EB; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 16px 0; color: #374151;">Task Group Sequence</h4>
                        
                        <div id="sequenceSteps">
                            <div class="sequence-step" data-step="1" style="background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 6px; padding: 16px; margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <strong style="color: #374151;">Step 1</strong>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500;">When this group is completed:</label>
                                        <select class="prerequisite-group" required style="width: 100%; padding: 8px; border: 1px solid #E5E7EB; border-radius: 4px; font-size: 14px;">
                                            <option value="">Loading groups...</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500;">Show this group:</label>
                                        <select class="unlock-group" required style="width: 100%; padding: 8px; border: 1px solid #E5E7EB; border-radius: 4px; font-size: 14px;">
                                            <option value="">Loading groups...</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" onclick="addSequenceStep()" style="width: 100%; padding: 12px; border: 2px dashed #D1D5DB; background: transparent; border-radius: 6px; color: #6B7280; font-weight: 500; cursor: pointer; transition: all 0.2s;">
                            + Add Another Step
                        </button>
                    </div>
                    
                    <div style="border: 2px solid #10B981; border-radius: 8px; padding: 16px; margin-bottom: 20px; background: rgba(16, 185, 129, 0.05);">
                        <h4 style="margin: 0 0 12px 0; color: #065F46; display: flex; align-items: center; gap: 8px;">
                            🎓 Graduate Users (Optional)
                        </h4>
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <input type="checkbox" id="enableGraduation" style="width: 18px; height: 18px; accent-color: #10B981;" onchange="toggleGraduationOptions()">
                            <label for="enableGraduation" style="font-weight: 500; color: #374151; cursor: pointer;">
                                Move users to a new group after completing all tasks in this sequence
                            </label>
                        </div>
                        
                        <div id="graduationOptions" style="display: none;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #065F46;">Graduate users to this group:</label>
                            <select id="graduationGroup" style="width: 100%; padding: 12px; border: 2px solid #10B981; border-radius: 8px;">
                                <option value="">Select graduation group...</option>
                            </select>
                            <small style="color: #047857; display: block; margin-top: 4px;">
                                When users complete ALL tasks in the final step, they'll automatically be moved to this user group.
                            </small>
                        </div>
                    </div>
                    
                    <div class="form-actions" style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid #E5E7EB;">
                        <button type="button" class="btn btn-secondary" onclick="cancelSequenceForm()" style="padding: 12px 24px;">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveAdvancedSequenceForm()" style="padding: 12px 24px;">Save Sequence</button>
                    </div>
                `;
                
                console.log('Simple form set, now loading task groups...');
                
                // Load task groups and user groups
                Promise.all([
                    supabaseClient.from('task_groups').select('*').eq('is_active', true).order('display_order'),
                    supabaseClient.from('user_groups').select('*').order('group_name')
                ]).then(([taskGroupsResult, userGroupsResult]) => {
                    console.log('Task groups loaded:', taskGroupsResult);
                    console.log('User groups loaded:', userGroupsResult);
                    
                    // Populate task group dropdowns
                    if (taskGroupsResult.data) {
                        const taskGroupOptions = taskGroupsResult.data.map(group => 
                            `<option value="${group.id}">${group.group_name}</option>`
                        ).join('');
                        
                        // Update all task group selects
                        document.querySelectorAll('.prerequisite-group, .unlock-group').forEach(select => {
                            const isPrerequisite = select.classList.contains('prerequisite-group');
                            select.innerHTML = (isPrerequisite ? 
                                '<option value="">Select prerequisite group...</option>' : 
                                '<option value="">Select group to show...</option>'
                            ) + taskGroupOptions;
                        });
                    }
                    
                    // Populate user group dropdown (excluding "All users" and "Default Group")
                    if (userGroupsResult.data) {
                        const userGroupOptions = userGroupsResult.data
                            .filter(group => {
                                const nameLower = group.group_name.toLowerCase();
                                return nameLower !== 'all users' && nameLower !== 'default group';
                            })
                            .map(group => 
                                `<option value="${group.id}">${group.group_name}${group.group_description ? ' - ' + group.group_description : ''}</option>`
                            ).join('');
                        
                        document.getElementById('editUserGroup').innerHTML = '<option value="">Select user group...</option>' + userGroupOptions;
                        document.getElementById('graduationGroup').innerHTML = '<option value="">Select graduation group...</option>' + userGroupOptions;
                    }
                }).catch(error => {
                    console.error('Error loading groups:', error);
                });
                
            }, 100);
        }

        async function editSequence(sequenceId) {
            console.log('editSequence called with ID:', sequenceId);
            
            try {
                const { data: sequence, error } = await supabaseClient
                    .from('task_group_sequences')
                    .select('*')
                    .eq('id', sequenceId)
                    .single();

                if (error) throw error;

                console.log('Sequence loaded:', sequence);

                // Switch to edit panel
                document.getElementById('taskSequencesPanel').style.display = 'none';
                document.getElementById('editPanel').style.display = 'block';
                document.getElementById('editTitle').textContent = 'Edit Sequence';
                
                console.log('Edit panel display set to:', document.getElementById('editPanel').style.display);
                
                // Force panel visible as full overlay
                const container = document.getElementById('container');
                const editPanel = document.getElementById('editPanel');
                
                // Make edit panel a centered modal
                editPanel.style.position = 'fixed';
                editPanel.style.top = '50%';
                editPanel.style.left = '50%';
                editPanel.style.transform = 'translate(-50%, -50%)';
                editPanel.style.width = '600px';
                editPanel.style.maxWidth = '90vw';
                editPanel.style.maxHeight = '80vh';
                editPanel.style.overflowY = 'auto';
                editPanel.style.zIndex = '1000';
                editPanel.style.display = 'block';
                editPanel.style.visibility = 'visible';
                editPanel.style.opacity = '1';
                editPanel.style.background = 'white';
                editPanel.style.padding = '24px';
                editPanel.style.borderRadius = '12px';
                editPanel.style.boxShadow = '0 10px 25px rgba(0, 0, 0, 0.2)';
                editPanel.style.border = '1px solid #E5E7EB';
                
                // Add dark overlay behind modal
                const overlay = document.createElement('div');
                overlay.id = 'modalOverlay';
                overlay.style.position = 'fixed';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.width = '100%';
                overlay.style.height = '100%';
                overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                overlay.style.zIndex = '999';
                overlay.onclick = () => cancelSequenceForm();
                document.body.appendChild(overlay);
                
                // Override the close button to call our cancel function
                const closeBtn = editPanel.querySelector('.close-btn');
                if (closeBtn) {
                    closeBtn.onclick = cancelSequenceForm;
                }
                
                console.log('Panel forced visible, calling showSimpleSequenceForm...');
                
                // Show form with data
                showSimpleSequenceForm(sequence);

            } catch (error) {
                console.error('Error loading sequence for edit:', error);
                showError('Failed to load sequence: ' + error.message);
            }
        }

        async function deleteSequence(sequenceId) {
            if (!confirm('Are you sure you want to delete this sequence?')) return;
            
            try {
                const { error } = await supabaseClient
                    .from('task_group_sequences')
                    .delete()
                    .eq('id', sequenceId);

                if (error) throw error;

                showSuccess('Sequence deleted successfully!');
                await loadTaskSequences();

            } catch (error) {
                console.error('Error deleting sequence:', error);
                showError('Failed to delete sequence: ' + error.message);
            }
        }

        async function showSimpleSequenceForm(sequence = null) {
            console.log('showSimpleSequenceForm called with:', sequence);
            
            try {
                // Load task groups for dropdowns
                console.log('Loading task groups...');
                const { data: taskGroups, error } = await supabaseClient
                    .from('task_groups')
                    .select('*')
                    .eq('is_active', true)
                    .order('display_order');

                console.log('Task groups result:', { data: taskGroups, error });
                
                if (error) {
                    console.error('Task groups error:', error);
                    throw error;
                }

                // Get the form element
                const form = document.getElementById('taskForm');
                console.log('Form element found:', !!form);
                
                if (!form) {
                    throw new Error('Form element not found');
                }
                
                console.log('Setting form innerHTML...');
                form.innerHTML = `
                    <input type="hidden" id="editSequenceId" value="${sequence ? sequence.id : ''}">
                    
                    <div class="form-group">
                        <label for="editSequenceName">Sequence Name</label>
                        <input type="text" id="editSequenceName" value="${sequence ? sequence.sequence_name : ''}" required>
                    </div>

                    <div class="form-group">
                        <label for="editSequenceDescription">Description (optional)</label>
                        <textarea id="editSequenceDescription" rows="2" placeholder="Describe what this sequence does">${sequence ? (sequence.description || '') : ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label for="editPrerequisiteGroup">When this group is completed:</label>
                        <select id="editPrerequisiteGroup" required>
                            <option value="">Select prerequisite group...</option>
                            ${taskGroups.map(group => `
                                <option value="${group.id}" ${sequence && sequence.prerequisite_group_id === group.id ? 'selected' : ''}>
                                    ${group.group_name}
                                </option>
                            `).join('')}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="editUnlockGroup">Show this group:</label>
                        <select id="editUnlockGroup" required>
                            <option value="">Select group to show...</option>
                            ${taskGroups.map(group => `
                                <option value="${group.id}" ${sequence && sequence.unlock_group_id === group.id ? 'selected' : ''}>
                                    ${group.group_name}
                                </option>
                            `).join('')}
                        </select>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="cancelSequenceForm()">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            ${sequence ? 'Update' : 'Create'} Sequence
                        </button>
                    </div>
                `;

                // Set up form submission
                form.onsubmit = saveSequenceForm;
                console.log('Form setup complete');

            } catch (error) {
                console.error('Error in showSimpleSequenceForm:', error);
                showError('Failed to load form: ' + error.message);
            }
        }

        // Toggle user group selection visibility
        function toggleUserGroupSelection() {
            const targetType = document.getElementById('editTargetType').value;
            const userGroupSelection = document.getElementById('userGroupSelection');
            const manualTaskInfo = document.getElementById('manualTaskInfo');
            
            // Hide all first
            userGroupSelection.style.display = 'none';
            manualTaskInfo.style.display = 'none';
            
            if (targetType === 'groups') {
                userGroupSelection.style.display = 'block';
            } else if (targetType === 'manual') {
                manualTaskInfo.style.display = 'block';
            }
        }

        // Toggle graduation options
        function toggleGraduationOptions() {
            const enableGraduation = document.getElementById('enableGraduation').checked;
            const graduationOptions = document.getElementById('graduationOptions');
            
            if (enableGraduation) {
                graduationOptions.style.display = 'block';
            } else {
                graduationOptions.style.display = 'none';
            }
        }

        // Add another sequence step
        function addSequenceStep() {
            const stepsContainer = document.getElementById('sequenceSteps');
            const stepCount = stepsContainer.children.length + 1;
            
            const newStep = document.createElement('div');
            newStep.className = 'sequence-step';
            newStep.setAttribute('data-step', stepCount);
            newStep.style.cssText = 'background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 6px; padding: 16px; margin-bottom: 12px;';
            
            newStep.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <strong style="color: #374151;">Step ${stepCount}</strong>
                    <button type="button" onclick="removeSequenceStep(this)" style="background: none; border: none; color: #EF4444; cursor: pointer; font-size: 18px; padding: 4px;" title="Remove step">×</button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                        <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500;">When this group is completed:</label>
                        <select class="prerequisite-group" required style="width: 100%; padding: 8px; border: 1px solid #E5E7EB; border-radius: 4px; font-size: 14px;">
                            <option value="">Select prerequisite group...</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500;">Show this group:</label>
                        <select class="unlock-group" required style="width: 100%; padding: 8px; border: 1px solid #E5E7EB; border-radius: 4px; font-size: 14px;">
                            <option value="">Select group to show...</option>
                        </select>
                    </div>
                </div>
            `;
            
            stepsContainer.appendChild(newStep);
            
            // Populate the new dropdowns with existing task group options
            const existingOptions = document.querySelector('.prerequisite-group').innerHTML;
            newStep.querySelector('.prerequisite-group').innerHTML = existingOptions;
            newStep.querySelector('.unlock-group').innerHTML = existingOptions.replace('Select prerequisite group...', 'Select group to show...');
            
            console.log(`Added step ${stepCount}`);
        }

        // Remove a sequence step
        function removeSequenceStep(button) {
            const step = button.closest('.sequence-step');
            const stepsContainer = document.getElementById('sequenceSteps');
            
            // Don't allow removing if only one step left
            if (stepsContainer.children.length <= 1) {
                alert('You must have at least one step in the sequence.');
                return;
            }
            
            step.remove();
            
            // Renumber remaining steps
            Array.from(stepsContainer.children).forEach((step, index) => {
                const stepNumber = index + 1;
                step.setAttribute('data-step', stepNumber);
                step.querySelector('strong').textContent = `Step ${stepNumber}`;
            });
            
            console.log('Step removed and renumbered');
        }

        // Save the advanced sequence form
        async function saveAdvancedSequenceForm() {
            try {
                const sequenceId = document.getElementById('editSequenceId')?.value;
                const sequenceName = document.getElementById('editSequenceName').value;
                const description = document.getElementById('editSequenceDescription').value;
                const targetType = document.getElementById('editTargetType').value;
                
                // Get target user group
                let targetGroup = null;
                if (targetType === 'groups') {
                    const userGroupSelect = document.getElementById('editUserGroup');
                    if (!userGroupSelect.value) {
                        alert('Please select a user group or choose a different target type.');
                        return;
                    }
                    targetGroup = parseInt(userGroupSelect.value);
                }
                
                // Get graduation group if enabled
                let graduationGroup = null;
                if (document.getElementById('enableGraduation').checked) {
                    const graduationSelect = document.getElementById('graduationGroup');
                    if (!graduationSelect.value) {
                        alert('Please select a graduation group or disable graduation.');
                        return;
                    }
                    graduationGroup = parseInt(graduationSelect.value);
                }
                
                // Get sequence steps
                const steps = [];
                document.querySelectorAll('.sequence-step').forEach(stepDiv => {
                    const prerequisiteSelect = stepDiv.querySelector('.prerequisite-group');
                    const unlockSelect = stepDiv.querySelector('.unlock-group');
                    
                    if (!prerequisiteSelect.value || !unlockSelect.value) {
                        throw new Error('Please fill in all sequence steps.');
                    }
                    
                    steps.push({
                        prerequisite_group_id: parseInt(prerequisiteSelect.value),
                        unlock_group_id: parseInt(unlockSelect.value)
                    });
                });
                
                if (steps.length === 0) {
                    throw new Error('Please add at least one sequence step.');
                }
                
                console.log('Saving sequence with steps:', steps);
                
                // For now, we'll save the first step as the main sequence
                // TODO: Implement multi-step sequences in database
                const formData = {
                    sequence_name: sequenceName,
                    description: description || null,
                    prerequisite_group_id: steps[0].prerequisite_group_id,
                    unlock_group_id: steps[0].unlock_group_id,
                    applies_to: targetType,
                    target_groups: targetType === 'groups' ? [targetGroup] : [],
                    target_locations: [],
                    target_users: [],
                    graduation_group_id: graduationGroup,
                    is_active: true,
                    updated_at: new Date().toISOString()
                };
                
                let result;
                if (sequenceId) {
                    result = await supabaseClient
                        .from('task_group_sequences')
                        .update(formData)
                        .eq('id', sequenceId)
                        .select();
                } else {
                    result = await supabaseClient
                        .from('task_group_sequences')
                        .insert([formData])
                        .select();
                }
                
                if (result.error) throw result.error;
                
                showSuccess(`Sequence ${sequenceId ? 'updated' : 'created'} successfully!`);
                
                setTimeout(() => {
                    cancelSequenceForm();
                    loadTaskSequences();
                }, 1000);
                
            } catch (error) {
                console.error('Error saving advanced sequence:', error);
                showError('Failed to save sequence: ' + error.message);
            }
        }

        function cancelSequenceForm() {
            const editPanel = document.getElementById('editPanel');
            
            // Reset panel styles
            editPanel.style.position = '';
            editPanel.style.top = '';
            editPanel.style.left = '';
            editPanel.style.transform = '';
            editPanel.style.width = '';
            editPanel.style.maxWidth = '';
            editPanel.style.maxHeight = '';
            editPanel.style.overflowY = '';
            editPanel.style.zIndex = '';
            editPanel.style.background = '';
            editPanel.style.padding = '';
            editPanel.style.borderRadius = '';
            editPanel.style.boxShadow = '';
            editPanel.style.border = '';
            editPanel.style.display = 'none';
            
            // Remove overlay
            const overlay = document.getElementById('modalOverlay');
            if (overlay) {
                document.body.removeChild(overlay);
            }
            
            document.getElementById('taskSequencesPanel').style.display = 'block';
            updateNavigationActive('task-sequences');
        }

        function cancelTaskGroupForm() {
            const editPanel = document.getElementById('editPanel');
            
            // Reset panel styles
            editPanel.style.position = '';
            editPanel.style.top = '';
            editPanel.style.left = '';
            editPanel.style.transform = '';
            editPanel.style.width = '';
            editPanel.style.maxWidth = '';
            editPanel.style.maxHeight = '';
            editPanel.style.overflowY = '';
            editPanel.style.zIndex = '';
            editPanel.style.background = '';
            editPanel.style.padding = '';
            editPanel.style.borderRadius = '';
            editPanel.style.boxShadow = '';
            editPanel.style.border = '';
            editPanel.style.display = 'none';
            
            // Remove overlay
            const overlay = document.getElementById('modalOverlay');
            if (overlay) {
                document.body.removeChild(overlay);
            }
            
            document.getElementById('taskGroupsMainPanel').style.display = 'block';
            updateNavigationActive('task-groups');
        }

        async function saveSequenceForm(e) {
            e.preventDefault();

            try {
                const sequenceId = document.getElementById('editSequenceId').value;
                const formData = {
                    sequence_name: document.getElementById('editSequenceName').value,
                    description: document.getElementById('editSequenceDescription').value || null,
                    prerequisite_group_id: parseInt(document.getElementById('editPrerequisiteGroup').value),
                    unlock_group_id: parseInt(document.getElementById('editUnlockGroup').value),
                    applies_to: 'all',
                    target_groups: [],
                    target_locations: [],
                    target_users: [],
                    is_active: true,
                    updated_at: new Date().toISOString()
                };

                let result;
                if (sequenceId) {
                    // Update existing sequence
                    result = await supabaseClient
                        .from('task_group_sequences')
                        .update(formData)
                        .eq('id', sequenceId)
                        .select();
                } else {
                    // Create new sequence
                    result = await supabaseClient
                        .from('task_group_sequences')
                        .insert([formData])
                        .select();
                }

                if (result.error) throw result.error;

                showSuccess(sequenceId ? 'Sequence updated successfully!' : 'Sequence created successfully!');
                
                // Return to sequences list
                setTimeout(() => {
                    document.getElementById('editPanel').style.display = 'none';
                    document.getElementById('taskSequencesPanel').style.display = 'block';
                    updateNavigationActive('task-sequences');
                    loadTaskSequences();
                }, 1000);

            } catch (error) {
                console.error('Error saving sequence:', error);
                showError('Failed to save sequence: ' + error.message);
            }
        }

        // Task Management Functions
        
        // Initialize drag and drop functionality
        function initTaskDragAndDrop() {
            const tasksList = document.getElementById('currentTasksList');
            if (!tasksList) return;
            
            let draggedElement = null;
            let draggedTaskId = null;
            
            // Add event listeners to task items
            function updateDragListeners() {
                const taskItems = tasksList.querySelectorAll('.task-item');
                taskItems.forEach(item => {
                    item.setAttribute('draggable', true);
                    
                    item.addEventListener('dragstart', (e) => {
                        draggedElement = e.target;
                        draggedTaskId = e.target.getAttribute('data-task-id');
                        e.target.style.opacity = '0.5';
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/html', e.target.outerHTML);
                    });
                    
                    item.addEventListener('dragend', (e) => {
                        e.target.style.opacity = '1';
                        draggedElement = null;
                        draggedTaskId = null;
                    });
                    
                    item.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                        
                        const afterElement = getDragAfterElement(tasksList, e.clientY);
                        if (afterElement == null) {
                            tasksList.appendChild(draggedElement);
                        } else {
                            tasksList.insertBefore(draggedElement, afterElement);
                        }
                    });
                    
                    item.addEventListener('drop', (e) => {
                        e.preventDefault();
                        updateTaskPositionsAfterDrag();
                    });
                });
            }
            
            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.task-item:not(.dragging)')];
                
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }
            
            async function updateTaskPositionsAfterDrag() {
                const taskItems = tasksList.querySelectorAll('.task-item');
                const updates = [];
                
                taskItems.forEach((item, index) => {
                    const taskId = parseInt(item.getAttribute('data-task-id'));
                    updates.push({
                        id: taskId,
                        position: index + 1
                    });
                });
                
                try {
                    // Update positions in database
                    for (const update of updates) {
                        const { error } = await supabaseClient
                            .from('onboarding_tasks')
                            .update({ position: update.position })
                            .eq('id', update.id);
                        
                        if (error) throw error;
                    }
                    
                    console.log('Task positions updated successfully');
                } catch (error) {
                    console.error('Error updating task positions:', error);
                    showError('Failed to save new task order');
                }
            }
            
            updateDragListeners();
        }
        
        // Add existing task to group
        async function addExistingTaskToGroup() {
            const select = document.getElementById('existingTaskSelect');
            const taskId = select.value;
            
            if (!taskId) {
                showError('Please select a task to add');
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('onboarding_tasks')
                    .update({ task_group_id: currentAssignmentGroupId })
                    .eq('id', taskId);
                
                if (error) throw error;
                
                showSuccess('Task added to group successfully!');
                
                // Refresh the interface
                setTimeout(() => {
                    const groupName = document.getElementById('editTitle').textContent.replace('Manage Tasks: ', '');
                    showTaskManagementInterface(currentAssignmentGroupId, groupName);
                }, 1000);
                
            } catch (error) {
                console.error('Error adding task to group:', error);
                showError('Failed to add task to group: ' + error.message);
            }
        }
        
        // Remove task from group
        async function removeTaskFromGroup(taskId) {
            if (!confirm('Remove this task from the group? (The task will still exist, just not be assigned to this group)')) {
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('onboarding_tasks')
                    .update({ task_group_id: null })
                    .eq('id', taskId);
                
                if (error) throw error;
                
                showSuccess('Task removed from group successfully!');
                
                // Refresh the interface
                setTimeout(() => {
                    const groupName = document.getElementById('editTitle').textContent.replace('Manage Tasks: ', '');
                    showTaskManagementInterface(currentAssignmentGroupId, groupName);
                }, 1000);
                
            } catch (error) {
                console.error('Error removing task from group:', error);
                showError('Failed to remove task from group: ' + error.message);
            }
        }
        
        // Show create task form
        function showCreateTaskForm(groupId) {
            const editPanelContent = document.querySelector('#editPanel form');
            editPanelContent.innerHTML = `
                <h3>Create New Task for Group</h3>
                
                <div class="form-group" style="margin-bottom: 16px;">
                    <label for="newTaskTitle" style="display: block; margin-bottom: 8px; font-weight: 500;">Task Title</label>
                    <input type="text" id="newTaskTitle" required style="width: 100%; padding: 12px; border: 1px solid #E5E7EB; border-radius: 4px;" placeholder="Enter task title...">
                </div>
                
                <div class="form-group" style="margin-bottom: 16px;">
                    <label for="newTaskDescription" style="display: block; margin-bottom: 8px; font-weight: 500;">Description</label>
                    <textarea id="newTaskDescription" rows="3" style="width: 100%; padding: 12px; border: 1px solid #E5E7EB; border-radius: 4px; resize: vertical;" placeholder="Describe what this task involves..."></textarea>
                </div>
                
                <div class="form-group" style="margin-bottom: 16px;">
                    <label for="newTaskInstructions" style="display: block; margin-bottom: 8px; font-weight: 500;">Instructions Title</label>
                    <input type="text" id="newTaskInstructions" style="width: 100%; padding: 12px; border: 1px solid #E5E7EB; border-radius: 4px;" placeholder="Instructions title...">
                </div>
                
                <div class="form-group" style="margin-bottom: 16px;">
                    <label for="newTaskContent" style="display: block; margin-bottom: 8px; font-weight: 500;">Instruction Content</label>
                    <textarea id="newTaskContent" rows="4" style="width: 100%; padding: 12px; border: 1px solid #E5E7EB; border-radius: 4px; resize: vertical;" placeholder="Detailed instructions for the user..."></textarea>
                </div>
                
                <div class="form-group" style="margin-bottom: 16px;">
                    <label for="newTaskVideoUrl" style="display: block; margin-bottom: 8px; font-weight: 500;">Video URL (optional)</label>
                    <input type="url" id="newTaskVideoUrl" style="width: 100%; padding: 12px; border: 1px solid #E5E7EB; border-radius: 4px;" placeholder="https://youtube.com/watch?v=... or https://vimeo.com/...">
                    <small style="color: #6B7280;">Add a YouTube or Vimeo video URL for this task</small>
                </div>
                
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="newTaskHasFormEmbed" onchange="toggleNewTaskFormEmbed()" style="width: 16px; height: 16px;">
                        <span style="font-weight: 500;">Include Embedded Form</span>
                    </label>
                </div>
                
                <div class="form-group" id="newTaskFormEmbedGroup" style="display: none; margin-bottom: 16px;">
                    <label for="newTaskFormEmbedCode" style="display: block; margin-bottom: 8px; font-weight: 500;">Form Embed Code</label>
                    <textarea id="newTaskFormEmbedCode" rows="5" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 13px;" placeholder="Paste your complete form embed code here (iframe and script tags)..."></textarea>
                    <small style="color: #6B7280;">Paste the complete embed code including iframe and script tags</small>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-primary" onclick="createNewTask(${groupId})">Create Task</button>
                    <button type="button" class="btn btn-secondary" onclick="backToTaskManagement(${groupId})">Back</button>
                </div>
            `;
            
            // Initialize form embed toggle for new task form
            window.toggleNewTaskFormEmbed = function() {
                const checkbox = document.getElementById('newTaskHasFormEmbed');
                const embedGroup = document.getElementById('newTaskFormEmbedGroup');
                embedGroup.style.display = checkbox.checked ? 'block' : 'none';
            };
        }
        
        // Create new task
        async function createNewTask(groupId) {
            try {
                const title = document.getElementById('newTaskTitle').value;
                const taskId = generateTaskId(); // Auto-generate task ID
                const description = document.getElementById('newTaskDescription').value;
                const instructionTitle = document.getElementById('newTaskInstructions').value;
                const instructionContent = document.getElementById('newTaskContent').value;
                const videoUrl = document.getElementById('newTaskVideoUrl').value;
                const hasFormEmbed = document.getElementById('newTaskHasFormEmbed').checked;
                const formEmbedCode = document.getElementById('newTaskFormEmbedCode').value;
                
                if (!title) {
                    showError('Title is required');
                    return;
                }
                
                // Get next position for this group
                const { data: existingTasks, error: countError } = await supabaseClient
                    .from('onboarding_tasks')
                    .select('position')
                    .eq('task_group_id', groupId)
                    .order('position', { ascending: false })
                    .limit(1);
                
                if (countError) throw countError;
                
                const nextPosition = existingTasks && existingTasks.length > 0 ? existingTasks[0].position + 1 : 1;
                
                const taskData = {
                    task_id: taskId,
                    title: title,
                    description: description || null,
                    instruction_title: instructionTitle || title,
                    instruction_content: instructionContent || null,
                    video_url: videoUrl || null,
                    form_embed_code: hasFormEmbed && formEmbedCode ? formEmbedCode : null,
                    position: nextPosition,
                    task_group_id: groupId,
                    is_active: true,
                    target_type: 'groups',
                    target_groups: '[]'
                };
                
                const { error } = await supabaseClient
                    .from('onboarding_tasks')
                    .insert([cleanDataForSupabase(taskData)]);
                
                if (error) throw error;
                
                showSuccess('Task created successfully!');
                
                // Go back to task management
                setTimeout(() => {
                    backToTaskManagement(groupId);
                }, 1000);
                
            } catch (error) {
                console.error('Error creating task:', error);
                showError('Failed to create task: ' + error.message);
            }
        }
        
        // Back to task management
        function backToTaskManagement(groupId) {
            const groupName = document.getElementById('editTitle').textContent.replace('Manage Tasks: ', '');
            showTaskManagementInterface(groupId, groupName);
        }
        
        // Edit task in group
        async function editTaskInGroup(taskId) {
            try {
                // Load the task data
                const { data: task, error } = await supabaseClient
                    .from('onboarding_tasks')
                    .select('*')
                    .eq('id', taskId)
                    .single();
                
                if (error) throw error;
                if (!task) {
                    showError('Task not found');
                    return;
                }
                
                // Close the manage tasks modal
                cancelTaskGroupForm();
                
                // Open the task editing modal
                showTaskModal(task);
                
            } catch (error) {
                console.error('Error loading task for editing:', error);
                showError('Failed to load task: ' + error.message);
            }
        }
        
        // Reorder tasks alphabetically
        async function reorderTasksByTitle() {
            try {
                const { data: tasks, error } = await supabaseClient
                    .from('onboarding_tasks')
                    .select('*')
                    .eq('task_group_id', currentAssignmentGroupId);
                
                if (error) throw error;
                
                if (!tasks || tasks.length === 0) {
                    showError('No tasks to reorder');
                    return;
                }
                
                // Sort by title
                const sortedTasks = tasks.sort((a, b) => a.title.localeCompare(b.title));
                
                // Update positions
                for (let i = 0; i < sortedTasks.length; i++) {
                    const { error: updateError } = await supabaseClient
                        .from('onboarding_tasks')
                        .update({ position: i + 1 })
                        .eq('id', sortedTasks[i].id);
                    
                    if (updateError) throw updateError;
                }
                
                showSuccess('Tasks reordered alphabetically!');
                
                // Refresh interface
                setTimeout(() => {
                    const groupName = document.getElementById('editTitle').textContent.replace('Manage Tasks: ', '');
                    showTaskManagementInterface(currentAssignmentGroupId, groupName);
                }, 1000);
                
            } catch (error) {
                console.error('Error reordering tasks:', error);
                showError('Failed to reorder tasks: ' + error.message);
            }
        }
        
        // Reset task positions to 1, 2, 3, etc.
        async function resetTaskPositions() {
            try {
                const { data: tasks, error } = await supabaseClient
                    .from('onboarding_tasks')
                    .select('*')
                    .eq('task_group_id', currentAssignmentGroupId)
                    .order('position');
                
                if (error) throw error;
                
                if (!tasks || tasks.length === 0) {
                    showError('No tasks to reset positions for');
                    return;
                }
                
                // Update positions sequentially
                for (let i = 0; i < tasks.length; i++) {
                    const { error: updateError } = await supabaseClient
                        .from('onboarding_tasks')
                        .update({ position: i + 1 })
                        .eq('id', tasks[i].id);
                    
                    if (updateError) throw updateError;
                }
                
                showSuccess('Task positions reset successfully!');
                
                // Refresh interface
                setTimeout(() => {
                    const groupName = document.getElementById('editTitle').textContent.replace('Manage Tasks: ', '');
                    showTaskManagementInterface(currentAssignmentGroupId, groupName);
                }, 1000);
                
            } catch (error) {
                console.error('Error resetting task positions:', error);
                showError('Failed to reset task positions: ' + error.message);
            }
        }

        // Toggle User Groups Panel
        function toggleUserGroupsPanel() {
            const userGroupsPanel = document.getElementById('userGroupsMainPanel');
            const tasksPanel = document.getElementById('tasksPanel');
            const button = document.getElementById('userGroupsToggleBtn');
            
            if (userGroupsPanel.style.display === 'none' || !userGroupsPanel.style.display) {
                // Show User Groups panel
                userGroupsPanel.style.display = 'block';
                tasksPanel.style.display = 'none';
                button.innerHTML = '<i data-lucide="arrow-left" style="width: 16px; height: 16px; margin-right: 6px;"></i>Back to Tasks';
                document.querySelector('.page-title').textContent = 'User Groups Management';
                loadUserGroupsMain();
            } else {
                // Hide User Groups panel
                userGroupsPanel.style.display = 'none';
                tasksPanel.style.display = 'block';
                button.innerHTML = '<i data-lucide="users" style="width: 16px; height: 16px; margin-right: 6px;"></i>User Groups';
                document.querySelector('.page-title').textContent = 'Task Management';
            }
            
            // Refresh Lucide icons
            setTimeout(() => lucide.createIcons(), 0);
        }
        
        // User Groups Management Functions
        let allUserGroupsData = [];

        // Open user groups management panel
        async function openUserGroupsMain() {
            // Hide all other panels
            document.getElementById('tasksPanel').style.display = 'none';
            document.getElementById('taskGroupsMainPanel').style.display = 'none';
            document.getElementById('taskSequencesPanel').style.display = 'none';
            document.getElementById('editPanel').style.display = 'none';
            
            // Show user groups panel
            document.getElementById('userGroupsMainPanel').style.display = 'block';
            document.getElementById('userGroupsMainTitle').textContent = 'User Groups Management';
            
            // Update page title
            document.querySelector('.page-title').textContent = 'User Groups Management';
            
            // Load user groups data
            await loadUserGroupsMain();
        }

        // Load user groups from database
        async function loadUserGroupsMain() {
            try {
                const { data, error } = await supabaseClient
                    .from('user_groups')
                    .select('*')
                    .order('group_name');

                if (error) throw error;
                
                allUserGroupsData = data || [];
                renderUserGroupsMain();
            } catch (error) {
                console.error('Error loading user groups:', error);
                document.getElementById('userGroupsMainList').innerHTML = '<div class="error">Failed to load user groups</div>';
            }
        }

        // Render user groups list
        function renderUserGroupsMain() {
            const userGroupsList = document.getElementById('userGroupsMainList');
            
            if (allUserGroupsData.length === 0) {
                userGroupsList.innerHTML = '<div class="loading">No user groups found. Create your first user group!</div>';
                return;
            }

            userGroupsList.innerHTML = allUserGroupsData.map((group, index) => {
                const cardColor = group.card_color || '#f1f5f9';
                // Generate the full URL with all parameters including HighLevel custom fields format
                const baseUrl = window.location.origin + '/onboarding.html';
                const fullUrl = `${baseUrl}?email={{contact.email}}&location={{location.id}}&user_group=${encodeURIComponent(group.group_name)}`;
                
                return `
                    <div class="user-group-card" style="background: ${cardColor}; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; margin-bottom: 12px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s; position: relative;">
                        <div style="display: flex; justify-content: between; align-items: flex-start; gap: 16px;">
                            <!-- Left section: Icon and main info -->
                            <div style="display: flex; align-items: flex-start; gap: 12px; flex: 1;">
                                <div style="margin-top: 2px;"><i data-lucide="users" style="width: 24px; height: 24px; color: #4b5563;"></i></div>
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <h3 style="margin: 0; color: #1f2937; font-size: 18px; font-weight: 600;">${group.group_name}</h3>
                                        <span style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; background: #e0f2fe; color: #0277bd;">Group</span>
                                    </div>
                                    <div style="color: #4b5563; font-size: 14px; line-height: 1.4; margin-bottom: 8px;">
                                        ${group.group_description || '<em style="color: #9ca3af;">No description</em>'}
                                    </div>
                                    <div style="color: #6b7280; font-size: 12px; margin-bottom: 12px;">
                                        Created: ${new Date(group.created_at).toLocaleDateString()}
                                    </div>
                                    
                                    <!-- URL Section with copy functionality -->
                                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; padding: 12px; margin-top: 12px;">
                                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px;">
                                            <label style="font-size: 12px; font-weight: 600; color: #4b5563; text-transform: uppercase; letter-spacing: 0.5px;">
                                                HighLevel Custom Menu URL
                                            </label>
                                            <button onclick="copyUserGroupUrl('${btoa(fullUrl)}')" 
                                                    class="btn-small" 
                                                    style="padding: 4px 8px; font-size: 11px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                                Copy URL
                                            </button>
                                        </div>
                                        <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #374151; word-break: break-all; line-height: 1.4; background: white; padding: 8px; border-radius: 4px; border: 1px solid #e5e7eb;">
                                            ${fullUrl}
                                        </div>
                                        <div style="margin-top: 8px; font-size: 11px; color: #6b7280;">
                                            <strong>Parameters included:</strong><br>
                                            • <code style="background: #f3f4f6; padding: 2px 4px; border-radius: 3px;">{{contact.email}}</code> - HighLevel contact email<br>
                                            • <code style="background: #f3f4f6; padding: 2px 4px; border-radius: 3px;">{{location.id}}</code> - HighLevel location ID<br>
                                            • <code style="background: #f3f4f6; padding: 2px 4px; border-radius: 3px;">user_group</code> - This user group (${group.group_name})
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Right section: Actions -->
                            <div style="display: flex; gap: 8px; flex-shrink: 0;">
                                <button class="btn-small btn-edit" onclick="editUserGroupMain(${group.id})" style="padding: 8px 12px; font-size: 13px;">Edit</button>
                            </div>
                        </div>
                        
                        <!-- Separator line (except for last item) -->
                        ${index < allUserGroupsData.length - 1 ? '<div style="position: absolute; bottom: -6px; left: 20px; right: 20px; height: 1px; background: linear-gradient(to right, rgba(0,0,0,0.1), transparent);"></div>' : ''}
                    </div>
                `;
            }).join('');
            
            // Refresh icons for dynamically created content
            setTimeout(() => lucide.createIcons(), 100);
        }
        
        // Copy user group URL to clipboard
        function copyUserGroupUrl(encodedUrl) {
            const url = atob(encodedUrl);
            navigator.clipboard.writeText(url).then(() => {
                // Show success feedback
                showSuccess('User group URL copied to clipboard!');
                event.target.textContent = 'Copied!';
                event.target.style.background = '#10b981';
                setTimeout(() => {
                    event.target.textContent = 'Copy URL';
                    event.target.style.background = '#3b82f6';
                }, 2000);
            }).catch(err => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = url;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showSuccess('User group URL copied to clipboard!');
                    event.target.textContent = 'Copied!';
                    event.target.style.background = '#10b981';
                    setTimeout(() => {
                        event.target.textContent = 'Copy URL';
                        event.target.style.background = '#3b82f6';
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy URL:', err);
                    showError('Failed to copy URL. Please copy manually.');
                }
                document.body.removeChild(textArea);
            });
        }

        // Create new user group
        function createNewUserGroupMain() {
            // Hide main panel
            document.getElementById('userGroupsMainPanel').style.display = 'none';
            
            const container = document.getElementById('container');
            const editPanel = document.getElementById('editPanel');
            
            // Make edit panel a centered modal
            editPanel.style.position = 'fixed';
            editPanel.style.top = '50%';
            editPanel.style.left = '50%';
            editPanel.style.transform = 'translate(-50%, -50%)';
            editPanel.style.width = '600px';
            editPanel.style.maxWidth = '90vw';
            editPanel.style.maxHeight = '80vh';
            editPanel.style.overflowY = 'auto';
            editPanel.style.zIndex = '1000';
            editPanel.style.display = 'block';
            editPanel.style.visibility = 'visible';
            editPanel.style.opacity = '1';
            editPanel.style.background = 'white';
            editPanel.style.padding = '24px';
            editPanel.style.borderRadius = '12px';
            editPanel.style.boxShadow = '0 10px 25px rgba(0, 0, 0, 0.2)';
            editPanel.style.border = '1px solid #E5E7EB';
            
            // Add dark overlay behind modal
            const overlay = document.createElement('div');
            overlay.id = 'modalOverlay';
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            overlay.style.zIndex = '999';
            overlay.onclick = () => cancelUserGroupForm();
            document.body.appendChild(overlay);
            
            document.getElementById('editTitle').textContent = 'Create New User Group';
            
            // Override the close button to call our cancel function
            const closeBtn = editPanel.querySelector('.close-btn');
            if (closeBtn) {
                closeBtn.onclick = cancelUserGroupForm;
            }
            
            // Show user group form
            showUserGroupFormInEditPanel();
        }

        // Edit user group
        function editUserGroupMain(groupId) {
            const group = allUserGroupsData.find(g => g.id === groupId);
            if (!group) return;

            // Hide main panel
            document.getElementById('userGroupsMainPanel').style.display = 'none';
            
            const container = document.getElementById('container');
            const editPanel = document.getElementById('editPanel');
            
            // Make edit panel a centered modal (same styling as create)
            editPanel.style.position = 'fixed';
            editPanel.style.top = '50%';
            editPanel.style.left = '50%';
            editPanel.style.transform = 'translate(-50%, -50%)';
            editPanel.style.width = '600px';
            editPanel.style.maxWidth = '90vw';
            editPanel.style.maxHeight = '80vh';
            editPanel.style.overflowY = 'auto';
            editPanel.style.zIndex = '1000';
            editPanel.style.display = 'block';
            editPanel.style.visibility = 'visible';
            editPanel.style.opacity = '1';
            editPanel.style.background = 'white';
            editPanel.style.padding = '24px';
            editPanel.style.borderRadius = '12px';
            editPanel.style.boxShadow = '0 10px 25px rgba(0, 0, 0, 0.2)';
            editPanel.style.border = '1px solid #E5E7EB';
            
            // Add dark overlay behind modal
            const overlay = document.createElement('div');
            overlay.id = 'modalOverlay';
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            overlay.style.zIndex = '999';
            overlay.onclick = () => cancelUserGroupForm();
            document.body.appendChild(overlay);
            
            document.getElementById('editTitle').textContent = 'Edit User Group';
            
            // Override the close button to call our cancel function
            const closeBtn = editPanel.querySelector('.close-btn');
            if (closeBtn) {
                closeBtn.onclick = cancelUserGroupForm;
            }
            
            // Show user group form with data
            showUserGroupFormInEditPanel(group);
        }

        // Show user group form
        async function showUserGroupFormInEditPanel(group = null) {
            const editPanelContent = document.querySelector('#editPanel form');
            editPanelContent.innerHTML = `
                <input type="hidden" id="editUserGroupId" value="${group ? group.id : ''}">
                <div class="form-group">
                    <label for="editUserGroupName">Group Name</label>
                    <input type="text" id="editUserGroupName" value="${group ? group.group_name : ''}" required>
                    <small>Name for this user group (e.g., "New Users", "Premium Members")</small>
                </div>
                <div class="form-group">
                    <label for="editUserGroupDescription">Description</label>
                    <textarea id="editUserGroupDescription">${group ? (group.group_description || '') : ''}</textarea>
                    <small>Description of what this user group represents</small>
                </div>
                <div class="form-group">
                    <label for="editUserGroupColor">Card Color</label>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <input type="color" id="editUserGroupColor" value="${group ? (group.card_color || '#f1f5f9') : '#f1f5f9'}" style="width: 50px; height: 40px; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                        <div style="flex: 1;">
                            <input type="text" id="editUserGroupColorText" value="${group ? (group.card_color || '#f1f5f9') : '#f1f5f9'}" style="width: 100px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-family: monospace;" onchange="updateUserGroupColorPicker('editUserGroupColor', this.value)">
                            <small style="display: block; margin-top: 4px;">Choose a light background color for the user group card</small>
                        </div>
                        <div id="userGroupColorPreview" style="width: 60px; height: 40px; border: 1px solid #e5e7eb; border-radius: 6px; background: ${group ? (group.card_color || '#f1f5f9') : '#f1f5f9'};"></div>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
                        <button type="button" onclick="setUserGroupColor('#f1f5f9')" style="width: 24px; height: 24px; border: 1px solid #ccc; border-radius: 4px; background: #f1f5f9; cursor: pointer;" title="Light Blue-Gray"></button>
                        <button type="button" onclick="setUserGroupColor('#ecfdf5')" style="width: 24px; height: 24px; border: 1px solid #ccc; border-radius: 4px; background: #ecfdf5; cursor: pointer;" title="Light Green"></button>
                        <button type="button" onclick="setUserGroupColor('#fef7f0')" style="width: 24px; height: 24px; border: 1px solid #ccc; border-radius: 4px; background: #fef7f0; cursor: pointer;" title="Light Orange"></button>
                        <button type="button" onclick="setUserGroupColor('#faf5ff')" style="width: 24px; height: 24px; border: 1px solid #ccc; border-radius: 4px; background: #faf5ff; cursor: pointer;" title="Light Purple"></button>
                        <button type="button" onclick="setUserGroupColor('#f0f9ff')" style="width: 24px; height: 24px; border: 1px solid #ccc; border-radius: 4px; background: #f0f9ff; cursor: pointer;" title="Light Blue"></button>
                        <button type="button" onclick="setUserGroupColor('#fef2f2')" style="width: 24px; height: 24px; border: 1px solid #ccc; border-radius: 4px; background: #fef2f2; cursor: pointer;" title="Light Red"></button>
                        <button type="button" onclick="setUserGroupColor('#fffbeb')" style="width: 24px; height: 24px; border: 1px solid #ccc; border-radius: 4px; background: #fffbeb; cursor: pointer;" title="Light Yellow"></button>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save User Group</button>
                    <button type="button" class="btn btn-secondary" onclick="cancelUserGroupForm()">Cancel</button>
                    ${group && !['all users', 'default group'].includes(group.group_name.toLowerCase()) ? '<button type="button" class="btn btn-danger" onclick="deleteUserGroupMain()">Delete</button>' : ''}
                    ${group && ['all users', 'default group'].includes(group.group_name.toLowerCase()) ? '<button type="button" class="btn" style="background: #E5E7EB; color: #9CA3AF; cursor: not-allowed;" disabled>Protected Group</button>' : ''}
                </div>
            `;
            
            // Add form submission handler
            editPanelContent.onsubmit = saveUserGroupFromEditPanel;
        }

        // Save user group
        async function saveUserGroupFromEditPanel(e) {
            e.preventDefault();
            
            try {
                const groupId = document.getElementById('editUserGroupId').value;
                const formData = {
                    group_name: document.getElementById('editUserGroupName').value,
                    group_description: document.getElementById('editUserGroupDescription').value,
                    card_color: document.getElementById('editUserGroupColor').value,
                    updated_at: new Date().toISOString()
                };

                let data, error;
                if (groupId) {
                    const result = await supabaseClient.from('user_groups').update(formData).eq('id', groupId).select();
                    data = result.data; error = result.error;
                } else {
                    formData.created_at = new Date().toISOString();
                    const result = await supabaseClient.from('user_groups').insert([formData]).select();
                    data = result.data; error = result.error;
                }

                if (error) throw error;
                showSuccess(groupId ? 'User group updated successfully!' : 'User group created successfully!');
                await loadUserGroupsMain();
                setTimeout(() => {
                    document.getElementById('editPanel').style.display = 'none';
                    document.getElementById('userGroupsMainPanel').style.display = 'block';
                }, 1500);
            } catch (error) {
                console.error('Error saving user group:', error);
                showError('Failed to save user group: ' + error.message);
            }
        }

        // Cancel user group form
        function cancelUserGroupForm() {
            const editPanel = document.getElementById('editPanel');
            
            // Reset panel styles
            editPanel.style.position = '';
            editPanel.style.top = '';
            editPanel.style.left = '';
            editPanel.style.transform = '';
            editPanel.style.width = '';
            editPanel.style.maxWidth = '';
            editPanel.style.maxHeight = '';
            editPanel.style.overflowY = '';
            editPanel.style.zIndex = '';
            editPanel.style.background = '';
            editPanel.style.padding = '';
            editPanel.style.borderRadius = '';
            editPanel.style.boxShadow = '';
            editPanel.style.border = '';
            editPanel.style.display = 'none';
            
            // Remove overlay
            const overlay = document.getElementById('modalOverlay');
            if (overlay) {
                document.body.removeChild(overlay);
            }
            
            document.getElementById('userGroupsMainPanel').style.display = 'block';
        }

        // Delete user group
        async function deleteUserGroupMain() {
            const groupId = document.getElementById('editUserGroupId').value;
            if (!groupId) return;

            const group = allUserGroupsData.find(g => g.id === parseInt(groupId));
            
            // Check if group is being used by any users
            const { data: usersInGroup } = await supabaseClient
                .from('onboarding_users')
                .select('id')
                .eq('user_group_id', groupId)
                .limit(1);
            
            if (usersInGroup && usersInGroup.length > 0) {
                showError('Cannot delete group with assigned users. Please reassign users first.');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete the user group "${group.group_name}"?`)) {
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('user_groups')
                    .delete()
                    .eq('id', groupId);

                if (error) throw error;

                showSuccess('User group deleted successfully!');
                await loadUserGroupsMain();
                document.getElementById('editPanel').style.display = 'none';
                document.getElementById('userGroupsMainPanel').style.display = 'block';
            } catch (error) {
                console.error('Error deleting user group:', error);
                showError('Failed to delete user group: ' + error.message);
            }
        }

        // User group color helper functions
        function updateUserGroupColorPicker(colorPickerId, hexValue) {
            if (hexValue.match(/^#[0-9A-Fa-f]{6}$/)) {
                document.getElementById(colorPickerId).value = hexValue;
                document.getElementById('userGroupColorPreview').style.background = hexValue;
            }
        }

        function setUserGroupColor(color) {
            document.getElementById('editUserGroupColor').value = color;
            document.getElementById('editUserGroupColorText').value = color;
            document.getElementById('userGroupColorPreview').style.background = color;
        }

        // Color picker helper functions
        function updateColorPicker(colorPickerId, hexValue) {
            if (hexValue.match(/^#[0-9A-Fa-f]{6}$/)) {
                document.getElementById(colorPickerId).value = hexValue;
                document.getElementById('colorPreview').style.background = hexValue;
            }
        }

        function setGroupColor(color) {
            document.getElementById('editTaskGroupColor').value = color;
            document.getElementById('editTaskGroupColorText').value = color;
            document.getElementById('colorPreview').style.background = color;
            
            // Add visual feedback - highlight selected color button
            const colorButtons = document.querySelectorAll('[onclick^="setGroupColor"]');
            colorButtons.forEach(button => {
                // Remove existing selection styling
                button.style.border = '1px solid #ccc';
                button.style.boxShadow = 'none';
            });
            
            // Add selection styling to clicked button
            const selectedButton = document.querySelector(`[onclick="setGroupColor('${color}')"]`);
            if (selectedButton) {
                selectedButton.style.border = '2px solid #2563eb';
                selectedButton.style.boxShadow = '0 0 0 2px rgba(37, 99, 235, 0.2)';
            }
        }

        // Add color picker event listener for task groups
        document.addEventListener('change', function(e) {
            if (e.target.id === 'editTaskGroupColor') {
                document.getElementById('editTaskGroupColorText').value = e.target.value;
                document.getElementById('colorPreview').style.background = e.target.value;
                
                // Update visual feedback for color buttons
                const colorButtons = document.querySelectorAll('[onclick^="setGroupColor"]');
                colorButtons.forEach(button => {
                    // Remove existing selection styling
                    button.style.border = '1px solid #ccc';
                    button.style.boxShadow = 'none';
                });
                
                // Highlight matching preset color if selected
                const selectedButton = document.querySelector(`[onclick="setGroupColor('${e.target.value}')"]`);
                if (selectedButton) {
                    selectedButton.style.border = '2px solid #2563eb';
                    selectedButton.style.boxShadow = '0 0 0 2px rgba(37, 99, 235, 0.2)';
                }
            }
        });

        // Start the application
        document.addEventListener('DOMContentLoaded', () => {
            initAdminNavigation();
            init();
            // Initialize Lucide icons
            lucide.createIcons();
        });
    </script>
</body>
</html>