<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DFY CRM Admin - Modern UI</title>
    <link rel="stylesheet" href="admin-redesign.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Quick fixes for functionality */
        .content-section { display: none; }
        .content-section.active { display: block; }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: var(--primary-blue);
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="admin-wrapper">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="var(--primary-blue)">
                        <path d="M16 2L2 10v12l14 8 14-8V10L16 2z"/>
                    </svg>
                    <span class="sidebar-logo-text">DFY CRM</span>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-group">
                    <div class="nav-group-title">Main</div>
                    <a href="#dashboard" class="nav-item active" onclick="switchSection('dashboard')">
                        <svg class="nav-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                        <span class="nav-item-text">Dashboard</span>
                    </a>
                    <a href="#tasks" class="nav-item" onclick="switchSection('tasks')">
                        <svg class="nav-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                        </svg>
                        <span class="nav-item-text">Tasks</span>
                        <span class="nav-item-badge" id="taskCount">0</span>
                    </a>
                    <a href="#groups" class="nav-item" onclick="switchSection('groups')">
                        <svg class="nav-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                        </svg>
                        <span class="nav-item-text">Task Groups</span>
                    </a>
                </div>
                
                <div class="nav-group">
                    <div class="nav-group-title">Users</div>
                    <a href="#users" class="nav-item" onclick="switchSection('users')">
                        <svg class="nav-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                        <span class="nav-item-text">All Users</span>
                    </a>
                </div>
                
                <div class="nav-group">
                    <div class="nav-group-title">Settings</div>
                    <a href="#webhooks" class="nav-item" onclick="switchSection('webhooks')">
                        <svg class="nav-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="nav-item-text">Webhooks</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Compact Header -->
            <header class="header">
                <div class="header-left">
                    <div class="header-breadcrumb">
                        <span>Admin</span>
                        <span>/</span>
                        <span id="currentSection">Dashboard</span>
                    </div>
                </div>
                
                <div class="header-right">
                    <button class="theme-toggle" onclick="toggleTheme()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                    </button>
                    <div class="user-avatar">AD</div>
                </div>
            </header>

            <!-- Content Wrapper -->
            <div class="content-wrapper">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="content-section active">
                    <h2 style="margin-bottom: 24px; color: var(--text-primary);">Dashboard</h2>
                    
                    <!-- Stats Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 32px;">
                        <div class="card">
                            <div class="card-body">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="color: var(--text-tertiary); font-size: 14px;">Total Tasks</div>
                                        <div style="font-size: 32px; font-weight: 700; color: var(--text-primary);" id="totalTasksStat">0</div>
                                    </div>
                                    <svg width="48" height="48" fill="var(--primary-blue)" opacity="0.2" viewBox="0 0 24 24">
                                        <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-body">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="color: var(--text-tertiary); font-size: 14px;">Active Users</div>
                                        <div style="font-size: 32px; font-weight: 700; color: var(--text-primary);" id="activeUsersStat">0</div>
                                    </div>
                                    <svg width="48" height="48" fill="var(--success-green)" opacity="0.2" viewBox="0 0 24 24">
                                        <path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-body">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="color: var(--text-tertiary); font-size: 14px;">Task Groups</div>
                                        <div style="font-size: 32px; font-weight: 700; color: var(--text-primary);" id="taskGroupsStat">0</div>
                                    </div>
                                    <svg width="48" height="48" fill="var(--secondary-purple)" opacity="0.2" viewBox="0 0 24 24">
                                        <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-body">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="color: var(--text-tertiary); font-size: 14px;">Completion Rate</div>
                                        <div style="font-size: 32px; font-weight: 700; color: var(--text-primary);" id="completionRateStat">0%</div>
                                    </div>
                                    <svg width="48" height="48" fill="var(--warning-yellow)" opacity="0.2" viewBox="0 0 24 24">
                                        <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Activity -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Recent Activity</h3>
                        </div>
                        <div class="card-body" id="recentActivity">
                            <div style="text-align: center; color: var(--text-tertiary); padding: 40px;">
                                Loading activity...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tasks Section -->
                <div id="tasks-section" class="content-section">
                    <!-- Action Bar -->
                    <div class="action-bar">
                        <div class="action-group search">
                            <input type="text" class="search-input" id="taskSearch" placeholder="Search tasks..." oninput="searchTasks()">
                        </div>
                        
                        <div class="action-group">
                            <select class="filter-dropdown" id="taskFilter" onchange="filterTasks()">
                                <option value="all">All Tasks</option>
                                <option value="active">Active Tasks</option>
                                <option value="inactive">Inactive Tasks</option>
                            </select>
                        </div>
                        
                        <div class="action-group" style="margin-left: auto;">
                            <button class="btn btn-primary" onclick="openAddTaskModal()">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                Add Task
                            </button>
                        </div>
                    </div>

                    <!-- Task List -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Tasks</h3>
                            <button class="btn btn-ghost btn-icon" onclick="loadTasks()">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="card-body" id="tasksList">
                            <div style="text-align: center; padding: 40px;">
                                <div class="loading-spinner"></div>
                                <div style="margin-top: 16px; color: var(--text-tertiary);">Loading tasks...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Groups Section -->
                <div id="groups-section" class="content-section">
                    <div class="action-bar">
                        <div class="action-group" style="margin-left: auto;">
                            <button class="btn btn-primary" onclick="openAddGroupModal()">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                Create Group
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Task Groups</h3>
                        </div>
                        <div class="card-body" id="groupsList">
                            <div style="text-align: center; padding: 40px;">
                                <div class="loading-spinner"></div>
                                <div style="margin-top: 16px; color: var(--text-tertiary);">Loading groups...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Section -->
                <div id="users-section" class="content-section">
                    <div class="action-bar">
                        <div class="action-group search">
                            <input type="text" class="search-input" id="userSearch" placeholder="Search users..." oninput="searchUsers()">
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Users</h3>
                        </div>
                        <div class="card-body" id="usersList">
                            <div style="text-align: center; padding: 40px;">
                                <div class="loading-spinner"></div>
                                <div style="margin-top: 16px; color: var(--text-tertiary);">Loading users...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Webhooks Section -->
                <div id="webhooks-section" class="content-section">
                    <div class="action-bar">
                        <div class="action-group" style="margin-left: auto;">
                            <button class="btn btn-primary" onclick="openAddWebhookModal()">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                Add Webhook
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Webhooks</h3>
                        </div>
                        <div class="card-body" id="webhooksList">
                            <div style="text-align: center; padding: 40px;">
                                <div class="loading-spinner"></div>
                                <div style="margin-top: 16px; color: var(--text-tertiary);">Loading webhooks...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="admin-redesign.js"></script>
    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://vvtzalcisnpibnlunqgn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2dHphbGNpc25waWJubHVucWduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzEwOTE0MjAsImV4cCI6MjA0NjY2NzQyMH0.jCevTMi1dMPR1rDNXB9KwZ3q-sz8gILJFX0ZzT7Y_fI';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global data
        let tasks = [];
        let users = [];
        let groups = [];
        let webhooks = [];

        // Navigation
        function switchSection(section) {
            // Update nav active state
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');
            
            // Update breadcrumb
            const sectionNames = {
                'dashboard': 'Dashboard',
                'tasks': 'Tasks',
                'groups': 'Task Groups',
                'users': 'Users',
                'webhooks': 'Webhooks'
            };
            document.getElementById('currentSection').textContent = sectionNames[section];
            
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            
            // Show selected section
            document.getElementById(`${section}-section`).classList.add('active');
            
            // Load section data
            switch(section) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'tasks':
                    loadTasks();
                    break;
                case 'groups':
                    loadGroups();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'webhooks':
                    loadWebhooks();
                    break;
            }
        }

        // Theme toggle
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update icon
            const icon = newTheme === 'light' 
                ? '<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>'
                : '<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>';
            
            document.querySelector('.theme-toggle').innerHTML = icon;
        }

        // Load Dashboard
        async function loadDashboard() {
            try {
                // Load stats
                const { data: tasksData } = await supabaseClient.from('onboarding_tasks').select('*');
                const { data: usersData } = await supabaseClient.from('onboarding_users').select('*');
                const { data: groupsData } = await supabaseClient.from('task_groups').select('*');
                
                // Update stats
                document.getElementById('totalTasksStat').textContent = tasksData?.length || 0;
                document.getElementById('activeUsersStat').textContent = usersData?.length || 0;
                document.getElementById('taskGroupsStat').textContent = groupsData?.length || 0;
                
                // Calculate completion rate
                if (usersData && usersData.length > 0) {
                    const totalTasks = tasksData?.length || 0;
                    const completedSum = usersData.reduce((sum, user) => {
                        const checklist = user.checklist || [];
                        const completed = checklist.filter(t => t.completed).length;
                        return sum + completed;
                    }, 0);
                    const rate = totalTasks > 0 ? Math.round((completedSum / (usersData.length * totalTasks)) * 100) : 0;
                    document.getElementById('completionRateStat').textContent = rate + '%';
                }
                
                // Load recent activity
                const activityHtml = `
                    <div style="padding: 20px; text-align: center; color: var(--text-tertiary);">
                        <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto; opacity: 0.5;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p style="margin-top: 16px;">Activity tracking coming soon</p>
                    </div>
                `;
                document.getElementById('recentActivity').innerHTML = activityHtml;
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                AdminUI.toast.error('Failed to load dashboard data');
            }
        }

        // Load Tasks
        async function loadTasks() {
            try {
                const { data, error } = await supabaseClient
                    .from('onboarding_tasks')
                    .select('*')
                    .order('position');
                
                if (error) throw error;
                
                tasks = data || [];
                document.getElementById('taskCount').textContent = tasks.length;
                renderTasks();
                
            } catch (error) {
                console.error('Error loading tasks:', error);
                AdminUI.toast.error('Failed to load tasks');
            }
        }

        // Render Tasks
        function renderTasks() {
            const container = document.getElementById('tasksList');
            const searchTerm = document.getElementById('taskSearch')?.value.toLowerCase() || '';
            const filterValue = document.getElementById('taskFilter')?.value || 'all';
            
            let filteredTasks = tasks;
            
            // Apply search
            if (searchTerm) {
                filteredTasks = filteredTasks.filter(task => 
                    task.title?.toLowerCase().includes(searchTerm) ||
                    task.description?.toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply filter
            if (filterValue === 'active') {
                filteredTasks = filteredTasks.filter(task => task.is_active);
            } else if (filterValue === 'inactive') {
                filteredTasks = filteredTasks.filter(task => !task.is_active);
            }
            
            if (filteredTasks.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-tertiary);">
                        <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto; opacity: 0.5;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <p style="margin-top: 16px;">No tasks found</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredTasks.map(task => `
                <div class="task-item">
                    <div class="task-checkbox ${task.is_active ? '' : 'checked'}"></div>
                    <div class="task-info">
                        <div class="task-title">${task.title || 'Untitled Task'}</div>
                        <div class="task-meta">
                            <span class="status-dot ${task.is_active ? 'active' : 'inactive'}"></span>
                            <span>${task.is_active ? 'Active' : 'Inactive'}</span>
                            <span>•</span>
                            <span>Position: ${task.position}</span>
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="btn btn-ghost btn-icon" onclick="editTask('${task.id}')" data-tooltip="Edit">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                        <button class="btn btn-ghost btn-icon" onclick="deleteTask('${task.id}')" data-tooltip="Delete">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Load Groups
        async function loadGroups() {
            try {
                const { data, error } = await supabaseClient
                    .from('task_groups')
                    .select('*')
                    .order('display_order');
                
                if (error) throw error;
                
                groups = data || [];
                renderGroups();
                
            } catch (error) {
                console.error('Error loading groups:', error);
                AdminUI.toast.error('Failed to load groups');
            }
        }

        // Render Groups
        function renderGroups() {
            const container = document.getElementById('groupsList');
            
            if (groups.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-tertiary);">
                        <p>No task groups found</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = groups.map(group => `
                <div class="task-item">
                    <div class="task-info">
                        <div class="task-title">${group.group_name || 'Untitled Group'}</div>
                        <div class="task-meta">
                            <span class="status-dot ${group.is_active ? 'active' : 'inactive'}"></span>
                            <span>${group.is_active ? 'Active' : 'Inactive'}</span>
                            <span>•</span>
                            <span>Order: ${group.display_order}</span>
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="btn btn-ghost btn-icon" onclick="editGroup('${group.id}')" data-tooltip="Edit">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Load Users
        async function loadUsers() {
            try {
                const { data, error } = await supabaseClient
                    .from('onboarding_users')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                users = data || [];
                renderUsers();
                
            } catch (error) {
                console.error('Error loading users:', error);
                AdminUI.toast.error('Failed to load users');
            }
        }

        // Render Users
        function renderUsers() {
            const container = document.getElementById('usersList');
            const searchTerm = document.getElementById('userSearch')?.value.toLowerCase() || '';
            
            let filteredUsers = users;
            
            if (searchTerm) {
                filteredUsers = filteredUsers.filter(user => 
                    user.email?.toLowerCase().includes(searchTerm) ||
                    user.first_name?.toLowerCase().includes(searchTerm) ||
                    user.last_name?.toLowerCase().includes(searchTerm)
                );
            }
            
            if (filteredUsers.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-tertiary);">
                        <p>No users found</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredUsers.map(user => {
                const checklist = user.checklist || [];
                const completed = checklist.filter(t => t.completed).length;
                const total = checklist.length;
                const progress = total > 0 ? Math.round((completed / total) * 100) : 0;
                
                return `
                    <div class="task-item">
                        <div class="user-avatar" style="width: 40px; height: 40px; font-size: 14px;">
                            ${(user.first_name?.[0] || user.email?.[0] || '?').toUpperCase()}
                        </div>
                        <div class="task-info">
                            <div class="task-title">${user.email}</div>
                            <div class="task-meta">
                                <span>${user.first_name || ''} ${user.last_name || ''}</span>
                                <span>•</span>
                                <span>Progress: ${completed}/${total}</span>
                                <span>•</span>
                                <div class="progress-bar" style="width: 100px; display: inline-block;">
                                    <div class="progress-bar-fill" style="width: ${progress}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load Webhooks
        async function loadWebhooks() {
            try {
                const { data, error } = await supabaseClient
                    .from('webhook_settings')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                webhooks = data || [];
                renderWebhooks();
                
            } catch (error) {
                console.error('Error loading webhooks:', error);
                AdminUI.toast.error('Failed to load webhooks');
            }
        }

        // Render Webhooks
        function renderWebhooks() {
            const container = document.getElementById('webhooksList');
            
            if (webhooks.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-tertiary);">
                        <p>No webhooks configured</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = webhooks.map(webhook => `
                <div class="task-item">
                    <div class="task-info">
                        <div class="task-title">${webhook.webhook_name || 'Unnamed Webhook'}</div>
                        <div class="task-meta">
                            <span class="status-dot ${webhook.is_active ? 'active' : 'inactive'}"></span>
                            <span>${webhook.is_active ? 'Active' : 'Inactive'}</span>
                            <span>•</span>
                            <span>${webhook.webhook_url}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Modal functions
        function openAddTaskModal() {
            AdminUI.modal.open({
                title: 'Add New Task',
                content: `
                    <div class="form-group">
                        <label class="form-label required">Task Title</label>
                        <input type="text" class="form-input" id="newTaskTitle" placeholder="Enter task title">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-input" id="newTaskDesc" rows="3" placeholder="Enter task description"></textarea>
                    </div>
                `,
                onConfirm: async () => {
                    const title = document.getElementById('newTaskTitle').value;
                    const description = document.getElementById('newTaskDesc').value;
                    
                    if (!title) {
                        AdminUI.toast.error('Task title is required');
                        return;
                    }
                    
                    try {
                        const { error } = await supabaseClient
                            .from('onboarding_tasks')
                            .insert({
                                title,
                                description,
                                is_active: true,
                                position: tasks.length + 1
                            });
                        
                        if (error) throw error;
                        
                        AdminUI.toast.success('Task created successfully');
                        loadTasks();
                    } catch (error) {
                        AdminUI.toast.error('Failed to create task');
                    }
                }
            });
        }

        function editTask(taskId) {
            AdminUI.toast.info('Edit functionality coming soon');
        }

        function deleteTask(taskId) {
            AdminUI.modal.confirm('Are you sure you want to delete this task?', async () => {
                try {
                    const { error } = await supabaseClient
                        .from('onboarding_tasks')
                        .delete()
                        .eq('id', taskId);
                    
                    if (error) throw error;
                    
                    AdminUI.toast.success('Task deleted successfully');
                    loadTasks();
                } catch (error) {
                    AdminUI.toast.error('Failed to delete task');
                }
            });
        }

        // Search functions
        function searchTasks() {
            renderTasks();
        }

        function filterTasks() {
            renderTasks();
        }

        function searchUsers() {
            renderUsers();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            // Load dashboard on start
            loadDashboard();
        });
    </script>
</body>
</html>